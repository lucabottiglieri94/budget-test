<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Mensile - Gestione Familiare</title>
<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#f0f4f8,#e2e8f0);
    margin:0;
    padding:0;
    color:#333;
}
header {
    text-align:center;
    padding:20px 10px;
}
h1 {
    margin:0;
    font-size:2em;
}
p {
    margin:5px 0 20px;
    font-size:1em;
    color:#555;
}
select, button {
    font-size:0.9em;
    padding:5px 10px;
    border-radius:6px;
    border:1px solid #ccc;
}
.card {
    background:white;
    padding:12px 18px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    display:inline-flex;
    align-items:center;
    gap:10px;
    margin:5px;
}
#budget-table {
    width:90%;
    max-width:800px;
    margin:20px auto;
    border-collapse: collapse;
}
#budget-table th, #budget-table td {
    padding:10px;
    border:1px solid #ccc;
    text-align:center;
}
#budget-table th {
    background:#2196F3;
    color:white;
}
#save-moneta {
    position:fixed;
    bottom:20px;
    right:20px;
    font-size:1.5em;
    background:#ff9800;
    padding:12px;
    border-radius:50%;
    cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
  authDomain: "budget-luca.firebaseapp.com",
  databaseURL: "https://budget-luca-default-rtdb.firebaseio.com",
  projectId: "budget-luca",
  storageBucket: "budget-luca.firebasestorage.app",
  messagingSenderId: "67496424698",
  appId: "1:67496424698:web:b1822e04ef4efc07408543",
  measurementId: "G-7LEYRZE9QN"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const provider = new GoogleAuthProvider();
const db = getDatabase();

const loginBtn = document.getElementById('login-btn');
const loginStatus = document.getElementById('login-status');
const userInfo = document.getElementById('user-info');
const monthSelector = document.getElementById('month-selector');
const budgetTable = document.getElementById('budget-table');

let currentUser = null;
let currentMonth = monthSelector.value;

loginBtn.addEventListener('click', async ()=>{
    if(currentUser){
        setLoginStatus("Disconnessione...");
        await signOut(auth);
        setLoginStatus("Accedi con Google");
    } else {
        try{
            setLoginStatus("Attendere...");
            await signInWithPopup(auth, provider);
        }catch(e){
            console.error(e);
            setLoginStatus("Errore! Riprova");
        }
    }
});

function setLoginStatus(text){
    loginStatus.textContent = text;
}

onAuthStateChanged(auth, (user)=>{
    currentUser = user;
    if(user){
        loginBtn.textContent = 'Esci';
        userInfo.textContent = user.email;
        setLoginStatus("âœ… Connesso");
        attachRealtimeListener();
    } else {
        loginBtn.textContent = 'Accedi con Google';
        userInfo.textContent = '';
        setLoginStatus("In attesa...");
        budgetTable.innerHTML = '';
    }
});

monthSelector.addEventListener('change', ()=>{
    currentMonth = monthSelector.value;
    loadBudget();
});

function attachRealtimeListener(){
    if(!currentUser) return;
    const budgetRef = ref(db, 'budget/' + currentUser.uid + '/' + currentMonth);
    onValue(budgetRef, (snapshot)=>{
        const data = snapshot.val() || {};
        renderBudgetTable(data);
    });
}

function loadBudget(){
    if(!currentUser) return;
    const budgetRef = ref(db, 'budget/' + currentUser.uid + '/' + currentMonth);
    get(budgetRef).then(snapshot=>{
        const data = snapshot.val() || {};
        renderBudgetTable(data);
    });
}

function renderBudgetTable(data){
    const rows = Object.keys(data).map(key=>{
        return `<tr>
            <td>${key}</td>
            <td>${data[key].spesa || 0} â‚¬</td>
            <td>${data[key].budget || 0} â‚¬</td>
            <td>${(data[key].budget - data[key].spesa) || 0} â‚¬</td>
        </tr>`;
    }).join('');
    budgetTable.innerHTML = `<tr><th>Categoria</th><th>Spesa</th><th>Budget</th><th>Rimanente</th></tr>` + rows;
}

document.getElementById('save-moneta').addEventListener('click', ()=>{
    if(!currentUser) { alert("Devi loggarti!"); return;}
    const monetaRef = ref(db,'moneta/' + currentUser.uid);
    set(monetaRef,{ saved: true, timestamp: Date.now() });
    alert("Moneta AI salvata! ðŸŽ‰");
});
</script>
</head>
<body>
<header>
<h1>ðŸ’° Budget Mensile</h1>
<p>Gestione entrate e spese familiari</p>

<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:15px; margin-top:20px;">
    <div class="card">
      <label for="month-selector" style="font-weight:600; margin-right:8px;">ðŸ“… Mese:</label>
      <select id="month-selector">
        <option value="2026-01">Gennaio 2026</option>
        <option value="2026-02">Febbraio 2026</option>
        <option value="2026-03">Marzo 2026</option>
        <option value="2026-04">Aprile 2026</option>
        <option value="2026-05">Maggio 2026</option>
        <option value="2026-06">Giugno 2026</option>
        <option value="2026-07">Luglio 2026</option>
        <option value="2026-08">Agosto 2026</option>
        <option value="2026-09">Settembre 2026</option>
        <option value="2026-10">Ottobre 2026</option>
        <option value="2026-11">Novembre 2026</option>
        <option value="2026-12">Dicembre 2026</option>
      </select>
    </div>

    <div class="card" id="login-card">
      <button id="login-btn">Accedi con Google</button>
      <span id="login-status">In attesa...</span>
      <span id="user-info"></span>
    </div>
</div>
</header>

<table id="budget-table"></table>

<div id="save-moneta" title="Salva la moneta AI">ðŸª™</div>
</body>
</html>
