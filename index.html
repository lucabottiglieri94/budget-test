<!DOCTYPE html>
<html lang="it">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <title>Budget Mensile - Web App</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#070B14;
      --bg1:#0B1220;
      --bg2:#101B32;

      --card:#0F172A;
      --card2:#111C33;
      --text:#E5E7EB;
      --muted:#9CA3AF;
      --line: rgba(255,255,255,.10);

      --accent:#7C3AED;
      --accent2:#22C55E;
      --danger:#EF4444;
      --warn:#F59E0B;
      --info:#38BDF8;

      --radius:18px;
      --shadow: 0 22px 70px rgba(0,0,0,.45);
      --shadow2: 0 14px 40px rgba(0,0,0,.30);

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing:border-box; margin:0; padding:0 }
    html, body{ height:100% }
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;

      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.25), transparent 55%),
                  radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      overflow-x: hidden;
    }

    /* ===== LOGIN SCREEN ===== */
    #login-screen{
      position: fixed;
      inset: 0;
      z-index: 999999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(18px + var(--safe-top)) calc(18px + var(--safe-left))
               calc(18px + var(--safe-bottom)) calc(18px + var(--safe-right));
      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.30), transparent 55%),
                  radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.22), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      pointer-events: auto;
    }
    #login-card{
      width: min(560px, 94vw);
      border-radius: 22px;
      background: rgba(15,23,42,.68);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 22px 18px;
      text-align:center;
      pointer-events: auto;
      position: relative;
      z-index: 9999999;
    }
    #login-card h1{
      font-size: clamp(26px, 5vw, 38px);
      font-weight: 950;
      letter-spacing: .2px;
      margin-bottom: 8px;
    }
    #login-card p{
      color: rgba(229,231,235,.92);
      font-weight: 700;
      line-height: 1.35;
      margin-bottom: 16px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 800;
      color: rgba(229,231,235,.95);
      margin-bottom: 14px;
      font-size: 12px;
    }
    #login-screen-btn{
      width:100%;
      padding: 14px 16px;
      border: none;
      border-radius: 14px;
      font-weight: 950;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(34,197,94,1));
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
      transition: transform .08s ease;
      position: relative;
      z-index: 99999999;
      pointer-events: auto;
    }
    #login-screen-btn:active{ transform: scale(.99) }
    #login-screen small{
      display:block;
      margin-top:10px;
      font-size:12px;
      color: rgba(229,231,235,.85);
      font-weight: 700;
    }

    /* ===== APP LAYOUT ===== */
    #app{ display:none; min-height:100vh; }

    .shell{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      padding: calc(16px + var(--safe-top)) 16px calc(90px + var(--safe-bottom)) 16px;
    }

    /* Sidebar (desktop) */
    .sidebar{
      position: sticky;
      top: calc(16px + var(--safe-top));
      align-self: start;
      border-radius: var(--radius);
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 16px;
      backdrop-filter: blur(10px);
      height: fit-content;
    }
    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 14px;
    }
    .brand h1{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .brand .badge{
      font-size: 11px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
    }

    .menu{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 8px;
    }
    .navbtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:none;
      cursor:pointer;
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 950;
      color: rgba(229,231,235,.92);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      transition: transform .08s ease, background .12s ease;
    }
    .navbtn:hover{ background: rgba(255,255,255,.09) }
    .navbtn:active{ transform: scale(.99) }
    .navbtn .hint{
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,.75);
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .topbar{
      border-radius: var(--radius);
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .topbar-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }
    .topbar-title{
      font-weight: 950;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .topbar-sub{
      color: rgba(229,231,235,.78);
      font-weight: 700;
      font-size: 12px;
      line-height: 1.25;
    }

    .topbar-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1;
    }

    .select{
      flex: 1;
      min-width: 220px;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
      font-size: 15px;
      font-weight: 900;
      outline:none;
      appearance: none;
    }

    .btn{
      border:none;
      cursor:pointer;
      padding: 11px 12px;
      border-radius: 14px;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .08s ease;
    }
    .btn:active{ transform: scale(.99) }
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(56,189,248,1));
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(245,158,11,1));
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(229,231,235,.92);
    }

    #user-info{
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,.82);
      max-width: 52vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    #sync-status{
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,.85);
    }
    #sync-label{ font-weight: 950; }

    /* Grid cards */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .card{
      border-radius: var(--radius);
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      font-size: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .muted{
      color: rgba(229,231,235,.70);
      font-weight: 800;
      font-size: 12px;
    }

    .entry-items{ display:flex; flex-direction:column; gap:10px; margin-bottom: 12px; }
    .entry-item{
      display:flex;
      align-items:center;
      gap:8px;
      border-radius: 16px;
      padding: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }

    .item-label-input, .item-amount-input{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
      padding: 10px;
      font-size: 16px; /* evita zoom iPhone */
      font-weight: 900;
      outline:none;
    }
    .item-label-input{ flex:1; min-width:0; }
    .item-amount-input{ width: 118px; text-align:right; }

    .entry-item input::placeholder{ color: rgba(229,231,235,.55); }

    .btn-remove{
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      color: #061019;
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(245,158,11,1));
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }

    .btn-add{
      width:100%;
      border:none;
      cursor:pointer;
      border-radius: 16px;
      padding: 12px;
      font-weight: 950;
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
    }
    .btn-add.income{ background: linear-gradient(135deg, rgba(34,197,94,1), rgba(56,189,248,1)); }
    .btn-add.cost{ background: linear-gradient(135deg, rgba(239,68,68,1), rgba(124,58,237,1)); }

    .total-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 950;
    }
    .total-row span:last-child{ font-size: 16px; }

    /* Summary row */
    .summary{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
    }
    .sum{
      border-radius: var(--radius);
      padding: 14px;
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .sum .label{
      font-size: 12px;
      font-weight: 950;
      color: rgba(229,231,235,.75);
      letter-spacing: .8px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .sum .value{
      font-size: 20px;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .pos{ color: rgba(34,197,94,1); }
    .neg{ color: rgba(239,68,68,1); }

    /* Pie card */
    .pie-wrap{ position:relative; height: 260px; }

    /* Goal */
    .goal-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 10px;
      font-weight: 950;
    }
    .goal-line .muted{ font-weight: 900; }
    .bar{
      height: 38px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      position:relative;
      margin-bottom: 10px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,1), rgba(56,189,248,1));
      border-radius: 999px;
      transition: width .18s linear;
    }
    .bar span{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
      color:#061019;
      text-shadow: 0 2px 12px rgba(0,0,0,.35);
    }
    .goal-foot{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      font-weight: 900;
      color: rgba(229,231,235,.78);
      font-size: 12px;
    }

    /* Food */
    .week-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom: 10px;
    }
    .week-grid label{
      display:block;
      font-size: 12px;
      color: rgba(229,231,235,.70);
      font-weight: 900;
      margin-bottom: 4px;
    }

    /* Bottom nav (mobile) */
    .bottom-nav{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      padding: 10px calc(12px + var(--safe-left)) calc(10px + var(--safe-bottom)) calc(12px + var(--safe-right));
      background: rgba(7,11,20,.70);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      display:none;
      z-index: 5000;
    }
    .bottom-nav .row{
      display:flex;
      gap:10px;
    }
    .bottom-nav button{
      flex:1;
      border:none;
      cursor:pointer;
      border-radius: 16px;
      padding: 12px;
      font-weight: 950;
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
    }
    .bottom-nav .b1{ background: linear-gradient(135deg, rgba(245,158,11,1), rgba(239,68,68,1)); }
    .bottom-nav .b2{ background: linear-gradient(135deg, rgba(34,197,94,1), rgba(56,189,248,1)); }

/* ================= AI ORB ‚Äì FINAL SIZE ================= */

#ai-chat-widget{
  position: fixed;
  bottom: 22px;
  right: 22px;
  width: 90px;
  height: 90px;
  z-index: 9999;
}

#ai-chat-button{
  width: 90px;
  height: 90px;
  padding: 0;
  border: none;
  background: none;
  cursor: pointer;
}

.ai-orb-img{
  width: 90px;
  height: 90px;
  border-radius: 50%;
  filter: none;            /* niente cerchio grigio */
  animation: aiFloat 4s ease-in-out infinite;
}

@keyframes aiFloat {
  0%   { transform: translateY(0); }
  50%  { transform: translateY(-10px); }
  100% { transform: translateY(0); }
}


/* ================= AI CHAT ‚Äì PREMIUM UI ================= */

/* Box */
#ai-chat-box{
  position:absolute;
  right:0;
  bottom: 96px; /* un filo pi√π su, pi√π comodo col widget grande */
  width: min(420px, calc(100vw - 24px));
  max-height: min(620px, 74vh);
  border-radius: 22px;
  overflow:hidden;

  background: linear-gradient(180deg, rgba(15,23,42,.94), rgba(10,16,30,.92));
  border: 1px solid rgba(255,255,255,.16);
  box-shadow: 0 28px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(12px);

  display:flex;
  flex-direction:column;
}

/* Header pi√π pulita */
.ai-chat-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 12px 12px;

  background: rgba(255,255,255,.06);
  border-bottom: 1px solid rgba(255,255,255,.10);
}

.ai-chat-title{
  font-weight: 950;
  font-size: 13px;
  letter-spacing: .3px;
  color: rgba(229,231,235,.95);
}

.ai-chat-actions button{
  border:none;
  cursor:pointer;
  border-radius: 14px;
  padding: 8px 10px;
  font-weight: 950;

  color: rgba(229,231,235,.92);
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.12);
  transition: transform .08s ease, background .12s ease;
}
.ai-chat-actions button:hover{ background: rgba(255,255,255,.12) }
.ai-chat-actions button:active{ transform: scale(.99) }

/* Area messaggi */
#ai-chat-messages{
  padding: 14px;
  overflow-y:auto;
  flex:1;

  background:
    radial-gradient(900px 500px at 20% 0%, rgba(124,58,237,.12), transparent 60%),
    radial-gradient(700px 450px at 80% 20%, rgba(56,189,248,.10), transparent 55%),
    rgba(255,255,255,.03);

  font-size: 14px;
  line-height: 1.55;

  /* font pi√π ‚Äúquality‚Äù */
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* Scrollbar (Chrome/Edge) */
#ai-chat-messages::-webkit-scrollbar{ width: 10px; }
#ai-chat-messages::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.14);
  border: 2px solid rgba(0,0,0,0);
  background-clip: padding-box;
  border-radius: 999px;
}
#ai-chat-messages::-webkit-scrollbar-thumb:hover{
  background: rgba(255,255,255,.20);
  border: 2px solid rgba(0,0,0,0);
  background-clip: padding-box;
}

/* Messaggi */
.ai-msg{
  display:flex;
  margin-bottom: 10px;
}

.ai-msg-user{ justify-content:flex-end; }
.ai-msg-ai{ justify-content:flex-start; }

/* BOLLE PREMIUM */
.ai-msg-bubble{
  max-width: 86%;
  padding: 12px 12px;
  border-radius: 18px;
  white-space: pre-wrap;
  word-break: break-word;

  font-weight: 800;
  letter-spacing: .1px;

  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 10px 24px rgba(0,0,0,.25);
}

/* User bubble: pi√π ‚Äúglass + gradiente‚Äù */
.ai-msg-user .ai-msg-bubble{
  background: linear-gradient(135deg, rgba(124,58,237,.98), rgba(56,189,248,.96));
  color: #061019;
  border-color: rgba(255,255,255,.10);
  border-bottom-right-radius: 8px;
}

/* AI bubble: pi√π leggibile */
.ai-msg-ai .ai-msg-bubble{
  background: rgba(255,255,255,.07);
  color: rgba(229,231,235,.96);
  border-bottom-left-radius: 8px;
}

/* Barra input: pi√π contrasto + ‚Äúpill‚Äù */
#ai-chat-form{
  display:flex;
  gap:10px;
  padding: 10px;
  background: rgba(7,11,20,.60);
  border-top: 1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
}

/* Input super leggibile */
#ai-chat-input{
  flex:1;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(229,231,235,.96);

  padding: 12px 12px;
  border-radius: 16px;

  font-size: 15px; /* no zoom iPhone */
  font-weight: 850;
  outline:none;
}

#ai-chat-input::placeholder{
  color: rgba(229,231,235,.55);
  font-weight: 800;
}

/* Bottone invio pi√π ‚Äúpremium‚Äù */
#ai-chat-form button{
  border:none;
  cursor:pointer;

  padding: 0 16px;
  border-radius: 16px;

  font-weight: 950;
  letter-spacing: .2px;
  color:#061019;

  background: linear-gradient(135deg, rgba(34,197,94,1), rgba(56,189,248,1));
  box-shadow: 0 14px 34px rgba(0,0,0,.35);

  transition: transform .08s ease, filter .12s ease;
}
#ai-chat-form button:hover{ filter: brightness(1.04); }
#ai-chat-form button:active{ transform: scale(.99); }

/* Minimized */
#ai-chat-box.minimized #ai-chat-messages,
#ai-chat-box.minimized #ai-chat-form{ display:none; }


    /* keyboard helper */
    body.kbd-open #ai-chat-widget{ bottom: calc(300px + var(--safe-bottom)); }

    /* Responsive */
    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .bottom-nav{ display:block; }
      #ai-chat-widget{ bottom: calc(78px + var(--safe-bottom)); }
      .summary{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
      .select{ min-width: 0; width: 100%; }
      .topbar-right{ justify-content:flex-start; }
      #user-info{ max-width: 90vw; }
    }
    /* === AI ORB BUTTON === */
#ai-chat-button {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
}

.ai-orb-img {
  width: 100px;
  height: 100px;
  border-radius: 30%;
  filter: none; /* niente grigio */
  animation: aiFloat 4s ease-in-out infinite;
  transition: transform .25s ease;
}

.ai-orb-img:hover {
  transform: scale(1.05);
}


@keyframes aiFloat {
  0%   { transform: translateY(0); }
  50%  { transform: translateY(-10px); }
  100% { transform: translateY(0); }
}
    /* ================= CHAT APPLE STYLE ================= */

/* UTENTE ‚Äì bubble dark, pulita, neutra */
.ai-msg-user .ai-msg-bubble{
  background: rgba(255,255,255,.14);
  color: #F9FAFB;

  border: 1px solid rgba(255,255,255,.20);
  border-bottom-right-radius: 8px;

  font-weight: 800;
  letter-spacing: .1px;

  box-shadow:
    0 8px 22px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.12);
}

/* AI ‚Äì bubble leggermente pi√π soft */
.ai-msg-ai .ai-msg-bubble{
  background: rgba(255,255,255,.07);
  color: #E5E7EB;

  border: 1px solid rgba(255,255,255,.12);
  border-bottom-left-radius: 8px;

  font-weight: 800;
  letter-spacing: .1px;

  box-shadow: 0 6px 18px rgba(0,0,0,.28);
}

/* FIX: quando minimized sparisce anche input */
#ai-chat-box.minimized #ai-chat-form{
  display: none !important;
}
#ai-chat-box.hidden{
  display: none !important;
}


  </style>
</head>

<body>

  <!-- LOGIN SCREEN -->
  <div id="login-screen">
    <div id="login-card">
      <div class="pill">üîí Dati privati ‚Ä¢ Per-account ‚Ä¢ Firebase</div>
      <h1>üí∞ Budget Mensile</h1>
      <p>Accedi con Google per vedere e salvare <b>solo i tuoi dati</b>.</p>
      <button id="login-screen-btn" type="button">Accedi con Google</button>
      <small>Se non clicca: controlla popup bloccati o prova un altro browser.</small>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <div class="shell">

      <!-- Sidebar desktop -->
      <aside class="sidebar">
        <div class="brand">
          <h1>Budget Dashboard</h1>
          <div class="badge">Web App</div>
        </div>

        <div id="sync-status">Stato: <span id="sync-label">In attesa‚Ä¶</span></div>
        <div style="height:10px"></div>
        <div id="user-info"></div>

        <div class="menu" style="margin-top:14px;">
          <button class="navbtn" type="button" onclick="location.href='risparmi.html'">
            <span>üìà Grafico Risparmi</span><span class="hint">Apri</span>
          </button>
          <button class="navbtn" type="button" onclick="location.href='comparatori.html'">
            <span>üìä Comparatori</span><span class="hint">Apri</span>
          </button>
          <button id="login-btn" class="navbtn" type="button">
            <span>üîë Accedi Google</span><span class="hint">Login</span>
          </button>
          <button id="logout-btn" class="navbtn" type="button" style="display:none;">
            <span>üö™ Esci</span><span class="hint">Logout</span>
          </button>
        </div>
      </aside>

      <!-- Main -->
      <main class="main">
        <div class="topbar">
          <div class="topbar-left">
            <div class="topbar-title">üí∞ Budget Mensile</div>
            <div class="topbar-sub">Gestione entrate/spese ‚Ä¢ sincronizzato ‚Ä¢ mobile-ready</div>
          </div>
          <div class="topbar-right">
            <select id="month-selector" class="select"></select>
            <button id="top-login" class="btn ghost" type="button">Accedi</button>
            <button id="top-logout" class="btn ghost" type="button" style="display:none;">Esci</button>
          </div>
        </div>

        <div class="summary">
          <div class="sum">
            <div class="label">Entrate</div>
            <div class="value" id="summary-entrate">‚Ç¨ 0,00</div>
          </div>
          <div class="sum">
            <div class="label">Spese</div>
            <div class="value" id="summary-spese">‚Ç¨ 0,00</div>
          </div>
          <div class="sum">
            <div class="label">Risparmio</div>
            <div class="value pos" id="summary-balance">‚Ç¨ 0,00</div>
          </div>
        </div>

        <div class="grid">
          <!-- Entrate -->
          <section class="card">
            <h2>üì• Entrate <span class="muted">totale: <span id="total-entrate">‚Ç¨ 0,00</span></span></h2>
            <div class="entry-items" id="entrate-items"></div>
            <button class="btn-add income" type="button" onclick="addEntryItem('entrate')">+ Aggiungi Entrata</button>
          </section>

          <!-- Spese -->
          <section class="card">
            <h2>üì§ Spese <span class="muted">totale: <span id="total-spese">‚Ç¨ 0,00</span></span></h2>
            <div class="entry-items" id="spese-items"></div>
            <button class="btn-add cost" type="button" onclick="addEntryItem('spese')">+ Aggiungi Spesa</button>
          </section>
        </div>

        <div class="grid">
          <!-- Pie -->
          <section class="card">
            <h2>ü•ß Ripartizione Entrate/Spese <span class="muted">auto</span></h2>
            <div class="pie-wrap">
              <canvas id="budgetPie"></canvas>
            </div>
            <div class="muted" style="margin-top:10px;">
              Si aggiorna automaticamente quando modifichi le voci.
            </div>
          </section>

          <!-- Goal -->
          <section class="card">
            <h2>üéØ Obiettivo Risparmio <span class="muted">coach mode</span></h2>
            <div class="goal-line">
              <span class="muted">Obiettivo mensile</span>
              <span style="font-weight:950;">‚Ç¨ <span id="goal-amount">250,00</span></span>
            </div>
            <div class="bar">
              <div id="savings-progress-bar"></div>
              <span id="progress-percentage">0%</span>
            </div>
            <div class="goal-foot">
              <span>Risparmiato: <b id="saved-amount">‚Ç¨0,00</b></span>
              <span>Mancano: <b id="remaining-amount">‚Ç¨250,00</b></span>
            </div>
          </section>
        </div>

        <!-- Food -->
        <section class="card">
          <h2>üõí Spese Alimentari <span class="muted">‚Ç¨500/mese ‚Ä¢ ‚Ç¨125/settimana</span></h2>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 1</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
              </div>
              <div class="total-row">
                <span>Totale</span>
                <span id="total-week1">‚Ç¨ 0,00</span>
              </div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 2</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
              </div>
              <div class="total-row">
                <span>Totale</span>
                <span id="total-week2">‚Ç¨ 0,00</span>
              </div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 3</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
              </div>
              <div class="total-row">
                <span>Totale</span>
                <span id="total-week3">‚Ç¨ 0,00</span>
              </div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 4</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0" oninput="updateFoodTotals()"></div>
              </div>
              <div class="total-row">
                <span>Totale</span>
                <span id="total-week4">‚Ç¨ 0,00</span>
              </div>
            </div>
          </div>

          <div class="summary" style="margin-top:14px;">
            <div class="sum">
              <div class="label">Budget</div>
              <div class="value">‚Ç¨ 500</div>
            </div>
            <div class="sum">
              <div class="label">Speso</div>
              <div class="value" id="total-food-spent">‚Ç¨ 0,00</div>
            </div>
            <div class="sum">
              <div class="label">Rimasto</div>
              <div class="value pos" id="total-food-remaining">‚Ç¨ 500,00</div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Bottom nav mobile -->
    <div class="bottom-nav">
      <div class="row">
        <button class="b1" type="button" onclick="location.href='risparmi.html'">üìà Risparmi</button>
        <button class="b2" type="button" onclick="location.href='comparatori.html'">üìä Comparatori</button>
      </div>
    </div>

  <!-- AI CHAT -->
<div id="ai-chat-widget">
  <button id="ai-chat-button" aria-label="Apri chat AI" type="button">
    <img
      src="https://image2url.com/r2/default/images/1770554545375-45357bf1-9e2f-4a1e-9305-4afcce9a82e5.png"
      alt="AI Assistant"
      class="ai-orb-img"
      draggable="false"
    >

      </button>

      <div id="ai-chat-box" class="hidden">
        <div class="ai-chat-header">
          <div class="ai-chat-title">Assistente AI (coach)</div>
          <div class="ai-chat-actions">
            <button id="ai-chat-minimize" type="button">‚àí</button>
            <button id="ai-chat-close" type="button">√ó</button>
          </div>
        </div>

        <div id="ai-chat-messages"></div>

        <form id="ai-chat-form">
          <input id="ai-chat-input" type="text" placeholder="Chiedimi sul tuo budget‚Ä¶" autocomplete="off" />
          <button type="submit">Invia</button>
        </form>
      </div>
    </div>
  </div><!-- /app -->

  <!-- Firebase + Firestore + Auth (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider,
      signInWithPopup, signOut, setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
      authDomain: "budget-luca.firebaseapp.com",
      projectId: "budget-luca",
      storageBucket: "budget-luca.firebasestorage.app",
      messagingSenderId: "67496424698",
      appId: "1:67496424698:web:b1822e04ef4efc07408543",
      measurementId: "G-7LEYRZE9QN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // session-only
    await setPersistence(auth, browserSessionPersistence);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // expose per script non-module
    window._db = db;
    window._doc = doc;
    window._setDoc = setDoc;
    window._onSnapshot = onSnapshot;

    window._auth = auth;
    window._provider = provider;
    window._signInWithPopup = signInWithPopup;
    window._signOut = signOut;
    window._onAuthStateChanged = onAuthStateChanged;

    window._firebaseReady = true;
    console.log("‚úÖ Firebase pronto");
  </script>

  <script>
    // ===== keyboard helper =====
    document.addEventListener("focusin", (e) => {
      const t = e.target;
      if (t && (t.tagName === "INPUT" || t.tagName === "TEXTAREA")) document.body.classList.add("kbd-open");
    });
    document.addEventListener("focusout", () => {
      setTimeout(() => document.body.classList.remove("kbd-open"), 120);
    });

    // ===== Month options =====
    function pad2(n){ return String(n).padStart(2,"0"); }
    function monthLabel(y,m){
      const mesi = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
      return `${mesi[m-1]} ${y}`;
    }
    function buildMonthOptions(selectEl){
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const count = 12;
      const opts = [];
      for(let i=0;i<count;i++){
        const d = new Date(start.getFullYear(), start.getMonth()+i, 1);
        const y = d.getFullYear();
        const m = d.getMonth()+1;
        const val = `${y}-${pad2(m)}`;
        opts.push({ val, text: monthLabel(y,m) });
      }
      selectEl.innerHTML = opts.map(o=>`<option value="${o.val}">${o.text}</option>`).join("");
    }

    // ===== State =====
    let currentMonth = localStorage.getItem("budgetMonth") || "";
    let isSaving = false;
    let unsubscribe = null;
    let currentUser = null;
    let syncLabel = null;

    const loginScreen = document.getElementById("login-screen");
    const loginScreenBtn = document.getElementById("login-screen-btn");
    const appEl = document.getElementById("app");

    const monthSelector = document.getElementById("month-selector");

    const loginBtnSidebar = document.getElementById("login-btn");
    const logoutBtnSidebar = document.getElementById("logout-btn");

    const loginBtnTop = document.getElementById("top-login");
    const logoutBtnTop = document.getElementById("top-logout");

    const userInfo = document.getElementById("user-info");

    buildMonthOptions(monthSelector);
    if (!currentMonth){
      currentMonth = monthSelector.value;
      localStorage.setItem("budgetMonth", currentMonth);
    } else {
      monthSelector.value = currentMonth;
      if (monthSelector.value !== currentMonth){
        const opt = document.createElement("option");
        opt.value = currentMonth;
        opt.textContent = currentMonth;
        monthSelector.prepend(opt);
        monthSelector.value = currentMonth;
      }
    }

    function setSyncStatus(text, color="rgba(229,231,235,.85)"){
      if (!syncLabel) syncLabel = document.getElementById("sync-label");
      if (syncLabel){
        syncLabel.textContent = text;
        syncLabel.style.color = color;
      }
    }

    function showLoginOnly(){ loginScreen.style.display = "flex"; appEl.style.display = "none"; }
    function showApp(){ loginScreen.style.display = "none"; appEl.style.display = "block"; }

    async function doLogin(){
      if (!window._firebaseReady || !window._auth || !window._provider || !window._signInWithPopup){
        alert("Sto caricando Firebase‚Ä¶ riprova tra 1 secondo.");
        return;
      }
      try{
        await window._signInWithPopup(window._auth, window._provider);
      }catch(e){
        console.error("Login error:", e);
        alert("Login Google non riuscito.\n‚Ä¢ controlla popup bloccati\n‚Ä¢ controlla console (F12)");
      }
    }

    async function doLogout(){
      try{
        if (unsubscribe){ unsubscribe(); unsubscribe = null; }
        await window._signOut(window._auth);

        currentUser = null;
        userInfo.textContent = "";
        logoutBtnSidebar.style.display = "none";
        logoutBtnTop.style.display = "none";
        loginBtnTop.style.display = "inline-flex";
        setSyncStatus("Login richiesto", "rgba(245,158,11,1)");

        resetUIEmpty();
        showLoginOnly();
      }catch(e){
        console.error("Logout error:", e);
        alert("Logout non riuscito.");
      }
    }

    // bind login buttons
    loginScreenBtn.addEventListener("click", doLogin);
    loginBtnSidebar.addEventListener("click", doLogin);
    loginBtnTop.addEventListener("click", doLogin);

    logoutBtnSidebar.addEventListener("click", doLogout);
    logoutBtnTop.addEventListener("click", doLogout);

    monthSelector.addEventListener("change", ()=>{
      currentMonth = monthSelector.value;
      localStorage.setItem("budgetMonth", currentMonth);
      attachRealtimeListener();
    });

    // ===== Helpers =====
    function parseAmount(x){ return parseFloat((x ?? "").toString().replace(",", ".")) || 0; }
    function formatCurrency(v){ return "‚Ç¨ " + (Number(v||0)).toFixed(2).replace(".", ","); }
    function escapeAttr(s){ return (s ?? "").toString().replaceAll('"','&quot;'); }

    // ===== Pie Chart =====
    let pieChart = null;
    function updatePieChart(){
      const canvas = document.getElementById("budgetPie");
      if (!canvas || typeof Chart === "undefined") return;

      let sumEntrate = 0;
      document.querySelectorAll('#entrate-items .item-amount-input').forEach(i => sumEntrate += parseAmount(i.value));

      let sumSpese = 0;
      document.querySelectorAll('#spese-items .item-amount-input').forEach(i => sumSpese += parseAmount(i.value));

      const has = (sumEntrate > 0 || sumSpese > 0);
      const labels = has ? ["Entrate", "Spese"] : ["Nessun dato"];
      const values = has ? [sumEntrate, sumSpese] : [1];

      // palette coerente col tema
      const colors = has ? ["rgba(34,197,94,0.85)", "rgba(239,68,68,0.85)"] : ["rgba(156,163,175,0.35)"];

      if (!pieChart){
        pieChart = new Chart(canvas, {
          type: "doughnut",
          data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "rgba(229,231,235,.85)", boxWidth: 12, boxHeight: 12, padding: 12, font:{weight:"700"} }
              },
              tooltip: {
                callbacks: { label: (ctx) => ` ${ctx.label}: ${formatCurrency(ctx.parsed)}` }
              }
            },
            cutout: "58%"
          }
        });
      }else{
        pieChart.data.labels = labels;
        pieChart.data.datasets[0].data = values;
        pieChart.data.datasets[0].backgroundColor = colors;
        pieChart.update();
      }
    }

    // ===== Totals + Goal =====
    function updateBudgetTotals(){
      let totalEntrate = 0;
      document.querySelectorAll('#entrate-items .item-amount-input').forEach(i => totalEntrate += parseAmount(i.value));

      let totalSpese = 0;
      document.querySelectorAll('#spese-items .item-amount-input').forEach(i => totalSpese += parseAmount(i.value));

      const balance = totalEntrate - totalSpese;

      document.getElementById('total-entrate').textContent = formatCurrency(totalEntrate);
      document.getElementById('total-spese').textContent = formatCurrency(totalSpese);
      document.getElementById('summary-entrate').textContent = formatCurrency(totalEntrate);
      document.getElementById('summary-spese').textContent = formatCurrency(totalSpese);

      const balEl = document.getElementById('summary-balance');
      balEl.textContent = formatCurrency(balance);
      balEl.classList.toggle('pos', balance >= 0);
      balEl.classList.toggle('neg', balance < 0);

      updatePieChart();
      updateSavingsGoal();
    }

    function updateSavingsGoal(){
      const goalAmount = 250;
      document.getElementById("goal-amount").textContent = goalAmount.toFixed(2).replace(".", ",");

      const incomeText = document.getElementById('summary-entrate')?.textContent || "‚Ç¨ 0,00";
      const expenseText = document.getElementById('total-spese')?.textContent || "‚Ç¨ 0,00";

      const totalIncome = parseFloat(incomeText.replace('‚Ç¨','').replace('.', '').replace(',', '.').trim()) || 0;
      const totalExpense = parseFloat(expenseText.replace('‚Ç¨','').replace('.', '').replace(',', '.').trim()) || 0;

      const savedAmount = totalIncome - totalExpense;

      let percentage = (savedAmount / goalAmount) * 100;
      percentage = Math.max(0, Math.min(100, percentage));

      document.getElementById('savings-progress-bar').style.width = percentage + "%";
      document.getElementById('progress-percentage').textContent = percentage.toFixed(0) + "%";
      document.getElementById('saved-amount').textContent = "‚Ç¨" + savedAmount.toFixed(2).replace('.', ',');
      const remaining = Math.max(0, goalAmount - savedAmount);
      document.getElementById('remaining-amount').textContent = "‚Ç¨" + remaining.toFixed(2).replace('.', ',');
    }

    // ===== Food =====
    function updateFoodTotals(){
      const weeklyBudget = 125;
      let monthlyTotal = 0;

      for (let week=1; week<=4; week++){
        let weekTotal = 0;
        document.querySelectorAll(`.week${week}-shopping`).forEach(i => weekTotal += parseAmount(i.value));
        monthlyTotal += weekTotal;
        document.getElementById(`total-week${week}`).textContent = formatCurrency(weekTotal);
      }

      const monthlyBudget = 500;
      const remainingMonthly = monthlyBudget - monthlyTotal;

      document.getElementById('total-food-spent').textContent = formatCurrency(monthlyTotal);

      const remEl = document.getElementById('total-food-remaining');
      remEl.textContent = formatCurrency(remainingMonthly);
      remEl.classList.toggle('pos', remainingMonthly >= 0);
      remEl.classList.toggle('neg', remainingMonthly < 0);
    }

    // autosave hooks (oninput)
    document.addEventListener("input", (e)=>{
      const t = e.target;
      if (!t) return;

      if (t.classList.contains("week1-shopping") || t.classList.contains("week2-shopping") ||
          t.classList.contains("week3-shopping") || t.classList.contains("week4-shopping")){
        updateFoodTotals();
        saveMonthData();
        return;
      }

      if (t.classList.contains("item-label-input") || t.classList.contains("item-amount-input")){
        updateBudgetTotals();
        saveMonthData();
      }
    });

    // ===== Data =====
    function collectCurrentData(){
      const data = {
        month: currentMonth,
        entrate: [],
        spese: [],
        spesaAlimentare: { week1:[], week2:[], week3:[], week4:[] },
        lastModified: new Date().toISOString()
      };

      document.querySelectorAll('#entrate-items .entry-item').forEach(item=>{
        const label = item.querySelector('.item-label-input')?.value || "";
        const amount = item.querySelector('.item-amount-input')?.value || "";
        if (label || amount) data.entrate.push({ label, amount });
      });

      document.querySelectorAll('#spese-items .entry-item').forEach(item=>{
        const label = item.querySelector('.item-label-input')?.value || "";
        const amount = item.querySelector('.item-amount-input')?.value || "";
        if (label || amount) data.spese.push({ label, amount });
      });

      for (let week=1; week<=4; week++){
        document.querySelectorAll(`.week${week}-shopping`).forEach(input=>{
          data.spesaAlimentare[`week${week}`].push(input.value || "");
        });
      }
      return data;
    }

    async function saveMonthData(){
      if (!window._firebaseReady || !window._db || !currentUser) return;
      try{
        isSaving = true;
        setSyncStatus("Salvataggio‚Ä¶", "rgba(245,158,11,1)");

        const data = collectCurrentData();
        const ref = window._doc(window._db, "users", currentUser.uid, "budgets", currentMonth);
        await window._setDoc(ref, data, { merge:true });

        setSyncStatus("Salvato ‚úÖ", "rgba(34,197,94,1)");
      }catch(e){
        console.error("Save error:", e);
        setSyncStatus("Errore ‚ùå", "rgba(239,68,68,1)");
      }finally{
        setTimeout(()=>{ isSaving = false; }, 200);
      }
    }

    function resetUIEmpty(){
      document.getElementById('entrate-items').innerHTML = '';
      document.getElementById('spese-items').innerHTML = '';
      for (let week=1; week<=4; week++){
        document.querySelectorAll(`.week${week}-shopping`).forEach(input => input.value = '');
      }
      updateBudgetTotals();
      updateFoodTotals();
      updatePieChart();
      updateSavingsGoal();
    }

    function populateUIFromData(data){
      const entrateContainer = document.getElementById('entrate-items');
      const speseContainer = document.getElementById('spese-items');

      entrateContainer.innerHTML = '';
      (data.entrate || []).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerHTML = `
          <input type="text" class="item-label-input" placeholder="Nome" value="${escapeAttr(item.label)}">
          <input type="number" class="item-amount-input" placeholder="‚Ç¨" value="${escapeAttr(item.amount)}" step="0.01" min="0">
          <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
        `;
        entrateContainer.appendChild(div);
      });

      speseContainer.innerHTML = '';
      (data.spese || []).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerHTML = `
          <input type="text" class="item-label-input" placeholder="Nome" value="${escapeAttr(item.label)}">
          <input type="number" class="item-amount-input" placeholder="‚Ç¨" value="${escapeAttr(item.amount)}" step="0.01" min="0">
          <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
        `;
        speseContainer.appendChild(div);
      });

      for (let week=1; week<=4; week++){
        const inputs = document.querySelectorAll(`.week${week}-shopping`);
        const weekData = (data.spesaAlimentare && data.spesaAlimentare[`week${week}`]) ? data.spesaAlimentare[`week${week}`] : [];
        inputs.forEach((input, idx)=> input.value = weekData[idx] || '');
      }

      updateBudgetTotals();
      updateFoodTotals();
      updatePieChart();
      updateSavingsGoal();
    }

    function attachRealtimeListener(){
      if (!window._firebaseReady || !window._db || !currentUser) return;
      if (unsubscribe){ unsubscribe(); unsubscribe = null; }

      setSyncStatus("Caricamento‚Ä¶", "rgba(245,158,11,1)");

      const ref = window._doc(window._db, "users", currentUser.uid, "budgets", currentMonth);
      unsubscribe = window._onSnapshot(ref, (snap)=>{
        if (isSaving) return;
        if (snap.exists()){
          populateUIFromData(snap.data());
          setSyncStatus("Sincronizzato ‚úÖ", "rgba(34,197,94,1)");
        } else {
          resetUIEmpty();
          setSyncStatus("Vuoto ‚úÖ", "rgba(229,231,235,.85)");
        }
      }, (err)=>{
        console.error("Snapshot error:", err);
        setSyncStatus("Errore ‚ùå", "rgba(239,68,68,1)");
      });
    }

    // ===== Row add/remove =====
    function addEntryItem(type){
      const container = document.getElementById(type === 'entrate' ? 'entrate-items' : 'spese-items');
      const div = document.createElement('div');
      div.className = 'entry-item';
      div.innerHTML = `
        <input type="text" class="item-label-input" placeholder="Nome">
        <input type="number" class="item-amount-input" placeholder="‚Ç¨" step="0.01" min="0">
        <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
      `;
      container.appendChild(div);
      updateBudgetTotals();
      updatePieChart();
      updateSavingsGoal();
      saveMonthData();
    }

    function removeEntry(btn){
      const row = btn.closest(".entry-item");
      if (row){
        row.remove();
        updateBudgetTotals();
        updatePieChart();
        updateSavingsGoal();
        saveMonthData();
      }
    }

    // expose add/remove
    window.addEntryItem = addEntryItem;
    window.removeEntry = removeEntry;

    // ===== INIT + AUTH =====
    window.addEventListener("load", ()=>{
      const check = setInterval(()=>{
        if (!window._firebaseReady) return;
        clearInterval(check);

        window._onAuthStateChanged(window._auth, (user)=>{
          currentUser = user || null;

          if (!currentUser){
            userInfo.textContent = "";
            logoutBtnSidebar.style.display = "none";
            logoutBtnTop.style.display = "none";
            loginBtnTop.style.display = "inline-flex";
            showLoginOnly();
            setSyncStatus("Login richiesto", "rgba(245,158,11,1)");
            resetUIEmpty();
            return;
          }

          showApp();
          userInfo.textContent = currentUser.email || "";
          logoutBtnSidebar.style.display = "block";
          logoutBtnTop.style.display = "inline-flex";
          loginBtnTop.style.display = "none";

          setSyncStatus("Pronto ‚úÖ", "rgba(229,231,235,.85)");
          attachRealtimeListener();
          setTimeout(()=>{ updatePieChart(); updateSavingsGoal(); }, 120);
        });
      }, 60);
    });

    // ===== AI CHAT (solo DOM + token) =====
    (function(){
      const chatButton = document.getElementById('ai-chat-button');
      const chatBox = document.getElementById('ai-chat-box');
      const closeBtn = document.getElementById('ai-chat-close');
      const minimizeBtn = document.getElementById('ai-chat-minimize');
      const messagesEl = document.getElementById('ai-chat-messages');
      const form = document.getElementById('ai-chat-form');
      const input = document.getElementById('ai-chat-input');

      // ‚úÖ senza slash finale
      const API_URL = 'https://ai-chat-backend-vercel.vercel.app/api/ai-chat';

      let comparatoriContent = '';
      fetch('comparatori1.html')
        .then(r=> r.ok ? r.text() : '')
        .then(t=> comparatoriContent = t || '')
        .catch(()=> comparatoriContent='');

      function addMsg(text, who){
        const id = 'msg-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        const wrap = document.createElement('div');
        wrap.className = 'ai-msg ' + (who === 'user' ? 'ai-msg-user' : 'ai-msg-ai');
        wrap.dataset.id = id;
        const bubble = document.createElement('div');
        bubble.className = 'ai-msg-bubble';
        bubble.textContent = text;
        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return id;
      }
      function updateMsg(id, text){
        const el = messagesEl.querySelector(`[data-id="${id}"] .ai-msg-bubble`);
        if (el) el.textContent = text;
        else addMsg(text, 'ai');
      }

      function readItems(containerId){
        return [...document.querySelectorAll(`#${containerId} .entry-item`)].map(row=>{
          const label = row.querySelector(".item-label-input")?.value?.trim() || "";
          const amount = row.querySelector(".item-amount-input")?.value || "";
          return { label, amount };
        }).filter(x => x.label || x.amount);
      }
      function getText(id){ return document.getElementById(id)?.textContent?.trim() || ""; }
      function buildListText(title, arr){
        if (!arr.length) return `${title}: (vuoto)`;
        return `${title}:\n` + arr.map((x,i)=> `- ${i+1}) ${x.label || "(senza nome)"} = ${x.amount || "0"}`).join("\n");
      }

      chatButton.addEventListener('click', ()=>{
        if (!currentUser){
          alert("Devi fare login prima di usare l'assistente AI.");
          return;
        }
        chatBox.classList.remove('hidden');
        chatBox.classList.remove('minimized');
        input.focus();
        if (!messagesEl.dataset.started){
          addMsg("Ciao! cosa posso fare oggi per te capo?üí™", 'ai');
          messagesEl.dataset.started = 'true';
        }
      });

      closeBtn.addEventListener('click', ()=>{
        chatBox.classList.add('hidden');
        messagesEl.innerHTML = '';
        delete messagesEl.dataset.started;
      });

      minimizeBtn.addEventListener('click', ()=> chatBox.classList.toggle('minimized'));

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!currentUser){
          addMsg("Devi fare login.", "ai");
          return;
        }

        const q = input.value.trim();
        if (!q) return;

        addMsg(q, 'user');
        input.value = '';

        const typingId = addMsg("Sto analizzando il tuo budget‚Ä¶", 'ai');

        const entrate_items = readItems("entrate-items");
        const spese_items = readItems("spese-items");

        const listText =
          buildListText("ENTRATE (lista completa)", entrate_items) + "\n\n" +
          buildListText("SPESE (lista completa)", spese_items) + "\n\n" +
          `RIEPILOGO: entrate=${getText("summary-entrate")}, spese=${getText("summary-spese")}, risparmio=${getText("summary-balance")}\n` +
          `OBIETTIVO: obiettivo=‚Ç¨${getText("goal-amount")}, risparmiato=${getText("saved-amount")}, mancano=${getText("remaining-amount")}\n` +
          `MESE: ${localStorage.getItem("budgetMonth") || ""}`;

        const budgetContext = {
          month: localStorage.getItem("budgetMonth") || "",
          summary: {
            entrate: getText("summary-entrate"),
            spese: getText("summary-spese"),
            risparmio: getText("summary-balance")
          },
          obiettivo: {
            obiettivo_mensile: "‚Ç¨" + (document.getElementById("goal-amount")?.textContent || "250,00"),
            risparmiato: getText("saved-amount"),
            mancano: getText("remaining-amount")
          },
          entrate_items,
          spese_items,
          food: {
            week1: [...document.querySelectorAll(".week1-shopping")].map(i=>i.value||""),
            week2: [...document.querySelectorAll(".week2-shopping")].map(i=>i.value||""),
            week3: [...document.querySelectorAll(".week3-shopping")].map(i=>i.value||""),
            week4: [...document.querySelectorAll(".week4-shopping")].map(i=>i.value||"")
          },
          listText
        };

        try{
          const idToken = await currentUser.getIdToken(true);

          const res = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + idToken
            },
            body: JSON.stringify({
              question: q,
              context_html: comparatoriContent,
              budget: budgetContext,
              month: budgetContext.month
            })
          });

          if (!res.ok){
            const t = await res.text().catch(()=> "");
            updateMsg(typingId, `Errore AI (HTTP ${res.status}).\n${t.slice(0,220)}`);
            return;
          }

          const data = await res.json().catch(()=> ({}));
          updateMsg(typingId, data.answer || "Nessuna risposta dall‚ÄôAI.");
        }catch(err){
          console.error(err);
          updateMsg(typingId, "Errore nel contattare l‚ÄôAI. Controlla API_URL / CORS / endpoint.");
        }

        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    })();
  </script>

  <!-- FIRESTORE RULES (Firebase Console -> Firestore Rules)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId}/budgets/{monthId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  -->
  <script>
(function(){
  const widget = document.getElementById('ai-chat-widget');
  const btn = document.getElementById('ai-chat-button');
  if(!widget || !btn) return;

  // --- ripristina posizione salvata ---
  const saved = localStorage.getItem('aiWidgetPos');
  if (saved) {
    try {
      const p = JSON.parse(saved);
      widget.style.left = p.left;
      widget.style.top = p.top;
      widget.style.right = 'auto';
      widget.style.bottom = 'auto';
    } catch(e){}
  }

  let isDragging = false;
  let moved = false;
  let offsetX = 0, offsetY = 0;

  function startDrag(e){
    // click destro no
    if (e.button !== undefined && e.button !== 0) return;

    const p = (e.touches && e.touches[0]) ? e.touches[0] : e;

    const rect = widget.getBoundingClientRect();
    offsetX = p.clientX - rect.left;
    offsetY = p.clientY - rect.top;

    isDragging = true;
    moved = false;
    widget.classList.add('dragging');

    // disattiva animazione fluttuante mentre trascini (se la usi sull'immagine)
    const img = widget.querySelector('img');
    if (img) img.style.animation = 'none';
  }

  function onMove(e){
    if(!isDragging) return;

    const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
    moved = true;

    // limita dentro lo schermo
    const w = widget.offsetWidth;
    const h = widget.offsetHeight;

    let x = p.clientX - offsetX;
    let y = p.clientY - offsetY;

    x = Math.max(8, Math.min(window.innerWidth - w - 8, x));
    y = Math.max(8, Math.min(window.innerHeight - h - 8, y));

    widget.style.left = x + 'px';
    widget.style.top = y + 'px';
    widget.style.right = 'auto';
    widget.style.bottom = 'auto';
  }

  function endDrag(){
    if(!isDragging) return;
    isDragging = false;
    widget.classList.remove('dragging');

    // riattiva animazione
    const img = widget.querySelector('img');
    if (img) img.style.animation = '';

    // salva posizione
    const rect = widget.getBoundingClientRect();
    localStorage.setItem('aiWidgetPos', JSON.stringify({
      left: rect.left + 'px',
      top: rect.top + 'px'
    }));
  }

  // Mouse
  btn.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', endDrag);

  // Touch (mobile)
  btn.addEventListener('touchstart', startDrag, {passive:true});
  document.addEventListener('touchmove', onMove, {passive:true});
  document.addEventListener('touchend', endDrag);

  // Evita che un drag apra la chat (blocca il click se hai trascinato)
  btn.addEventListener('click', (e) => {
    if(moved){
      e.preventDefault();
      e.stopPropagation();
      moved = false;
    }
  }, true);
})();
</script>

</body>
</html>
