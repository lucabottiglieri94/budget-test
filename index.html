<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Budget Mensile - Gestione Familiare</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
 --primary:#667eea;
 --success:#4CAF50;
 --danger:#F44336;
 --warn:#FF9800;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
 font-family:system-ui;
 background:linear-gradient(135deg,#667eea,#764ba2);
 min-height:100vh;
}

header{
 position:fixed;
 top:0;left:0;right:0;
 background:linear-gradient(135deg,#667eea,#764ba2);
 color:white;
 padding:20px;
 text-align:center;
 z-index:1000;
 transition:.3s;
}

header.header-hidden{
 transform:translateY(-100%);
 opacity:0;
}

.content{
 padding:180px 20px 40px;
 max-width:900px;
 margin:auto;
 display:flex;
 flex-direction:column;
 gap:18px;
}

.section{
 background:white;
 border-radius:14px;
 padding:18px;
 box-shadow:0 4px 16px rgba(0,0,0,.15);
}

.entry-item{
 display:flex;
 gap:8px;
 margin-bottom:8px;
}

input{
 padding:8px;
 border-radius:8px;
 border:1px solid #ccc;
 width:100%;
}

button{
 border:none;
 border-radius:8px;
 padding:8px 12px;
 font-weight:600;
 cursor:pointer;
}

.btn-add{width:100%;background:var(--success);color:white}
.btn-del{background:var(--danger);color:white}

.summary{
 display:grid;
 grid-template-columns:1fr 1fr 1fr;
 gap:10px;
 text-align:center;
}

.card{
 background:#f5f5f5;
 padding:14px;
 border-radius:10px;
 font-weight:700;
}

.progress{
 height:28px;
 background:#eee;
 border-radius:20px;
 overflow:hidden;
}

.bar{
 height:100%;
 background:var(--success);
 width:0%;
 color:white;
 display:flex;
 align-items:center;
 justify-content:center;
 font-weight:700;
}

.alert{
 position:fixed;
 top:20px;
 right:20px;
 background:#ff6b6b;
 color:white;
 padding:16px;
 border-radius:12px;
 display:none;
 z-index:9999;
}

#chartWrap{max-width:420px;margin:auto}
</style>
</head>

<body>

<header>
<h1>ðŸ’° Budget Mensile</h1>

<select id="monthSel">
<option value="2026-02">Febbraio</option>
<option value="2026-03">Marzo</option>
<option value="2026-04">Aprile</option>
</select>

<div>
<button id="loginBtn">Accedi Google</button>
<span id="userInfo"></span>
</div>

<div id="syncStatus">Sync: attesa</div>
</header>

<div class="content">

<div class="section">
<h3>Entrate</h3>
<div id="entrate"></div>
<button class="btn-add" onclick="addRow('entrate')">+ Aggiungi</button>
</div>

<div class="section">
<h3>Spese</h3>
<div id="spese"></div>
<button class="btn-add" style="background:var(--danger)" onclick="addRow('spese')">+ Aggiungi</button>
</div>

<div class="section summary">
<div class="card">Entrate<br><span id="totEntr">0</span></div>
<div class="card">Spese<br><span id="totSpe">0</span></div>
<div class="card">Risparmio<br><span id="totBal">0</span></div>
</div>

<div class="section">
<h3>Obiettivo Risparmio â‚¬250</h3>
<div class="progress"><div class="bar" id="goalBar">0%</div></div>
</div>

<div class="section" id="chartWrap">
<canvas id="pie"></canvas>
</div>

</div>

<div class="alert" id="alert">âš  Budget settimanale superato</div>

<!-- FIREBASE -->
<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import {getFirestore,doc,setDoc,onSnapshot} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
import {getAuth,GoogleAuthProvider,signInWithPopup,onAuthStateChanged,signOut}
from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

const cfg={
 apiKey:"AIzaSy...",
 authDomain:"budget-luca.firebaseapp.com",
 projectId:"budget-luca"
};

const app=initializeApp(cfg);
const db=getFirestore(app);
const auth=getAuth(app);
const prov=new GoogleAuthProvider();

window.fb={db,doc,setDoc,onSnapshot,auth,prov,signInWithPopup,signOut};
</script>

<script>
let user=null;
let month="2026-02";
let chart=null;
let alertLock=false;

const â‚¬=v=>"â‚¬ "+v.toFixed(2).replace('.',',');

function parseâ‚¬(t){
 return parseFloat(t.replace(/[^\d,.-]/g,'').replace(',','.'))||0;
}

function addRow(type,label="",amt=""){
 const wrap=document.getElementById(type);
 const d=document.createElement("div");
 d.className="entry-item";
 d.innerHTML=`
 <input placeholder="nome" value="${label}">
 <input type="number" step="0.01" value="${amt}">
 <button class="btn-del">âœ•</button>`;
 wrap.appendChild(d);
 d.querySelector("button").onclick=()=>{d.remove();calc();save()};
 d.querySelectorAll("input").forEach(i=>i.oninput=()=>{calc();save()});
}

function calc(){
 let e=0,s=0;

 document.querySelectorAll("#entrate input[type=number]").forEach(i=>e+=+i.value||0);
 document.querySelectorAll("#spese input[type=number]").forEach(i=>s+=+i.value||0);

 document.getElementById("totEntr").textContent=â‚¬(e);
 document.getElementById("totSpe").textContent=â‚¬(s);
 document.getElementById("totBal").textContent=â‚¬(e-s);

 goal(e-s);
 pie();
}

function goal(val){
 const pct=Math.max(0,Math.min(100,(val/250)*100));
 const bar=document.getElementById("goalBar");
 bar.style.width=pct+"%";
 bar.textContent=pct.toFixed(0)+"%";
}

function pie(){
 const map={};
 document.querySelectorAll("#spese .entry-item").forEach(r=>{
  const l=r.children[0].value||"Altro";
  const v=+r.children[1].value||0;
  map[l]=(map[l]||0)+v;
 });

 if(chart) chart.destroy();

 chart=new Chart(document.getElementById("pie"),{
  type:"pie",
  data:{
   labels:Object.keys(map),
   datasets:[{data:Object.values(map)}]
  }
 });
}

async function save(){
 if(!user) return;
 const data={entr:[],spe:[]};
 document.querySelectorAll("#entrate .entry-item").forEach(r=>{
  data.entr.push({l:r.children[0].value,a:r.children[1].value});
 });
 document.querySelectorAll("#spese .entry-item").forEach(r=>{
  data.spe.push({l:r.children[0].value,a:r.children[1].value});
 });

 const ref=fb.doc(fb.db,"budgets",user.uid,"months",month);
 await fb.setDoc(ref,data);
}

function listen(){
 if(!user) return;
 const ref=fb.doc(fb.db,"budgets",user.uid,"months",month);
 fb.onSnapshot(ref,s=>{
  if(!s.exists()) return;
  entrate.innerHTML="";
  spese.innerHTML="";
  s.data().entr.forEach(x=>addRow("entrate",x.l,x.a));
  s.data().spe.forEach(x=>addRow("spese",x.l,x.a));
  calc();
 });
}

loginBtn.onclick=async()=>{
 if(!user) await fb.signInWithPopup(fb.auth,fb.prov);
 else await fb.signOut(fb.auth);
};

onAuthStateChanged(fb.auth,u=>{
 user=u;
 userInfo.textContent=u?u.email:"";
 loginBtn.textContent=u?"Esci":"Accedi Google";
 if(u) listen();
});

monthSel.onchange=e=>{
 month=e.target.value;
 listen();
};

addRow("entrate");
addRow("spese");
calc();

window.addEventListener("scroll",()=>{
 if(window.scrollY>20) header.classList.add("header-hidden");
 else header.classList.remove("header-hidden");
});
</script>

</body>
</html>
