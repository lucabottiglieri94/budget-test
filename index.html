<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <title>Budget Mensile - Web App</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#070B14;
      --bg1:#0B1220;

      --card: rgba(15,23,42,.72);
      --text:#E5E7EB;
      --muted:#9CA3AF;

      --shadow: 0 22px 70px rgba(0,0,0,.45);
      --shadow2: 0 14px 40px rgba(0,0,0,.30);
      --radius:18px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing:border-box; margin:0; padding:0 }
    html,body{ height:100% }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.16), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      overflow-x:hidden;
    }

    /* ===== LOGIN ===== */
    #login-screen{
      position: fixed;
      inset: 0;
      z-index: 999999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(18px + var(--safe-top)) calc(18px + var(--safe-left))
               calc(18px + var(--safe-bottom)) calc(18px + var(--safe-right));
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.20), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    #login-card{
      width: min(560px, 94vw);
      border-radius: 22px;
      background: rgba(15,23,42,.70);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 22px 18px;
      text-align:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 800;
      color: rgba(229,231,235,.95);
      margin-bottom: 14px;
      font-size: 12px;
    }
    #login-card h1{
      font-size: clamp(26px, 5vw, 38px);
      font-weight: 950;
      margin-bottom: 8px;
      letter-spacing: .2px;
    }
    #login-card p{
      color: rgba(229,231,235,.90);
      font-weight: 700;
      line-height: 1.35;
      margin-bottom: 16px;
    }
    #login-screen-btn{
      width:100%;
      padding: 14px 16px;
      border: none;
      border-radius: 14px;
      font-weight: 950;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(56,189,248,1));
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
      transition: transform .08s ease;
    }
    #login-screen-btn:active{ transform: scale(.99) }
    #login-screen small{
      display:block;
      margin-top:10px;
      font-size:12px;
      color: rgba(229,231,235,.85);
      font-weight: 700;
    }

    /* ===== APP ===== */
    #app{ display:none; min-height:100vh; }

    .shell{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      padding: calc(16px + var(--safe-top)) 16px calc(90px + var(--safe-bottom)) 16px;
    }

    .sidebar{
      position: sticky;
      top: calc(16px + var(--safe-top));
      align-self: start;
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 16px;
      backdrop-filter: blur(10px);
      height: fit-content;
    }
    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 14px;
    }
    .brand h1{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .brand .badge{
      font-size: 11px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
    }

    .menu{ display:flex; flex-direction:column; gap:10px; margin-top: 12px; }
    .navbtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:none;
      cursor:pointer;
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 950;
      color: rgba(229,231,235,.92);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      transition: transform .08s ease, background .12s ease;
    }
    .navbtn:hover{ background: rgba(255,255,255,.09) }
    .navbtn:active{ transform: scale(.99) }
    .navbtn .hint{ font-size: 12px; font-weight: 900; color: rgba(229,231,235,.75); }

    .main{ display:flex; flex-direction:column; gap: 14px; }

    .topbar{
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .topbar-left{ display:flex; flex-direction:column; gap:6px; min-width:240px; }
    .topbar-title{ font-weight: 950; font-size: 18px; letter-spacing:.2px; }
    .topbar-sub{ color: rgba(229,231,235,.78); font-weight:700; font-size:12px; }

    .topbar-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; flex: 1; }
    .select{
      flex: 1;
      min-width: 220px;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(15,23,42,.85);
      color: rgba(229,231,235,.92);
      font-size: 15px;
      font-weight: 900;
      outline:none;
      appearance:none;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .select:hover{
      background: rgba(15,23,42,.95);
    }
    .select option{
      background: #0B1220;
      color: rgba(229,231,235,.92);
      padding: 10px;
      font-weight: 900;
    }
    .btn{
      border:none;
      cursor:pointer;
      padding: 11px 12px;
      border-radius: 14px;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .08s ease;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(229,231,235,.92);
    }
    .btn:active{ transform: scale(.99) }

    #user-info{
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,.82);
      max-width: 52vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    #sync-status{ font-size: 12px; font-weight: 900; color: rgba(229,231,235,.85); margin-top: 8px; }
    #sync-label{ font-weight: 950; }

    .summary{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
    .sum{
      border-radius: var(--radius);
      padding: 14px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .sum .label{
      font-size: 12px;
      font-weight: 950;
      color: rgba(229,231,235,.75);
      letter-spacing: .8px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .sum .value{ font-size: 20px; font-weight: 950; letter-spacing:.2px; }
    .pos{ color: rgba(34,197,94,1); }
    .neg{ color: rgba(239,68,68,1); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .card{
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      font-size: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .muted{ color: rgba(229,231,235,.70); font-weight:800; font-size:12px; }

    .entry-items{ display:flex; flex-direction:column; gap:10px; margin-bottom: 12px; }
    .entry-item{
      display:flex;
      align-items:center;
      gap:8px;
      border-radius: 16px;
      padding: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .item-label-input, .item-amount-input{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
      padding: 10px;
      font-size: 16px;
      font-weight: 900;
      outline:none;
    }
    .item-label-input{ flex:1; min-width:0; }
    .item-amount-input{ width: 118px; text-align:right; }

    .btn-remove{
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      color: #061019;
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(245,158,11,1));
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .btn-add{
      width:100%;
      border:none;
      cursor:pointer;
      border-radius: 16px;
      padding: 12px;
      font-weight: 950;
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
    }
    .btn-add.income{ background: linear-gradient(135deg, rgba(34,197,94,1), rgba(56,189,248,1)); }
    .btn-add.cost{ background: linear-gradient(135deg, rgba(239,68,68,1), rgba(124,58,237,1)); }

    .pie-wrap{ position:relative; height: 260px; }

    /* ===== FOOD ===== */
    .week-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .week-grid label{
      display:block;
      font-size: 12px;
      color: rgba(229,231,235,.70);
      font-weight: 900;
      margin-bottom: 4px;
    }
    .total-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 950;
      margin-top: 10px;
    }

    /* Budget Settings Input */
    .budget-input{
      width: 120px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
      padding: 8px 10px;
      font-size: 14px;
      font-weight: 900;
      outline:none;
      text-align: center;
    }

    /* ===== AI ORB + CHAT ===== */
    #ai-chat-widget{
      position: fixed;
      right: 16px;
      bottom: calc(78px + env(safe-area-inset-bottom, 0px));
      width: 92px;
      height: 92px;
      z-index: 99999;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    #ai-chat-button{
      width: 92px;
      height: 92px;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
      touch-action: none;
    }
    .ai-orb-img{
      width: 92px;
      height: 92px;
      border-radius: 28%;
      animation: aiFloat 4s ease-in-out infinite;
      transition: transform .2s ease;
      -webkit-user-drag: none;
      user-select: none;
      touch-action: none;
    }
    @keyframes aiFloat {
      0% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }

    #ai-chat-box{
      position:absolute;
      right:0;
      bottom: 106px;
      width: min(420px, calc(100vw - 24px));
      max-height: min(620px, 74vh);
      border-radius: 22px;
      background: rgba(15,23,42,.92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(12px);
    }
    #ai-chat-box.hidden{ display:none !important; }

    .ai-chat-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      background: rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .ai-chat-title{ font-weight: 950; font-size: 13px; letter-spacing:.2px; }
    .ai-chat-actions button{
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 8px 10px;
      font-weight: 950;
      color: rgba(229,231,235,.92);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
    }

    #ai-chat-messages{
      padding: 12px;
      overflow-y:auto;
      flex:1;
      background: rgba(255,255,255,.03);
      font-size: 14px;
      line-height: 1.55;
      font-weight: 750;
    }
    .ai-msg{ display:flex; margin-bottom: 10px; }
    .ai-msg-user{ justify-content:flex-end; }
    .ai-msg-ai{ justify-content:flex-start; }
    .ai-msg-bubble{
      max-width: 86%;
      padding: 12px 12px;
      border-radius: 18px;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 8px 22px rgba(0,0,0,.25);
      font-weight: 800;
      letter-spacing: .1px;
    }
    .ai-msg-user .ai-msg-bubble{
      background: rgba(255,255,255,.14);
      color: #F9FAFB;
      border: 1px solid rgba(255,255,255,.20);
      border-bottom-right-radius: 8px;
      box-shadow:
        0 8px 22px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.12);
    }
    .ai-msg-ai .ai-msg-bubble{
      background: rgba(255,255,255,.07);
      color: #E5E7EB;
      border: 1px solid rgba(255,255,255,.12);
      border-bottom-left-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,.28);
    }

    #ai-chat-form{
      display:flex;
      gap:10px;
      padding: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(7,11,20,.60);
      backdrop-filter: blur(10px);
    }
    #ai-chat-input{
      flex:1;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.96);
      padding: 12px 12px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 850;
      outline:none;
    }
    #ai-chat-form button{
      border:none;
      cursor:pointer;
      padding: 0 16px;
      border-radius: 16px;
      font-weight: 950;
      color:#061019;
      background: linear-gradient(135deg, rgba(34,197,94,1), rgba(56,189,248,1));
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
    }

    /* Mobile */
    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .summary{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
      .select{ min-width: 0; width: 100%; }
      .topbar-right{ justify-content:flex-start; }
      #user-info{ max-width: 90vw; }
    }
  </style>
</head>

<body>
  <!-- LOGIN SCREEN -->
  <div id="login-screen">
    <div id="login-card">
      <div class="pill">üîí Dati privati ‚Ä¢ Per-account ‚Ä¢ Firebase</div>
      <h1>üí∞ Budget Mensile</h1>
      <p>Accedi con Google per vedere e salvare <b>solo i tuoi dati</b>.</p>
      <button id="login-screen-btn" type="button">Accedi con Google</button>
      <small>Se non clicca: controlla popup bloccati (Safari/Chrome).</small>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <div class="shell">
      <aside class="sidebar">
        <div class="brand">
          <h1>Budget Dashboard</h1>
          <div class="badge">Web App</div>
        </div>

        <div id="sync-status">Stato: <span id="sync-label">In attesa‚Ä¶</span></div>
        <div style="height:10px"></div>
        <div id="user-info"></div>

        <div class="menu">
          <button class="navbtn" type="button" onclick="location.href='risparmi.html'">
            <span>üìä Grafico Risparmi</span><span class="hint">Stats</span>
          </button>
          <button class="navbtn" type="button" onclick="location.href='comparatori.html'">
            <span>üõí Comparatori</span><span class="hint">Offerte</span>
          </button>
          <button id="login-btn" class="navbtn" type="button">
            <span>üîë Accedi Google</span><span class="hint">Login</span>
          </button>
          <button id="logout-btn" class="navbtn" type="button" style="display:none;">
            <span>üö™ Esci</span><span class="hint">Logout</span>
          </button>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div class="topbar-left">
            <div class="topbar-title">üí∞ Budget Mensile</div>
            <div class="topbar-sub">Gestione entrate/spese ‚Ä¢ sincronizzato</div>
          </div>
          <div class="topbar-right">
            <select id="month-selector" class="select"></select>
            <button id="top-login" class="btn" type="button">Accedi</button>
            <button id="top-logout" class="btn" type="button" style="display:none;">Esci</button>
          </div>
        </div>

        <div class="summary">
          <div class="sum"><div class="label">Entrate</div><div class="value" id="summary-entrate">‚Ç¨ 0,00</div></div>
          <div class="sum"><div class="label">Spese</div><div class="value" id="summary-spese">‚Ç¨ 0,00</div></div>
          <div class="sum"><div class="label">Risparmio</div><div class="value pos" id="summary-balance">‚Ç¨ 0,00</div></div>
        </div>

        <div class="grid">
          <section class="card">
            <h2>üì• Entrate <span class="muted">totale: <span id="total-entrate">‚Ç¨ 0,00</span></span></h2>
            <div class="entry-items" id="entrate-items"></div>
            <button class="btn-add income" type="button" onclick="addEntryItem('entrate')">+ Aggiungi Entrata</button>
          </section>

          <section class="card">
            <h2>üì§ Spese <span class="muted">totale: <span id="total-spese">‚Ç¨ 0,00</span></span></h2>
            <div class="entry-items" id="spese-items"></div>
            <button class="btn-add cost" type="button" onclick="addEntryItem('spese')">+ Aggiungi Spesa</button>
          </section>
        </div>

        <div class="grid">
          <section class="card">
            <h2>ü•ß Ripartizione <span class="muted">auto</span></h2>
            <div class="pie-wrap"><canvas id="budgetPie"></canvas></div>
          </section>

          <section class="card">
            <h2>üéØ Obiettivo Risparmio <span class="muted">
              ‚Ç¨<input type="number" id="savings-goal-input" class="budget-input" min="0" step="50" value="250" placeholder="250">
            </span></h2>
            <div class="muted" style="margin-bottom:8px;">Risparmio mensile target</div>
            <div style="height:38px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);overflow:hidden;position:relative;margin-bottom:10px;">
              <div id="savings-progress-bar" style="height:100%;width:0%;background:linear-gradient(90deg, rgba(34,197,94,1), rgba(56,189,248,1));border-radius:999px;transition:width .18s linear;"></div>
              <span id="progress-percentage" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:950;color:#061019;text-shadow:0 2px 12px rgba(0,0,0,.35);">0%</span>
            </div>
            <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;font-weight:900;color:rgba(229,231,235,.78);font-size:12px;">
              <span>Risparmiato: <b id="saved-amount">‚Ç¨0,00</b></span>
              <span>Mancano: <b id="remaining-amount">‚Ç¨250,00</b></span>
            </div>
          </section>
        </div>

        <!-- ‚úÖ SPESE ALIMENTARI (4 settimane) -->
        <section class="card">
          <h2>üõí Spese Alimentari 
            <span class="muted">
              Budget: ‚Ç¨<input type="number" id="food-budget-input" class="budget-input" min="0" step="50" value="500" placeholder="500"> 
              ‚Ä¢ Target/sett: ‚Ç¨<input type="number" id="food-weekly-input" class="budget-input" min="0" step="10" value="125" placeholder="125">
            </span>
          </h2>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 1</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
              </div>
              <div class="total-row"><span>Totale</span><span id="total-week1">‚Ç¨ 0,00</span></div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 2</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
              </div>
              <div class="total-row"><span>Totale</span><span id="total-week2">‚Ç¨ 0,00</span></div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 3</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
              </div>
              <div class="total-row"><span>Totale</span><span id="total-week3">‚Ç¨ 0,00</span></div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 4</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
              </div>
              <div class="total-row"><span>Totale</span><span id="total-week4">‚Ç¨ 0,00</span></div>
            </div>
          </div>

          <div class="summary" style="margin-top:14px;">
            <div class="sum"><div class="label">Budget</div><div class="value" id="display-food-budget">‚Ç¨ 500</div></div>
            <div class="sum"><div class="label">Speso</div><div class="value" id="total-food-spent">‚Ç¨ 0,00</div></div>
            <div class="sum"><div class="label">Rimasto</div><div class="value pos" id="total-food-remaining">‚Ç¨ 500,00</div></div>
          </div>
        </section>

        <!-- üêæ SPESE ANIMALI (4 settimane) -->
        <section class="card">
          <h2>üêæ Spese Animali 
            <span class="muted">
              Budget: ‚Ç¨<input type="number" id="pet-budget-input" class="budget-input" min="0" step="50" value="200" placeholder="200"> 
              ‚Ä¢ Target/sett: ‚Ç¨<input type="number" id="pet-weekly-input" class="budget-input" min="0" step="10" value="50" placeholder="50">
            </span>
          </h2>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 1</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input pet-week1-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input pet-week1-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input pet-week1-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input pet-week1-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
              </div>
              <div class="total-row"><span>Totale</span><span id="total-pet-week1">‚Ç¨ 0,00</span></div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 2</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input pet-week2-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input pet-week2-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input pet-week2-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input pet-week2-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
              </div>
              <div class="total-row"><span>Totale</span><span id="total-pet-week2">‚Ç¨ 0,00</span></div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 3</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input pet-week3-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input pet-week3-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input pet-week3-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input pet-week3-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
              </div>
              <div class="total-row"><span>Totale</span><span id="total-pet-week3">‚Ç¨ 0,00</span></div>
            </div>

            <div class="card" style="background: rgba(255,255,255,.04); box-shadow:none;">
              <div style="font-weight:950; margin-bottom:10px;">üìÖ Settimana 4</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input pet-week4-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input pet-week4-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input pet-week4-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input pet-week4-shopping" placeholder="‚Ç¨" step="0.01" min="0"></div>
              </div>
              <div class="total-row"><span>Totale</span><span id="total-pet-week4">‚Ç¨ 0,00</span></div>
            </div>
          </div>

          <div class="summary" style="margin-top:14px;">
            <div class="sum"><div class="label">Budget</div><div class="value" id="display-pet-budget">‚Ç¨ 200</div></div>
            <div class="sum"><div class="label">Speso</div><div class="value" id="total-pet-spent">‚Ç¨ 0,00</div></div>
            <div class="sum"><div class="label">Rimasto</div><div class="value pos" id="total-pet-remaining">‚Ç¨ 200,00</div></div>
          </div>
        </section>
      </main>
    </div>

    <!-- AI CHAT -->
    <div id="ai-chat-widget">
      <button id="ai-chat-button" aria-label="Apri chat AI" type="button">
        <img
          src="https://image2url.com/r2/default/images/1770554545375-45357bf1-9e2f-4a1e-9305-4afcce9a82e5.png"
          alt="AI Assistant"
          class="ai-orb-img"
          draggable="false"
        >
      </button>

      <div id="ai-chat-box" class="hidden">
        <div class="ai-chat-header">
          <div class="ai-chat-title">Assistente AI</div>
          <div class="ai-chat-actions">
            <button id="ai-chat-minimize" type="button">‚àí</button>
            <button id="ai-chat-close" type="button">√ó</button>
          </div>
        </div>

        <div id="ai-chat-messages"></div>

        <form id="ai-chat-form">
          <input id="ai-chat-input" type="text" placeholder="Chiedimi sul tuo budget‚Ä¶" autocomplete="off" />
          <button type="submit">Invia</button>
        </form>
      </div>
    </div>
  </div>

  <!-- FIREBASE (MODULE) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged,
      signOut,
      setPersistence,
      browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
      authDomain: "budget-luca.firebaseapp.com",
      projectId: "budget-luca",
      storageBucket: "budget-luca.firebasestorage.app",
      messagingSenderId: "67496424698",
      appId: "1:67496424698:web:b1822e04ef4efc07408543",
      measurementId: "G-7LEYRZE9QN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    await setPersistence(auth, browserSessionPersistence);

    window.firebaseAuth = {
      db,
      auth,
      provider,
      doc,
      setDoc,
      onSnapshot,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged,
      signOut
    };

    getRedirectResult(auth).catch(()=>{});
  </script>

  <!-- APP + CHAT + ORB (NO MODULE) -->
  <script>
    function pad2(n){ return String(n).padStart(2,"0"); }
    function monthLabel(y,m){
      const mesi = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
      return `${mesi[m-1]} ${y}`;
    }
    function buildMonthOptions(selectEl){
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const count = 12;
      const opts = [];
      for(let i=0;i<count;i++){
        const d = new Date(start.getFullYear(), start.getMonth()+i, 1);
        const y = d.getFullYear();
        const m = d.getMonth()+1;
        const val = `${y}-${pad2(m)}`;
        opts.push({ val, text: monthLabel(y,m) });
      }
      selectEl.innerHTML = opts.map(o=>`<option value="${o.val}">${o.text}</option>`).join("");
    }

    function parseAmount(x){ return parseFloat((x ?? "").toString().replace(",", ".")) || 0; }
    function formatCurrency(v){ return "‚Ç¨ " + (Number(v||0)).toFixed(2).replace(".", ","); }
    function escapeAttr(s){ return (s ?? "").toString().replaceAll('"','&quot;'); }

    let currentMonth = localStorage.getItem("budgetMonth") || "";
    let currentUser = null;
    let unsubscribe = null;
    let isSaving = false;

    const loginScreen = document.getElementById("login-screen");
    const loginScreenBtn = document.getElementById("login-screen-btn");
    const appEl = document.getElementById("app");

    const monthSelector = document.getElementById("month-selector");
    const loginBtnSidebar = document.getElementById("login-btn");
    const logoutBtnSidebar = document.getElementById("logout-btn");

    const loginBtnTop = document.getElementById("top-login");
    const logoutBtnTop = document.getElementById("top-logout");

    const userInfo = document.getElementById("user-info");
    const syncLabel = document.getElementById("sync-label");

    // Settings inputs
    const savingsGoalInput = document.getElementById("savings-goal-input");
    const foodBudgetInput = document.getElementById("food-budget-input");
    const foodWeeklyInput = document.getElementById("food-weekly-input");
    const petBudgetInput = document.getElementById("pet-budget-input");
    const petWeeklyInput = document.getElementById("pet-weekly-input");

    function setSyncStatus(text, color="rgba(229,231,235,.85)"){
      syncLabel.textContent = text;
      syncLabel.style.color = color;
    }
    function showLoginOnly(){ loginScreen.style.display = "flex"; appEl.style.display = "none"; }
    function showApp(){ loginScreen.style.display = "none"; appEl.style.display = "block"; }

    buildMonthOptions(monthSelector);
    if (!currentMonth){
      currentMonth = monthSelector.value;
      localStorage.setItem("budgetMonth", currentMonth);
    } else {
      monthSelector.value = currentMonth;
    }
    monthSelector.addEventListener("change", ()=>{
      currentMonth = monthSelector.value;
      localStorage.setItem("budgetMonth", currentMonth);
      attachRealtimeListener();
    });

    // ===== Auto-expense items =====
    function getAutoExpenseItem(labelName) {
      const items = document.querySelectorAll('#spese-items .entry-item');
      for (let item of items) {
        const labelInput = item.querySelector('.item-label-input');
        if (labelInput && labelInput.value.trim().toLowerCase() === labelName.toLowerCase()) {
          return item.querySelector('.item-amount-input');
        }
      }
      return null;
    }

    function ensureAutoExpenseItem(labelName, cssClass) {
      let amountInput = getAutoExpenseItem(labelName);
      
      if (!amountInput) {
        const container = document.getElementById('spese-items');
        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerHTML = `
          <input type="text" class="item-label-input" placeholder="Nome" value="${labelName}" readonly style="cursor:not-allowed;">
          <input type="number" class="item-amount-input ${cssClass}" placeholder="‚Ç¨" value="0" step="0.01" min="0" readonly style="cursor:not-allowed;">
          <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
        `;
        container.insertBefore(div, container.firstChild);
        amountInput = div.querySelector('.item-amount-input');
      }
      
      return amountInput;
    }

    function updateFoodTotals(){
      const monthlyBudget = parseAmount(foodBudgetInput.value) || 500;
      let monthlyTotal = 0;

      for (let week=1; week<=4; week++){
        let weekTotal = 0;
        document.querySelectorAll(`.week${week}-shopping`).forEach(i => weekTotal += parseAmount(i.value));
        monthlyTotal += weekTotal;

        const el = document.getElementById(`total-week${week}`);
        if (el) el.textContent = formatCurrency(weekTotal);
      }

      const spentEl = document.getElementById('total-food-spent');
      const remEl = document.getElementById('total-food-remaining');
      const displayBudget = document.getElementById('display-food-budget');

      if (displayBudget) displayBudget.textContent = formatCurrency(monthlyBudget);
      if (spentEl) spentEl.textContent = formatCurrency(monthlyTotal);

      if (remEl){
        const remaining = monthlyBudget - monthlyTotal;
        remEl.textContent = formatCurrency(remaining);
        remEl.classList.toggle('pos', remaining >= 0);
        remEl.classList.toggle('neg', remaining < 0);
      }

      // üî• AGGIORNA AUTOMATICAMENTE LA VOCE "Spesa alimentare" in Spese
      const foodAmountInput = ensureAutoExpenseItem('Spesa alimentare', 'food-auto-amount');
      if (foodAmountInput) {
        foodAmountInput.value = monthlyTotal.toFixed(2);
      }

      // Aggiorna totali generali
      updateBudgetTotals();
    }

    function updatePetTotals(){
      const monthlyBudget = parseAmount(petBudgetInput.value) || 200;
      let monthlyTotal = 0;

      for (let week=1; week<=4; week++){
        let weekTotal = 0;
        document.querySelectorAll(`.pet-week${week}-shopping`).forEach(i => weekTotal += parseAmount(i.value));
        monthlyTotal += weekTotal;

        const el = document.getElementById(`total-pet-week${week}`);
        if (el) el.textContent = formatCurrency(weekTotal);
      }

      const spentEl = document.getElementById('total-pet-spent');
      const remEl = document.getElementById('total-pet-remaining');
      const displayBudget = document.getElementById('display-pet-budget');

      if (displayBudget) displayBudget.textContent = formatCurrency(monthlyBudget);
      if (spentEl) spentEl.textContent = formatCurrency(monthlyTotal);

      if (remEl){
        const remaining = monthlyBudget - monthlyTotal;
        remEl.textContent = formatCurrency(remaining);
        remEl.classList.toggle('pos', remaining >= 0);
        remEl.classList.toggle('neg', remaining < 0);
      }

      // üî• AGGIORNA AUTOMATICAMENTE LA VOCE "Spese animali" in Spese
      const petAmountInput = ensureAutoExpenseItem('Spese animali', 'pet-auto-amount');
      if (petAmountInput) {
        petAmountInput.value = monthlyTotal.toFixed(2);
      }

      // Aggiorna totali generali
      updateBudgetTotals();
    }

    // ===== Pie =====
    let pieChart = null;
    function updatePieChart(){
      const canvas = document.getElementById("budgetPie");
      if (!canvas || typeof Chart === "undefined") return;

      let sumEntrate = 0;
      document.querySelectorAll('#entrate-items .item-amount-input').forEach(i => sumEntrate += parseAmount(i.value));
      let sumSpese = 0;
      document.querySelectorAll('#spese-items .item-amount-input').forEach(i => sumSpese += parseAmount(i.value));

      const has = (sumEntrate > 0 || sumSpese > 0);
      const labels = has ? ["Entrate", "Spese"] : ["Nessun dato"];
      const values = has ? [sumEntrate, sumSpese] : [1];
      const colors = has ? ["rgba(34,197,94,0.85)", "rgba(239,68,68,0.85)"] : ["rgba(156,163,175,0.35)"];

      if (!pieChart){
        pieChart = new Chart(canvas, {
          type: "doughnut",
          data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "rgba(229,231,235,.85)", boxWidth: 12, boxHeight: 12, padding: 12, font:{weight:"700"} }
              },
              tooltip: { callbacks: { label: (ctx) => ` ${ctx.label}: ${formatCurrency(ctx.parsed)}` } }
            },
            cutout: "58%"
          }
        });
      }else{
        pieChart.data.labels = labels;
        pieChart.data.datasets[0].data = values;
        pieChart.data.datasets[0].backgroundColor = colors;
        pieChart.update();
      }
    }

    function updateBudgetTotals(){
      let totalEntrate = 0;
      document.querySelectorAll('#entrate-items .item-amount-input').forEach(i => totalEntrate += parseAmount(i.value));
      let totalSpese = 0;
      document.querySelectorAll('#spese-items .item-amount-input').forEach(i => totalSpese += parseAmount(i.value));
      const balance = totalEntrate - totalSpese;

      document.getElementById('total-entrate').textContent = formatCurrency(totalEntrate);
      document.getElementById('total-spese').textContent = formatCurrency(totalSpese);

      document.getElementById('summary-entrate').textContent = formatCurrency(totalEntrate);
      document.getElementById('summary-spese').textContent = formatCurrency(totalSpese);

      const balEl = document.getElementById('summary-balance');
      balEl.textContent = formatCurrency(balance);
      balEl.classList.toggle('pos', balance >= 0);
      balEl.classList.toggle('neg', balance < 0);

      updatePieChart();
      updateSavingsGoal();
    }

    function updateSavingsGoal(){
      const goalAmount = parseAmount(savingsGoalInput.value) || 250;
      const totalIncome = parseFloat((document.getElementById('summary-entrate')?.textContent || "‚Ç¨ 0,00").replace('‚Ç¨','').replace('.', '').replace(',', '.').trim()) || 0;
      const totalExpense = parseFloat((document.getElementById('total-spese')?.textContent || "‚Ç¨ 0,00").replace('‚Ç¨','').replace('.', '').replace(',', '.').trim()) || 0;

      const savedAmount = totalIncome - totalExpense;
      let percentage = (savedAmount / goalAmount) * 100;
      percentage = Math.max(0, Math.min(100, percentage));

      document.getElementById('savings-progress-bar').style.width = percentage + "%";
      document.getElementById('progress-percentage').textContent = percentage.toFixed(0) + "%";
      document.getElementById('saved-amount').textContent = "‚Ç¨" + savedAmount.toFixed(2).replace('.', ',');
      document.getElementById('remaining-amount').textContent = "‚Ç¨" + Math.max(0, goalAmount - savedAmount).toFixed(2).replace('.', ',');
    }

    // ===== Data (include food + pets + settings) =====
    function collectCurrentData(){
      const data = {
        month: currentMonth,
        entrate: [],
        spese: [],
        spesaAlimentare: { week1:[], week2:[], week3:[], week4:[] },
        spesaAnimali: { week1:[], week2:[], week3:[], week4:[] },
        settings: {
          savingsGoal: parseAmount(savingsGoalInput.value) || 250,
          foodBudget: parseAmount(foodBudgetInput.value) || 500,
          foodWeekly: parseAmount(foodWeeklyInput.value) || 125,
          petBudget: parseAmount(petBudgetInput.value) || 200,
          petWeekly: parseAmount(petWeeklyInput.value) || 50
        },
        lastModified: new Date().toISOString()
      };

      document.querySelectorAll('#entrate-items .entry-item').forEach(item=>{
        const label = item.querySelector('.item-label-input')?.value || "";
        const amount = item.querySelector('.item-amount-input')?.value || "";
        if (label || amount) data.entrate.push({ label, amount });
      });

      document.querySelectorAll('#spese-items .entry-item').forEach(item=>{
        const label = item.querySelector('.item-label-input')?.value || "";
        const amount = item.querySelector('.item-amount-input')?.value || "";
        if (label || amount) data.spese.push({ label, amount });
      });

      for (let week=1; week<=4; week++){
        document.querySelectorAll(`.week${week}-shopping`).forEach(input=>{
          data.spesaAlimentare[`week${week}`].push(input.value || "");
        });
        document.querySelectorAll(`.pet-week${week}-shopping`).forEach(input=>{
          data.spesaAnimali[`week${week}`].push(input.value || "");
        });
      }

      return data;
    }

    async function saveMonthData(){
      const fb = window.firebaseAuth;
      if (!fb || !currentUser) return;

      try{
        isSaving = true;
        setSyncStatus("Salvataggio‚Ä¶", "rgba(245,158,11,1)");

        const data = collectCurrentData();
        const ref = fb.doc(fb.db, "users", currentUser.uid, "budgets", currentMonth);
        await fb.setDoc(ref, data, { merge:true });

        setSyncStatus("Salvato ‚úÖ", "rgba(34,197,94,1)");
      }catch(e){
        console.error("Save error:", e);
        setSyncStatus("Errore ‚ùå", "rgba(239,68,68,1)");
      }finally{
        setTimeout(()=>{ isSaving = false; }, 200);
      }
    }

    function resetUIEmpty(){
      document.getElementById('entrate-items').innerHTML = '';
      document.getElementById('spese-items').innerHTML = '';
      for (let week=1; week<=4; week++){
        document.querySelectorAll(`.week${week}-shopping`).forEach(input => input.value = '');
        document.querySelectorAll(`.pet-week${week}-shopping`).forEach(input => input.value = '');
      }
      
      // Reset settings to defaults
      savingsGoalInput.value = 250;
      foodBudgetInput.value = 500;
      foodWeeklyInput.value = 125;
      petBudgetInput.value = 200;
      petWeeklyInput.value = 50;
      
      updateBudgetTotals();
      updatePieChart();
      updateSavingsGoal();
      updateFoodTotals();
      updatePetTotals();
    }

    function populateUIFromData(data){
      const entrateContainer = document.getElementById('entrate-items');
      const speseContainer = document.getElementById('spese-items');

      entrateContainer.innerHTML = '';
      (data.entrate || []).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerHTML = `
          <input type="text" class="item-label-input" placeholder="Nome" value="${escapeAttr(item.label)}">
          <input type="number" class="item-amount-input" placeholder="‚Ç¨" value="${escapeAttr(item.amount)}" step="0.01" min="0">
          <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
        `;
        entrateContainer.appendChild(div);
      });

      speseContainer.innerHTML = '';
      (data.spese || []).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'entry-item';
        const labelLower = item.label.toLowerCase();
        const isFood = labelLower === 'spesa alimentare';
        const isPet = labelLower === 'spese animali';
        const isAuto = isFood || isPet;
        const autoClass = isFood ? 'food-auto-amount' : (isPet ? 'pet-auto-amount' : '');
        
        div.innerHTML = `
          <input type="text" class="item-label-input" placeholder="Nome" value="${escapeAttr(item.label)}" ${isAuto ? 'readonly style="cursor:not-allowed;"' : ''}>
          <input type="number" class="item-amount-input ${autoClass}" placeholder="‚Ç¨" value="${escapeAttr(item.amount)}" step="0.01" min="0" ${isAuto ? 'readonly style="cursor:not-allowed;"' : ''}>
          <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
        `;
        speseContainer.appendChild(div);
      });

      for (let week=1; week<=4; week++){
        const foodInputs = document.querySelectorAll(`.week${week}-shopping`);
        const foodData = (data.spesaAlimentare && data.spesaAlimentare[`week${week}`]) ? data.spesaAlimentare[`week${week}`] : [];
        foodInputs.forEach((input, idx)=> input.value = foodData[idx] || '');
        
        const petInputs = document.querySelectorAll(`.pet-week${week}-shopping`);
        const petData = (data.spesaAnimali && data.spesaAnimali[`week${week}`]) ? data.spesaAnimali[`week${week}`] : [];
        petInputs.forEach((input, idx)=> input.value = petData[idx] || '');
      }

      // Load settings
      if (data.settings) {
        savingsGoalInput.value = data.settings.savingsGoal || 250;
        foodBudgetInput.value = data.settings.foodBudget || 500;
        foodWeeklyInput.value = data.settings.foodWeekly || 125;
        petBudgetInput.value = data.settings.petBudget || 200;
        petWeeklyInput.value = data.settings.petWeekly || 50;
      }

      updateBudgetTotals();
      updatePieChart();
      updateSavingsGoal();
      updateFoodTotals();
      updatePetTotals();
    }

    function attachRealtimeListener(){
      const fb = window.firebaseAuth;
      if (!fb || !currentUser) return;

      if (unsubscribe){ unsubscribe(); unsubscribe = null; }
      setSyncStatus("Caricamento‚Ä¶", "rgba(245,158,11,1)");

      const ref = fb.doc(fb.db, "users", currentUser.uid, "budgets", currentMonth);
      unsubscribe = fb.onSnapshot(ref, (snap)=>{
        if (isSaving) return;
        if (snap.exists()){
          populateUIFromData(snap.data());
          setSyncStatus("Sincronizzato ‚úÖ", "rgba(34,197,94,1)");
        } else {
          resetUIEmpty();
          setSyncStatus("Vuoto ‚úÖ", "rgba(229,231,235,.85)");
        }
      }, (err)=>{
        console.error("Snapshot error:", err);
        setSyncStatus("Errore ‚ùå", "rgba(239,68,68,1)");
      });
    }

    // ===== Add/Remove =====
    function addEntryItem(type){
      const container = document.getElementById(type === 'entrate' ? 'entrate-items' : 'spese-items');
      const div = document.createElement('div');
      div.className = 'entry-item';
      div.innerHTML = `
        <input type="text" class="item-label-input" placeholder="Nome">
        <input type="number" class="item-amount-input" placeholder="‚Ç¨" step="0.01" min="0">
        <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
      `;
      container.appendChild(div);
      updateBudgetTotals();
      saveMonthData();
    }
    function removeEntry(btn){
      const row = btn.closest(".entry-item");
      if (row){
        // Check if it's an auto-generated expense (prevent deletion by warning)
        const labelInput = row.querySelector('.item-label-input');
        if (labelInput) {
          const labelLower = labelInput.value.trim().toLowerCase();
          if (labelLower === 'spesa alimentare' || labelLower === 'spese animali') {
            if (!confirm(`‚ö†Ô∏è Questa √® la voce "${labelInput.value}" auto-generata. Vuoi davvero eliminarla? (Si rigenerer√† automaticamente)`)) {
              return;
            }
          }
        }
        
        row.remove();
        updateBudgetTotals();
        updateFoodTotals();
        updatePetTotals();
        saveMonthData();
      }
    }
    window.addEntryItem = addEntryItem;
    window.removeEntry = removeEntry;

    // autosave: entrate/spese + food + pets + settings
    document.addEventListener("input", (e)=>{
      const t = e.target;
      if (!t) return;

      // Food
      if (t.classList.contains("week1-shopping") || t.classList.contains("week2-shopping") ||
          t.classList.contains("week3-shopping") || t.classList.contains("week4-shopping")){
        updateFoodTotals();
        saveMonthData();
        return;
      }

      // Pets
      if (t.classList.contains("pet-week1-shopping") || t.classList.contains("pet-week2-shopping") ||
          t.classList.contains("pet-week3-shopping") || t.classList.contains("pet-week4-shopping")){
        updatePetTotals();
        saveMonthData();
        return;
      }

      // Savings goal
      if (t.id === 'savings-goal-input') {
        updateSavingsGoal();
        saveMonthData();
        return;
      }

      // Food settings
      if (t.id === 'food-budget-input' || t.id === 'food-weekly-input') {
        updateFoodTotals();
        saveMonthData();
        return;
      }

      // Pet settings
      if (t.id === 'pet-budget-input' || t.id === 'pet-weekly-input') {
        updatePetTotals();
        saveMonthData();
        return;
      }

      // Regular entries
      if (t.classList.contains("item-label-input") || t.classList.contains("item-amount-input")){
        // Previeni modifica manuale delle voci auto
        if (t.classList.contains("food-auto-amount") || t.classList.contains("pet-auto-amount")) {
          e.preventDefault();
          return;
        }
        updateBudgetTotals();
        saveMonthData();
      }
    });

    // ===== Login/Logout (popup + redirect fallback) =====
    async function doLogin(){
      const fb = window.firebaseAuth;
      if (!fb){
        alert("Firebase non pronto. Ricarica la pagina.");
        return;
      }
      try{
        await fb.signInWithPopup(fb.auth, fb.provider);
      }catch(e){
        console.error("Popup login error:", e);
        const code = e && e.code ? e.code : "";
        if (
          code === "auth/popup-blocked" ||
          code === "auth/cancelled-popup-request" ||
          code === "auth/operation-not-supported-in-this-environment"
        ){
          await fb.signInWithRedirect(fb.auth, fb.provider);
          return;
        }
        if (code === "auth/unauthorized-domain"){
          alert("Dominio non autorizzato.\nFirebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains.");
          return;
        }
        alert("Errore login Google. Guarda Console (F12).");
      }
    }

    async function doLogout(){
      const fb = window.firebaseAuth;
      if (!fb) return;
      if (unsubscribe){ unsubscribe(); unsubscribe = null; }
      await fb.signOut(fb.auth);
    }

    loginScreenBtn.addEventListener("click", doLogin);
    loginBtnSidebar.addEventListener("click", doLogin);
    loginBtnTop.addEventListener("click", doLogin);

    logoutBtnSidebar.addEventListener("click", doLogout);
    logoutBtnTop.addEventListener("click", doLogout);

    (function waitAuth(){
      const t = setInterval(()=>{
        const fb = window.firebaseAuth;
        if (!fb) return;
        clearInterval(t);

        fb.onAuthStateChanged(fb.auth, (user)=>{
          currentUser = user || null;

          if (!currentUser){
            userInfo.textContent = "";
            logoutBtnSidebar.style.display = "none";
            logoutBtnTop.style.display = "none";
            loginBtnTop.style.display = "inline-flex";
            setSyncStatus("Login richiesto", "rgba(245,158,11,1)");
            resetUIEmpty();
            showLoginOnly();
            return;
          }

          showApp();
          userInfo.textContent = currentUser.email || "";
          logoutBtnSidebar.style.display = "block";
          logoutBtnTop.style.display = "inline-flex";
          loginBtnTop.style.display = "none";
          setSyncStatus("Pronto ‚úÖ", "rgba(229,231,235,.85)");
          attachRealtimeListener();
          setTimeout(()=>{ updatePieChart(); updateSavingsGoal(); updateFoodTotals(); updatePetTotals(); }, 120);
        });
      }, 60);
    })();

    // ===== AI CHAT =====
    (function(){
      const chatButton = document.getElementById('ai-chat-button');
      const chatBox = document.getElementById('ai-chat-box');
      const closeBtn = document.getElementById('ai-chat-close');
      const minimizeBtn = document.getElementById('ai-chat-minimize');
      const messagesEl = document.getElementById('ai-chat-messages');
      const form = document.getElementById('ai-chat-form');
      const input = document.getElementById('ai-chat-input');

      const API_URL = 'https://ai-chat-backend-vercel.vercel.app/api/ai-chat';

      function addMsg(text, who){
        const id = 'msg-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        const wrap = document.createElement('div');
        wrap.className = 'ai-msg ' + (who === 'user' ? 'ai-msg-user' : 'ai-msg-ai');
        wrap.dataset.id = id;

        const bubble = document.createElement('div');
        bubble.className = 'ai-msg-bubble';
        bubble.textContent = text;

        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return id;
      }
      function updateMsg(id, text){
        const el = messagesEl.querySelector(`[data-id="${id}"] .ai-msg-bubble`);
        if (el) el.textContent = text;
        else addMsg(text, 'ai');
      }

      function readItems(containerId){
        return [...document.querySelectorAll(`#${containerId} .entry-item`)].map(row=>{
          const label = row.querySelector(".item-label-input")?.value?.trim() || "";
          const amount = row.querySelector(".item-amount-input")?.value || "";
          return { label, amount };
        }).filter(x => x.label || x.amount);
      }
      function getText(id){ return document.getElementById(id)?.textContent?.trim() || ""; }

      chatButton.addEventListener('click', ()=>{
        if (window.__orbDragging) return;
        if (!currentUser){
          alert("Devi fare login prima di usare l'assistente AI.");
          return;
        }
        chatBox.classList.remove('hidden');
        input.focus();
        if (!messagesEl.dataset.started){
          addMsg("Ciao! Come posso aiutarti con il budget?", 'ai');
          messagesEl.dataset.started = 'true';
        }
      });

      closeBtn.addEventListener('click', ()=>{
        chatBox.classList.add('hidden');
        messagesEl.innerHTML = '';
        delete messagesEl.dataset.started;
      });

      minimizeBtn.addEventListener('click', ()=>{
        chatBox.classList.add('hidden');
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!currentUser){
          addMsg("Devi fare login.", "ai");
          return;
        }

        const q = input.value.trim();
        if (!q) return;

        addMsg(q, 'user');
        input.value = '';

        const typingId = addMsg("Sto analizzando‚Ä¶", 'ai');

        const budgetContext = {
          month: localStorage.getItem("budgetMonth") || "",
          summary: {
            entrate: getText("summary-entrate"),
            spese: getText("summary-spese"),
            risparmio: getText("summary-balance")
          },
          entrate_items: readItems("entrate-items"),
          spese_items: readItems("spese-items"),
          food: {
            week1: [...document.querySelectorAll(".week1-shopping")].map(i=>i.value||""),
            week2: [...document.querySelectorAll(".week2-shopping")].map(i=>i.value||""),
            week3: [...document.querySelectorAll(".week3-shopping")].map(i=>i.value||""),
            week4: [...document.querySelectorAll(".week4-shopping")].map(i=>i.value||"")
          },
          pets: {
            week1: [...document.querySelectorAll(".pet-week1-shopping")].map(i=>i.value||""),
            week2: [...document.querySelectorAll(".pet-week2-shopping")].map(i=>i.value||""),
            week3: [...document.querySelectorAll(".pet-week3-shopping")].map(i=>i.value||""),
            week4: [...document.querySelectorAll(".pet-week4-shopping")].map(i=>i.value||"")
          },
          settings: {
            savingsGoal: savingsGoalInput.value,
            foodBudget: foodBudgetInput.value,
            foodWeekly: foodWeeklyInput.value,
            petBudget: petBudgetInput.value,
            petWeekly: petWeeklyInput.value
          }
        };

        try{
          const idToken = await currentUser.getIdToken(true);

          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + idToken },
            body: JSON.stringify({ question: q, budget: budgetContext, month: budgetContext.month })
          });

          if (!res.ok){
            const t = await res.text().catch(()=> "");
            updateMsg(typingId, `Errore AI (HTTP ${res.status}).\n${t.slice(0,220)}`);
            return;
          }

          const data = await res.json().catch(()=> ({}));
          updateMsg(typingId, data.answer || "Nessuna risposta.");
        }catch(err){
          console.error(err);
          updateMsg(typingId, "Errore nel contattare l'AI.");
        }
      });
    })();

    // ===== ORB DRAG =====
    (function(){
      const widget = document.getElementById('ai-chat-widget');
      const btn = document.getElementById('ai-chat-button');
      if(!widget || !btn) return;

      window.__orbDragging = false;

      let isDragging = false;
      let moved = false;
      let offsetX = 0, offsetY = 0;

      function setDefault(){
        widget.style.left = 'auto';
        widget.style.top = 'auto';
        widget.style.right = '16px';
        widget.style.bottom = 'calc(78px + env(safe-area-inset-bottom, 0px))';
      }

      function restoreSessionPos(){
        const raw = sessionStorage.getItem('aiWidgetPosSession');
        if(!raw) return false;
        try{
          const p = JSON.parse(raw);
          if(!p || !p.left || !p.top) return false;
          widget.style.left = p.left;
          widget.style.top  = p.top;
          widget.style.right = 'auto';
          widget.style.bottom = 'auto';
          return true;
        }catch(e){
          return false;
        }
      }

      function saveSessionPos(){
        const rect = widget.getBoundingClientRect();
        sessionStorage.setItem('aiWidgetPosSession', JSON.stringify({
          left: rect.left + 'px',
          top: rect.top + 'px'
        }));
      }

      if(!restoreSessionPos()) setDefault();

      function pointFromEvent(e){
        return (e.touches && e.touches[0]) ? e.touches[0] : e;
      }

      function startDrag(e){
        if (e.button !== undefined && e.button !== 0) return;

        const p = pointFromEvent(e);
        const rect = widget.getBoundingClientRect();
        offsetX = p.clientX - rect.left;
        offsetY = p.clientY - rect.top;

        isDragging = true;
        moved = false;
        window.__orbDragging = false;

        const img = widget.querySelector('img');
        if (img) img.style.animation = 'none';
      }

      function onMove(e){
        if(!isDragging) return;

        if(!moved){
          moved = true;
          window.__orbDragging = true;
        }
        if (e.cancelable) e.preventDefault();

        const p = pointFromEvent(e);
        const w = widget.offsetWidth;
        const h = widget.offsetHeight;

        let x = p.clientX - offsetX;
        let y = p.clientY - offsetY;

        x = Math.max(8, Math.min(window.innerWidth - w - 8, x));
        y = Math.max(8, Math.min(window.innerHeight - h - 8, y));

        widget.style.left = x + 'px';
        widget.style.top  = y + 'px';
        widget.style.right = 'auto';
        widget.style.bottom = 'auto';
      }

      function endDrag(){
        if(!isDragging) return;
        isDragging = false;

        const img = widget.querySelector('img');
        if (img) img.style.animation = '';

        if(!moved){
          window.__orbDragging = false;
          return;
        }

        saveSessionPos();
        setTimeout(()=>{ window.__orbDragging = false; moved = false; }, 80);
      }

      btn.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', endDrag);

      btn.addEventListener('touchstart', startDrag, { passive:false });
      document.addEventListener('touchmove', onMove, { passive:false });
      document.addEventListener('touchend', endDrag, { passive:true });
      document.addEventListener('touchcancel', endDrag, { passive:true });

      btn.addEventListener('click', (e)=>{
        if(window.__orbDragging){
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);

      window.addEventListener('orientationchange', ()=>{
        setTimeout(()=>{
          restoreSessionPos();
          const r = widget.getBoundingClientRect();
          if (r.right > window.innerWidth || r.bottom > window.innerHeight || r.left < 0 || r.top < 0){
            setDefault();
            sessionStorage.removeItem('aiWidgetPosSession');
          } else {
            saveSessionPos();
          }
        }, 150);
      });
    })();
  </script>
</body>
</html>
