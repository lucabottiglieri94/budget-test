<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#764ba2" />
  <title>Budget Mensile - Web App</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --primary:#2196F3;
      --success:#4CAF50;
      --danger:#F44336;
      --warning:#FF9800;
      --light:#f5f5f5;
      --dark:#111827;
      --border:#e5e7eb;

      --radius:16px;
      --shadow:0 14px 40px rgba(0,0,0,.18);

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html, body{height:100%}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color: var(--dark);
    }

    /* ===== LOGIN SCREEN ===== */
    #login-screen{
      position: fixed;
      inset: 0;
      z-index: 999999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(16px + var(--safe-top)) calc(16px + var(--safe-left)) calc(16px + var(--safe-bottom)) calc(16px + var(--safe-right));
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    #login-card{
      width: min(560px, 94vw);
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.28);
      backdrop-filter: blur(10px);
      padding: 22px 18px;
      color: #fff;
      text-align:center;
    }
    #login-card h1{font-size: clamp(26px, 5vw, 36px); font-weight: 900; margin-bottom: 8px;}
    #login-card p{opacity:.95; font-weight:700; margin-bottom: 16px; line-height:1.35}
    #login-screen-btn{
      width:100%;
      padding: 14px 16px;
      border: none;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      background:#fff;
      color:#111827;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
    }
    #login-screen small{display:block;margin-top:10px;font-size:12px;opacity:.9}

    /* ===== APP ===== */
    #app{display:none; min-height:100vh;}
    .container{
      min-height:100vh;
      background:#fff;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 1000;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff;
      padding:
        calc(16px + var(--safe-top))
        calc(14px + var(--safe-left))
        12px
        calc(14px + var(--safe-right));
      box-shadow: 0 10px 26px rgba(0,0,0,0.18);
    }
    header .title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    header h1{
      font-size: clamp(20px, 5vw, 28px);
      font-weight: 900;
      line-height: 1.1;
    }
    header p{
      margin-top: 6px;
      font-size: 13px;
      opacity: .95;
      font-weight: 600;
      line-height: 1.3;
    }

    .header-controls{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    #month-selector{
      flex: 1;
      min-width: 210px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.45);
      background: rgba(255,255,255,0.92);
      color: #111827;
      font-size: 15px;
      font-weight: 800;
      outline:none;
    }

    .auth-row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:none;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      box-shadow: 0 10px 22px rgba(0,0,0,0.16);
      transition: transform .08s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .btn.white{background:#fff;color:#111827}
    .btn.red{background:#ff5b5b;color:#fff}
    .btn.ghost{background:rgba(255,255,255,0.18);color:#fff;border:1px solid rgba(255,255,255,0.25);box-shadow:none}

    #sync-status{
      margin-top: 10px;
      font-size: 12px;
      opacity: .95;
      font-weight: 800;
    }
    #user-info{
      font-size: 12px;
      opacity: .95;
      font-weight: 800;
      max-width: 55vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .content{
      flex: 1;
      padding: 14px;
      padding-bottom: calc(120px + var(--safe-bottom));
      display:flex;
      flex-direction:column;
      gap: 14px;
      background:#fff;
    }

    .section{
      background: var(--light);
      border-radius: var(--radius);
      padding: 16px;
      border-left: 5px solid var(--primary);
    }
    .section.entrate{border-left-color: var(--success)}
    .section.spese{border-left-color: var(--danger)}
    .section h2{
      font-size: 16px;
      font-weight: 900;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .entry-items{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
    .entry-item{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .item-label-input, .item-amount-input{
      border:1px solid;
      border-radius: 12px;
      padding: 10px;
      font-size: 16px; /* NO zoom iPhone */
      font-weight: 800;
      outline:none;
    }
    .item-label-input{flex:1; min-width: 0}
    .item-amount-input{width: 110px; text-align:right}

    .entrata-input{border-color: rgba(76,175,80,.55)}
    .spesa-input{border-color: rgba(244,67,54,.55)}
    .entrata-input:focus{border-color: var(--success); box-shadow:0 0 0 3px rgba(76,175,80,.18)}
    .spesa-input:focus{border-color: var(--danger); box-shadow:0 0 0 3px rgba(244,67,54,.18)}

    .btn-remove{
      background: var(--danger);
      color:#fff;
      border:none;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      flex-shrink:0;
    }

    .btn-add{
      width:100%;
      padding: 12px;
      border:none;
      border-radius: 14px;
      font-weight: 900;
      color:#fff;
      cursor:pointer;
    }
    .btn-add-entrate{background: var(--success)}
    .btn-add-spese{background: var(--danger)}

    .total-row{
      background:#fff;
      border:2px solid rgba(33,150,243,.4);
      border-radius: 14px;
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight: 900;
      gap:12px;
    }
    .total-amount.entrata{color: var(--success)}
    .total-amount.spesa{color: var(--danger)}

    .summary{
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      border-radius: var(--radius);
      padding: 14px;
      color:#fff;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .summary-card{
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      padding: 12px;
      text-align:center;
      backdrop-filter: blur(8px);
    }
    .summary-label{font-size: 11px; letter-spacing:.6px; text-transform:uppercase; font-weight:900; opacity:.95; margin-bottom:6px}
    .summary-value{font-size: 18px; font-weight: 900}
    .balance-positive{color:#7CFF9C}
    .balance-negative{color:#FFB4B4}

    .pie-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.06);
    }
    .pie-wrap{position:relative; height: 280px}

    .goal-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 24px rgba(0,0,0,0.06);
    }
    .goal-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .goal-label{font-weight:900;color:#374151}
    .goal-amount{font-weight: 900; color: var(--primary); font-size: 18px}

    .progress-bar-container{
      width:100%;
      height: 38px;
      background:#f0f0f0;
      border-radius: 999px;
      overflow:hidden;
      position:relative;
      margin-bottom: 10px;
    }
    .progress-bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--success), #45a049);
      border-radius: 999px;
      transition: width .18s linear;
    }
    .progress-text{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight: 900;
      text-shadow:0 2px 10px rgba(0,0,0,0.35);
    }
    .goal-footer{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      font-weight: 800; color:#4b5563; font-size: 13px;
    }

    .week-card{
      background:#fff;
      border-radius: 14px;
      border:2px solid var(--warning);
      padding: 14px;
    }
    .week-title{
      font-weight: 900;
      color: var(--warning);
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--warning);
    }
    .week-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom: 10px;
    }
    .week-grid label{
      display:block;
      font-size: 12px;
      color:#6b7280;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .week-grid input{
      width:100%;
      border-color: rgba(255,152,0,.55);
    }

    /* Floating buttons */
    #risparmi-btn, #comparatori-btn{
      position: fixed;
      bottom: calc(16px + var(--safe-bottom));
      padding: 12px 14px;
      border-radius: 999px;
      border: none;
      color:#fff;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,0.22);
      z-index: 1500;
    }
    #risparmi-btn{left: calc(16px + var(--safe-left)); background: #ff9800;}
    #comparatori-btn{right: calc(16px + var(--safe-right)); background: var(--success);}

    /* AI Chat */
    #ai-chat-widget{
      position: fixed;
      bottom: calc(82px + var(--safe-bottom));
      right: calc(16px + var(--safe-right));
      z-index: 9999;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    #ai-chat-button{
      width: 62px; height: 62px;
      border-radius: 50%;
      border: none;
      background: transparent;
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
      cursor:pointer;
      padding:0;
      overflow:hidden;
    }
    #ai-chat-button img{width:100%; height:100%; object-fit:cover; display:block}

    #ai-chat-box{
      position:absolute;
      bottom: 74px;
      right: 0;
      width: min(360px, calc(100vw - 28px));
      max-height: min(520px, 70vh);
      background:#fff;
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.30);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #ai-chat-box.hidden{display:none}

    .ai-chat-header{
      display:flex; align-items:center; justify-content:space-between;
      background:#111827; color:#f9fafb;
      padding: 10px 10px;
    }
    .ai-chat-title{font-weight: 900; font-size: 14px}
    .ai-chat-actions button{
      background:transparent;border:none;color:#e5e7eb;
      font-size:18px; cursor:pointer; line-height:1; padding: 6px 8px;
    }
    #ai-chat-messages{
      padding: 10px;
      overflow-y:auto;
      flex:1;
      background:#f3f4f6;
      font-size: 13px;
    }
    .ai-msg{display:flex; margin-bottom:8px}
    .ai-msg-user{justify-content:flex-end}
    .ai-msg-ai{justify-content:flex-start}
    .ai-msg-bubble{
      max-width: 86%;
      padding: 9px 10px;
      border-radius: 12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      font-weight:700;
    }
    .ai-msg-user .ai-msg-bubble{background:#2563eb;color:#fff;border-bottom-right-radius:3px}
    .ai-msg-ai .ai-msg-bubble{background:#e5e7eb;color:#111827;border-bottom-left-radius:3px}

    #ai-chat-form{display:flex;border-top:1px solid #e5e7eb}
    #ai-chat-input{
      flex:1;border:none;padding: 12px 10px;
      font-size: 16px; /* NO zoom iPhone */
      outline:none;
    }
    #ai-chat-form button{
      border:none;background:#2563eb;color:#fff;
      padding: 0 14px; font-weight: 900; cursor:pointer;
    }
    #ai-chat-box.minimized #ai-chat-messages,
    #ai-chat-box.minimized #ai-chat-form{display:none}

    /* keyboard helper */
    body.kbd-open #risparmi-btn,
    body.kbd-open #comparatori-btn{
      bottom: calc(230px + var(--safe-bottom));
    }
    body.kbd-open #ai-chat-widget{
      bottom: calc(300px + var(--safe-bottom));
    }

    @media (max-width: 420px){
      .summary{grid-template-columns: 1fr}
      .item-amount-input{width: 98px}
      #month-selector{min-width: 0; width:100%}
      .header-controls{flex-direction:column; align-items:stretch}
      .auth-row{justify-content:flex-start}
      #user-info{max-width: 90vw}
    }
  </style>
</head>

<body>

  <!-- LOGIN SCREEN -->
  <div id="login-screen">
    <div id="login-card">
      <h1>üí∞ Budget Mensile</h1>
      <p>Accedi con Google per vedere e salvare <b>solo i tuoi dati</b>.</p>
      <button id="login-screen-btn" type="button">Accedi con Google</button>
      <small>Ogni account vede solo i propri dati.</small>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <div class="container">

      <header>
        <div class="title">
          <div>
            <h1>üí∞ Budget Mensile</h1>
            <p>Gestione entrate e spese (sincronizzato)</p>
          </div>
          <div id="sync-status">üîÑ Stato sincronizzazione: <span id="sync-label">In attesa...</span></div>
        </div>

        <div class="header-controls">
          <select id="month-selector"></select>

          <div class="auth-row">
            <button id="login-btn" class="btn white" type="button">Accedi Google</button>
            <button id="logout-btn" class="btn red" style="display:none;" type="button">Esci</button>
            <span id="user-info"></span>
          </div>
        </div>
      </header>

      <div class="content">

        <button id="risparmi-btn" type="button" onclick="location.href='risparmi.html'">üìà Grafico Risparmi</button>
        <button id="comparatori-btn" type="button" onclick="location.href='comparatori.html'">üìä Comparatori</button>

        <!-- ENTRATE -->
        <div class="section entrate">
          <h2>üì• Entrate</h2>
          <div class="entry-items" id="entrate-items"></div>
          <button class="btn-add btn-add-entrate" type="button" onclick="addEntryItem('entrate')">+ Aggiungi Entrata</button>
          <div class="total-row">
            <span>Totale Entrate</span>
            <span class="total-amount entrata" id="total-entrate">‚Ç¨ 0,00</span>
          </div>
        </div>

        <!-- SPESE -->
        <div class="section spese">
          <h2>üì§ Spese</h2>
          <div class="entry-items" id="spese-items"></div>
          <button class="btn-add btn-add-spese" type="button" onclick="addEntryItem('spese')">+ Aggiungi Spesa</button>
          <div class="total-row">
            <span>Totale Spese</span>
            <span class="total-amount spesa" id="total-spese">‚Ç¨ 0,00</span>
          </div>
        </div>

        <!-- RIEPILOGO -->
        <div class="summary">
          <div class="summary-card">
            <div class="summary-label">Entrate</div>
            <div class="summary-value" style="color:#7CFF9C" id="summary-entrate">‚Ç¨ 0,00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Spese</div>
            <div class="summary-value" style="color:#FFB4B4" id="summary-spese">‚Ç¨ 0,00</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Risparmio</div>
            <div class="summary-value balance-positive" id="summary-balance">‚Ç¨ 0,00</div>
          </div>
        </div>

        <!-- GRAFICO A TORTA -->
        <div class="section" style="border-left-color:var(--primary);">
          <h2>ü•ß Ripartizione Entrate / Spese</h2>
          <div class="pie-card">
            <div class="pie-wrap">
              <canvas id="budgetPie"></canvas>
            </div>
            <div style="margin-top:10px;color:#6b7280;font-size:13px;font-weight:900;">
              Si aggiorna automaticamente quando modifichi le voci.
            </div>
          </div>
        </div>

        <!-- OBIETTIVO -->
        <div class="section savings-goal">
          <h2>üí∞ Obiettivo di Risparmio</h2>
          <div class="goal-card">
            <div class="goal-header">
              <span class="goal-label">Obiettivo mensile:</span>
              <span class="goal-amount">‚Ç¨250,00</span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar" id="savings-progress-bar"></div>
              <div class="progress-text" id="progress-percentage">0%</div>
            </div>
            <div class="goal-footer">
              <span>Risparmiato: <strong id="saved-amount">‚Ç¨0,00</strong></span>
              <span>Mancano: <strong id="remaining-amount">‚Ç¨250,00</strong></span>
            </div>
          </div>
        </div>

        <!-- SPESA ALIMENTARE -->
        <div class="section" style="border-left-color: var(--warning);">
          <h2>üõí Spese Alimentari Settimanali</h2>
          <p style="color:#6b7280;font-size:13px;font-weight:900;margin-bottom:12px;">
            Budget: <strong>‚Ç¨500/mese (‚Ç¨125/settimana)</strong>
          </p>

          <div id="weeks-container" style="display:flex;flex-direction:column;gap:12px;">
            <div class="week-card">
              <div class="week-title">üìÖ Settimana 1</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week1-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
              </div>
              <div class="total-row" style="border-color: var(--warning);">
                <span>Totale Settimana:</span>
                <div style="display:flex;gap:10px;align-items:center;">
                  <span id="total-week1" style="color:var(--warning);font-weight:900;">‚Ç¨ 0,00</span>
                  <span id="status-week1" style="font-size:12px;padding:6px 10px;border-radius:999px;background:#E8F5E9;color:#2E7D32;font-weight:900;">‚úì OK</span>
                </div>
              </div>
            </div>

            <div class="week-card">
              <div class="week-title">üìÖ Settimana 2</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week2-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
              </div>
              <div class="total-row" style="border-color: var(--warning);">
                <span>Totale Settimana:</span>
                <div style="display:flex;gap:10px;align-items:center;">
                  <span id="total-week2" style="color:var(--warning);font-weight:900;">‚Ç¨ 0,00</span>
                  <span id="status-week2" style="font-size:12px;padding:6px 10px;border-radius:999px;background:#E8F5E9;color:#2E7D32;font-weight:900;">‚úì OK</span>
                </div>
              </div>
            </div>

            <div class="week-card">
              <div class="week-title">üìÖ Settimana 3</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week3-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
              </div>
              <div class="total-row" style="border-color: var(--warning);">
                <span>Totale Settimana:</span>
                <div style="display:flex;gap:10px;align-items:center;">
                  <span id="total-week3" style="color:var(--warning);font-weight:900;">‚Ç¨ 0,00</span>
                  <span id="status-week3" style="font-size:12px;padding:6px 10px;border-radius:999px;background:#E8F5E9;color:#2E7D32;font-weight:900;">‚úì OK</span>
                </div>
              </div>
            </div>

            <div class="week-card">
              <div class="week-title">üìÖ Settimana 4</div>
              <div class="week-grid">
                <div><label>Spesa 1</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 2</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 3</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
                <div><label>Spesa 4</label><input type="number" class="item-amount-input week4-shopping" placeholder="‚Ç¨" step="0.01" min="0" onchange="updateFoodTotals(); saveMonthData()" oninput="updateFoodTotals()"></div>
              </div>
              <div class="total-row" style="border-color: var(--warning);">
                <span>Totale Settimana:</span>
                <div style="display:flex;gap:10px;align-items:center;">
                  <span id="total-week4" style="color:var(--warning);font-weight:900;">‚Ç¨ 0,00</span>
                  <span id="status-week4" style="font-size:12px;padding:6px 10px;border-radius:999px;background:#E8F5E9;color:#2E7D32;font-weight:900;">‚úì OK</span>
                </div>
              </div>
            </div>
          </div>

          <div class="summary" style="margin-top: 12px;">
            <div class="summary-card">
              <div class="summary-label">Budget</div>
              <div class="summary-value">‚Ç¨ 500</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Speso</div>
              <div class="summary-value" id="total-food-spent">‚Ç¨ 0,00</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Rimasto</div>
              <div class="summary-value balance-positive" id="total-food-remaining">‚Ç¨ 500,00</div>
            </div>
          </div>
        </div>

        <!-- AI CHAT WIDGET -->
        <div id="ai-chat-widget">
          <button id="ai-chat-button" aria-label="Apri chat AI" type="button">
            <img src="https://image2url.com/r2/default/images/1770371281075-bf035a1c-704a-476c-a3c3-fa76d3b13bc5.png" alt="AI">
          </button>

          <div id="ai-chat-box" class="hidden">
            <div class="ai-chat-header">
              <div class="ai-chat-title">Assistente AI</div>
              <div class="ai-chat-actions">
                <button id="ai-chat-minimize" title="Minimizza" type="button">‚àí</button>
                <button id="ai-chat-close" title="Chiudi" type="button">√ó</button>
              </div>
            </div>

            <div id="ai-chat-messages"></div>

            <form id="ai-chat-form">
              <input id="ai-chat-input" type="text" placeholder="Chiedimi sul tuo budget‚Ä¶" autocomplete="off" />
              <button type="submit">Invia</button>
            </form>
          </div>
        </div>

      </div><!-- content -->
    </div><!-- container -->
  </div><!-- app -->

  <!-- Firebase + Firestore + Auth (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider,
      signInWithPopup, signOut, setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
      authDomain: "budget-luca.firebaseapp.com",
      projectId: "budget-luca",
      storageBucket: "budget-luca.firebasestorage.app",
      messagingSenderId: "67496424698",
      appId: "1:67496424698:web:b1822e04ef4efc07408543",
      measurementId: "G-7LEYRZE9QN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // session-only (non resta loggato per sempre)
    await setPersistence(auth, browserSessionPersistence);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" }); // scegli account ogni volta

    // expose per script non-module
    window._db = db;
    window._doc = doc;
    window._setDoc = setDoc;
    window._onSnapshot = onSnapshot;

    window._auth = auth;
    window._provider = provider;
    window._signInWithPopup = signInWithPopup;
    window._signOut = signOut;
    window._onAuthStateChanged = onAuthStateChanged;

    window._firebaseReady = true;
    console.log("‚úÖ Firebase pronto");
  </script>

  <script>
    /* ====== Mobile keyboard helper ====== */
    document.addEventListener("focusin", (e) => {
      const t = e.target;
      if (t && (t.tagName === "INPUT" || t.tagName === "TEXTAREA")) document.body.classList.add("kbd-open");
    });
    document.addEventListener("focusout", () => {
      setTimeout(() => document.body.classList.remove("kbd-open"), 120);
    });

    /* ====== MONTH OPTIONS (auto fino a +11 mesi) ====== */
    function pad2(n){ return String(n).padStart(2,"0"); }
    function monthLabel(y,m){
      const mesi = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
      return `${mesi[m-1]} ${y}`;
    }
    function buildMonthOptions(selectEl){
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const count = 12; // mostra 12 mesi
      const opts = [];
      for(let i=0;i<count;i++){
        const d = new Date(start.getFullYear(), start.getMonth()+i, 1);
        const y = d.getFullYear();
        const m = d.getMonth()+1;
        const val = `${y}-${pad2(m)}`;
        opts.push({ val, text: monthLabel(y,m) });
      }
      selectEl.innerHTML = opts.map(o=>`<option value="${o.val}">${o.text}</option>`).join("");
    }

    /* ===== STATE ===== */
    let currentMonth = localStorage.getItem("budgetMonth") || "";
    let isSaving = false;
    let unsubscribe = null;
    let currentUser = null;
    let syncLabel = null;

    const loginScreen = document.getElementById("login-screen");
    const loginScreenBtn = document.getElementById("login-screen-btn");
    const appEl = document.getElementById("app");

    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const userInfo = document.getElementById("user-info");
    const monthSelector = document.getElementById("month-selector");

    buildMonthOptions(monthSelector);

    if (!currentMonth){
      currentMonth = monthSelector.value;
      localStorage.setItem("budgetMonth", currentMonth);
    } else {
      monthSelector.value = currentMonth;
      if (monthSelector.value !== currentMonth){
        // se l'utente aveva un mese vecchio non pi√π in lista, lo rimettiamo
        const opt = document.createElement("option");
        opt.value = currentMonth;
        opt.textContent = currentMonth;
        monthSelector.prepend(opt);
        monthSelector.value = currentMonth;
      }
    }

    function setSyncStatus(text, color="#fff"){
      if (!syncLabel) syncLabel = document.getElementById("sync-label");
      if (syncLabel){
        syncLabel.textContent = text;
        syncLabel.style.color = color;
      }
    }
    function showLoginOnly(){ loginScreen.style.display = "flex"; appEl.style.display = "none"; }
    function showApp(){ loginScreen.style.display = "none"; appEl.style.display = "block"; }

    async function doLogin(){
      if (!window._firebaseReady || !window._auth || !window._provider || !window._signInWithPopup){
        alert("Sto caricando Firebase‚Ä¶ riprova tra 1 secondo.");
        return;
      }
      try{
        await window._signInWithPopup(window._auth, window._provider);
      }catch(e){
        console.error("Login error:", e);
        alert("Login Google non riuscito.\n‚Ä¢ controlla popup bloccati\n‚Ä¢ controlla console (F12)");
      }
    }

    async function doLogout(){
      try{
        if (unsubscribe){ unsubscribe(); unsubscribe = null; }
        await window._signOut(window._auth);

        currentUser = null;
        userInfo.textContent = "";
        logoutBtn.style.display = "none";
        setSyncStatus("Login richiesto", "#ffc107");

        resetUIEmpty();
        showLoginOnly();
      }catch(e){
        console.error("Logout error:", e);
        alert("Logout non riuscito.");
      }
    }

    loginScreenBtn.addEventListener("click", doLogin);
    loginBtn.addEventListener("click", doLogin);
    logoutBtn.addEventListener("click", doLogout);

    monthSelector.addEventListener("change", ()=>{
      currentMonth = monthSelector.value;
      localStorage.setItem("budgetMonth", currentMonth);
      attachRealtimeListener();
    });

    /* ===== PIE CHART ===== */
    let pieChart = null;

    function euro(v){
      return "‚Ç¨ " + (Number(v || 0)).toFixed(2).replace(".", ",");
    }
    function parseAmount(x){
      return parseFloat((x ?? "").toString().replace(",", ".")) || 0;
    }

    function updatePieChart(){
      const canvas = document.getElementById("budgetPie");
      if (!canvas || typeof Chart === "undefined") return;

      let sumEntrate = 0;
      document.querySelectorAll('#entrate-items .item-amount-input').forEach(i => sumEntrate += parseAmount(i.value));

      let sumSpese = 0;
      document.querySelectorAll('#spese-items .item-amount-input').forEach(i => sumSpese += parseAmount(i.value));

      const has = (sumEntrate > 0 || sumSpese > 0);
      const labels = has ? ["Entrate", "Spese"] : ["Nessun dato"];
      const values = has ? [sumEntrate, sumSpese] : [1];
      const colors = has ? ["rgba(76,175,80,0.86)", "rgba(244,67,54,0.86)"] : ["rgba(156,163,175,0.35)"];

      if (!pieChart){
        pieChart = new Chart(canvas, {
          type: "doughnut",
          data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
              legend: { position: "bottom", labels: { boxWidth: 12, boxHeight: 12, padding: 12 } },
              tooltip: { callbacks: { label: (ctx) => ` ${ctx.label}: ${euro(ctx.parsed)}` } }
            },
            cutout: "55%"
          }
        });
      }else{
        pieChart.data.labels = labels;
        pieChart.data.datasets[0].data = values;
        pieChart.data.datasets[0].backgroundColor = colors;
        pieChart.update();
      }
    }

    /* ===== DATA ===== */
    function escapeAttr(s){
      return (s ?? "").toString().replaceAll('"','&quot;');
    }

    function collectCurrentData(){
      const data = {
        month: currentMonth,
        entrate: [],
        spese: [],
        spesaAlimentare: { week1:[], week2:[], week3:[], week4:[] },
        lastModified: new Date().toISOString()
      };

      document.querySelectorAll('#entrate-items .entry-item').forEach(item=>{
        const label = item.querySelector('.item-label-input')?.value || "";
        const amount = item.querySelector('.item-amount-input')?.value || "";
        if (label || amount) data.entrate.push({ label, amount });
      });

      document.querySelectorAll('#spese-items .entry-item').forEach(item=>{
        const label = item.querySelector('.item-label-input')?.value || "";
        const amount = item.querySelector('.item-amount-input')?.value || "";
        if (label || amount) data.spese.push({ label, amount });
      });

      for (let week=1; week<=4; week++){
        document.querySelectorAll(`.week${week}-shopping`).forEach(input=>{
          data.spesaAlimentare[`week${week}`].push(input.value || "");
        });
      }

      return data;
    }

    async function saveMonthData(){
      if (!window._firebaseReady || !window._db || !currentUser) return;
      try{
        isSaving = true;
        setSyncStatus("Salvataggio‚Ä¶", "#ffeb3b");

        const data = collectCurrentData();
        // ‚úÖ per-utente:
        // users/{uid}/budgets/{YYYY-MM}
        const ref = window._doc(window._db, "users", currentUser.uid, "budgets", currentMonth);
        await window._setDoc(ref, data, { merge:true });

        setSyncStatus("Salvato ‚úÖ", "#8bc34a");
      }catch(e){
        console.error("Save error:", e);
        setSyncStatus("Errore ‚ùå", "#ff5252");
      }finally{
        setTimeout(()=>{ isSaving = false; }, 250);
      }
    }

    function resetUIEmpty(){
      document.getElementById('entrate-items').innerHTML = '';
      document.getElementById('spese-items').innerHTML = '';
      for (let week=1; week<=4; week++){
        document.querySelectorAll(`.week${week}-shopping`).forEach(input => input.value = '');
      }
      updateBudgetTotals();
      updateFoodTotals();
      setTimeout(updateSavingsGoal, 120);
      updatePieChart();
    }

    function populateUIFromData(data){
      const entrateContainer = document.getElementById('entrate-items');
      const speseContainer = document.getElementById('spese-items');

      entrateContainer.innerHTML = '';
      (data.entrate || []).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerHTML = `
          <input type="text" class="item-label-input entrata-input" placeholder="Nome" value="${escapeAttr(item.label)}"
                 onchange="updateBudgetTotals(); saveMonthData()" oninput="updateBudgetTotals()">
          <input type="number" class="item-amount-input entrata-input" placeholder="‚Ç¨" value="${escapeAttr(item.amount)}"
                 step="0.01" min="0" onchange="updateBudgetTotals(); saveMonthData()" oninput="updateBudgetTotals()">
          <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
        `;
        entrateContainer.appendChild(div);
      });

      speseContainer.innerHTML = '';
      (data.spese || []).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerHTML = `
          <input type="text" class="item-label-input spesa-input" placeholder="Nome" value="${escapeAttr(item.label)}"
                 onchange="updateBudgetTotals(); saveMonthData()" oninput="updateBudgetTotals()">
          <input type="number" class="item-amount-input spesa-input" placeholder="‚Ç¨" value="${escapeAttr(item.amount)}"
                 step="0.01" min="0" onchange="updateBudgetTotals(); saveMonthData()" oninput="updateBudgetTotals()">
          <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
        `;
        speseContainer.appendChild(div);
      });

      for (let week=1; week<=4; week++){
        const inputs = document.querySelectorAll(`.week${week}-shopping`);
        const weekData = (data.spesaAlimentare && data.spesaAlimentare[`week${week}`]) ? data.spesaAlimentare[`week${week}`] : [];
        inputs.forEach((input, idx)=> input.value = weekData[idx] || '');
      }

      updateBudgetTotals();
      updateFoodTotals();
      setTimeout(updateSavingsGoal, 120);
      updatePieChart();
    }

    function attachRealtimeListener(){
      if (!window._firebaseReady || !window._db || !currentUser) return;
      if (unsubscribe){ unsubscribe(); unsubscribe = null; }

      setSyncStatus("Caricamento‚Ä¶", "#ffeb3b");

      const ref = window._doc(window._db, "users", currentUser.uid, "budgets", currentMonth);

      unsubscribe = window._onSnapshot(ref, (snap)=>{
        if (isSaving) return;

        if (snap.exists()){
          populateUIFromData(snap.data());
          setSyncStatus("Sincronizzato ‚úÖ", "#8bc34a");
        } else {
          resetUIEmpty();
          setSyncStatus("Vuoto ‚úÖ", "#ffffff");
        }
      }, (err)=>{
        console.error("Snapshot error:", err);
        setSyncStatus("Errore ‚ùå", "#ff5252");
      });
    }

    function addEntryItem(type){
      const container = document.getElementById(type === 'entrate' ? 'entrate-items' : 'spese-items');
      const div = document.createElement('div');
      div.className = 'entry-item';
      const cls = type === 'entrate' ? 'entrata-input' : 'spesa-input';
      div.innerHTML = `
        <input type="text" class="item-label-input ${cls}" placeholder="Nome"
               onchange="updateBudgetTotals(); saveMonthData()" oninput="updateBudgetTotals()">
        <input type="number" class="item-amount-input ${cls}" placeholder="‚Ç¨" step="0.01" min="0"
               onchange="updateBudgetTotals(); saveMonthData()" oninput="updateBudgetTotals()">
        <button class="btn-remove" type="button" onclick="removeEntry(this)">‚úï</button>
      `;
      container.appendChild(div);
      updateBudgetTotals();
      updatePieChart();
      setTimeout(updateSavingsGoal, 120);
    }

    function removeEntry(btn){
      const row = btn.closest(".entry-item");
      if (row){
        row.remove();
        updateBudgetTotals();
        updatePieChart();
        saveMonthData();
        setTimeout(updateSavingsGoal, 120);
      }
    }

    function formatCurrency(v){ return "‚Ç¨ " + (Number(v||0)).toFixed(2).replace(".", ","); }

    function updateBudgetTotals(){
      let totalEntrate = 0;
      document.querySelectorAll('#entrate-items .item-amount-input').forEach(i => totalEntrate += parseAmount(i.value));

      let totalSpese = 0;
      document.querySelectorAll('#spese-items .item-amount-input').forEach(i => totalSpese += parseAmount(i.value));

      const balance = totalEntrate - totalSpese;

      document.getElementById('total-entrate').textContent = formatCurrency(totalEntrate);
      document.getElementById('total-spese').textContent = formatCurrency(totalSpese);
      document.getElementById('summary-entrate').textContent = formatCurrency(totalEntrate);
      document.getElementById('summary-spese').textContent = formatCurrency(totalSpese);

      const balEl = document.getElementById('summary-balance');
      balEl.textContent = formatCurrency(balance);
      balEl.classList.toggle('balance-positive', balance >= 0);
      balEl.classList.toggle('balance-negative', balance < 0);

      updatePieChart();
      updateSavingsGoal();
    }

    function updateFoodTotals(){
      const weeklyBudget = 125;
      let monthlyTotal = 0;

      for (let week=1; week<=4; week++){
        let weekTotal = 0;
        document.querySelectorAll(`.week${week}-shopping`).forEach(i => weekTotal += parseAmount(i.value));
        monthlyTotal += weekTotal;

        const weekTotalEl = document.getElementById(`total-week${week}`);
        const statusEl = document.getElementById(`status-week${week}`);
        if (weekTotalEl && statusEl){
          weekTotalEl.textContent = formatCurrency(weekTotal);
          const remaining = weeklyBudget - weekTotal;
          if (remaining >= 0){
            statusEl.textContent = `‚úì OK (rimasti ${formatCurrency(remaining)})`;
            statusEl.style.backgroundColor = '#E8F5E9';
            statusEl.style.color = '#2E7D32';
          } else {
            statusEl.textContent = `‚ö† Sforato di ${formatCurrency(Math.abs(remaining))}`;
            statusEl.style.backgroundColor = '#FFEBEE';
            statusEl.style.color = '#C62828';
          }
        }
      }

      const monthlyBudget = 500;
      const remainingMonthly = monthlyBudget - monthlyTotal;

      document.getElementById('total-food-spent').textContent = formatCurrency(monthlyTotal);

      const remainingEl = document.getElementById('total-food-remaining');
      remainingEl.textContent = formatCurrency(remainingMonthly);
      remainingEl.classList.toggle('balance-positive', remainingMonthly >= 0);
      remainingEl.classList.toggle('balance-negative', remainingMonthly < 0);
    }

    function updateSavingsGoal(){
      const goalAmount = 250;

      const incomeText = document.getElementById('summary-entrate')?.textContent || "‚Ç¨ 0,00";
      const expenseText = document.getElementById('total-spese')?.textContent || "‚Ç¨ 0,00";

      const totalIncome = parseFloat(incomeText.replace('‚Ç¨','').replace('.', '').replace(',', '.').trim()) || 0;
      const totalExpense = parseFloat(expenseText.replace('‚Ç¨','').replace('.', '').replace(',', '.').trim()) || 0;

      const savedAmount = totalIncome - totalExpense;

      let percentage = (savedAmount / goalAmount) * 100;
      percentage = Math.max(0, Math.min(100, percentage));

      document.getElementById('savings-progress-bar').style.width = percentage + "%";
      document.getElementById('progress-percentage').textContent = percentage.toFixed(0) + "%";
      document.getElementById('saved-amount').textContent = "‚Ç¨" + savedAmount.toFixed(2).replace('.', ',');
      const remaining = Math.max(0, goalAmount - savedAmount);
      document.getElementById('remaining-amount').textContent = "‚Ç¨" + remaining.toFixed(2).replace('.', ',');
    }

    /* ===== INIT + AUTH ===== */
    window.addEventListener("load", ()=>{
      const check = setInterval(()=>{
        if (!window._firebaseReady) return;
        clearInterval(check);

        window._onAuthStateChanged(window._auth, async (user)=>{
          currentUser = user || null;

          if (!currentUser){
            userInfo.textContent = "";
            logoutBtn.style.display = "none";
            showLoginOnly();
            setSyncStatus("Login richiesto", "#ffc107");
            resetUIEmpty();
            return;
          }

          showApp();
          logoutBtn.style.display = "inline-flex";
          userInfo.textContent = currentUser.email || "";
          setSyncStatus("Pronto ‚úÖ", "#ffffff");

          attachRealtimeListener();
          setTimeout(()=>{ updatePieChart(); updateSavingsGoal(); }, 150);
        });
      }, 60);
    });

    /* ===== AI CHAT (UNA SOLA VOLTA, SOLO DOM CORRENTE) ===== */
    (function(){
      const chatButton = document.getElementById('ai-chat-button');
      const chatBox = document.getElementById('ai-chat-box');
      const closeBtn = document.getElementById('ai-chat-close');
      const minimizeBtn = document.getElementById('ai-chat-minimize');
      const messagesEl = document.getElementById('ai-chat-messages');
      const form = document.getElementById('ai-chat-form');
      const input = document.getElementById('ai-chat-input');

      // ‚úÖ metti qui il tuo endpoint (senza slash finale per evitare redirect)
      const API_URL = 'https://ai-chat-backend-vercel.vercel.app/api/ai-chat';

      let comparatoriContent = '';
      fetch('comparatori1.html')
        .then(r=> r.ok ? r.text() : '')
        .then(t=> comparatoriContent = t || '')
        .catch(()=> comparatoriContent='');

      function addMsg(text, who){
        const id = 'msg-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        const wrap = document.createElement('div');
        wrap.className = 'ai-msg ' + (who === 'user' ? 'ai-msg-user' : 'ai-msg-ai');
        wrap.dataset.id = id;
        const bubble = document.createElement('div');
        bubble.className = 'ai-msg-bubble';
        bubble.textContent = text;
        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return id;
      }
      function updateMsg(id, text){
        const el = messagesEl.querySelector(`[data-id="${id}"] .ai-msg-bubble`);
        if (el) el.textContent = text;
        else addMsg(text, 'ai');
      }

      function readItems(containerId){
        return [...document.querySelectorAll(`#${containerId} .entry-item`)].map(row=>{
          const label = row.querySelector(".item-label-input")?.value?.trim() || "";
          const amount = row.querySelector(".item-amount-input")?.value || "";
          return { label, amount };
        }).filter(x => x.label || x.amount);
      }

      function getText(id){
        return document.getElementById(id)?.textContent?.trim() || "";
      }

      function buildListText(title, arr){
        if (!arr.length) return `${title}: (vuoto)`;
        return `${title}:\n` + arr.map((x,i)=> `- ${i+1}) ${x.label || "(senza nome)"} = ${x.amount || "0"}`).join("\n");
      }

      chatButton.addEventListener('click', ()=>{
        if (!currentUser){
          alert("Devi fare login prima di usare l'assistente AI.");
          return;
        }
        chatBox.classList.remove('hidden');
        chatBox.classList.remove('minimized');
        input.focus();
        if (!messagesEl.dataset.started){
          addMsg("Ciao! Rispondo SOLO usando i dati che vedo ORA nella tua pagina (il tuo account). Dimmi cosa vuoi analizzare üí™", 'ai');
          messagesEl.dataset.started = 'true';
        }
      });

      closeBtn.addEventListener('click', ()=>{
        chatBox.classList.add('hidden');
        messagesEl.innerHTML = '';
        delete messagesEl.dataset.started;
      });

      minimizeBtn.addEventListener('click', ()=> chatBox.classList.toggle('minimized'));

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!currentUser){
          addMsg("Devi fare login.", "ai");
          return;
        }

        const q = input.value.trim();
        if (!q) return;

        addMsg(q, 'user');
        input.value = '';

        const typingId = addMsg("Sto analizzando il tuo budget‚Ä¶", 'ai');

        const entrate_items = readItems("entrate-items");
        const spese_items = readItems("spese-items");

        // testo ‚Äúlista completa‚Äù per far riconoscere tutte le voci (Animali, Svago, ecc.)
        const listText =
          buildListText("ENTRATE (lista completa)", entrate_items) + "\n\n" +
          buildListText("SPESE (lista completa)", spese_items) + "\n\n" +
          `RIEPILOGO: entrate=${getText("summary-entrate")}, spese=${getText("summary-spese")}, risparmio=${getText("summary-balance")}\n` +
          `OBIETTIVO: obiettivo=‚Ç¨250,00, risparmiato=${getText("saved-amount")}, mancano=${getText("remaining-amount")}\n` +
          `MESE: ${localStorage.getItem("budgetMonth") || ""}`;

        const budgetContext = {
          month: localStorage.getItem("budgetMonth") || "",
          summary: {
            entrate: getText("summary-entrate"),
            spese: getText("summary-spese"),
            risparmio: getText("summary-balance")
          },
          obiettivo: {
            obiettivo_mensile: "‚Ç¨250,00",
            risparmiato: getText("saved-amount"),
            mancano: getText("remaining-amount")
          },
          entrate_items,
          spese_items,
          food: {
            week1: [...document.querySelectorAll(".week1-shopping")].map(i=>i.value||""),
            week2: [...document.querySelectorAll(".week2-shopping")].map(i=>i.value||""),
            week3: [...document.querySelectorAll(".week3-shopping")].map(i=>i.value||""),
            week4: [...document.querySelectorAll(".week4-shopping")].map(i=>i.value||"")
          },
          listText
        };

        try{
          const idToken = await currentUser.getIdToken(); // ‚úÖ per bloccare utenti lato backend

          const res = await fetch(API_URL, {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Authorization": "Bearer " + idToken
            },
            body: JSON.stringify({
              question: q,
              context_html: comparatoriContent, // opzionale
              budget: budgetContext,            // ‚úÖ verit√† = DOM utente corrente
              uid: currentUser.uid,
              month: budgetContext.month
            })
          });

          if (!res.ok){
            const t = await res.text().catch(()=> "");
            updateMsg(typingId, `Errore AI (HTTP ${res.status}).\n${t.slice(0,200)}`);
            return;
          }

          const data = await res.json().catch(()=> ({}));
          updateMsg(typingId, data.answer || "Non sono riuscito a rispondere, riprova.");
        }catch(err){
          console.error(err);
          updateMsg(typingId, "Errore nel contattare l‚ÄôAI. Controlla:\n- API_URL\n- CORS su Vercel\n- endpoint /api/ai-chat");
        }

        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    })();
  </script>

  <!-- FIRESTORE RULES (DA METTERE SU FIREBASE)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId}/budgets/{monthId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  -->
</body>
</html>