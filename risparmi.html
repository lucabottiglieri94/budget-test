<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Risparmi</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: system-ui;
    background:#f5f5f5;
    margin:0;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}

.box {
    background:white;
    padding:25px;
    border-radius:16px;
    width:95%;
    max-width:650px;
    box-shadow:0 8px 30px rgba(0,0,0,0.1);
}

h1 {
    text-align:center;
    margin-bottom:10px;
}

.salvadanaio {
    margin-top:20px;
    padding:18px;
    border-radius:14px;
    background:#e8f5e9;
    text-align:center;
    font-size:22px;
    font-weight:700;
}

.salvadanaio span {
    font-size:28px;
}

a {
    display:block;
    margin-top:20px;
    text-align:center;
    padding:10px;
    background:#2196F3;
    color:white;
    border-radius:8px;
    text-decoration:none;
    font-weight:600;
}
</style>
</head>

<body>

<div class="box">
    <h1 id="title"></h1>

    <canvas id="chart"></canvas>

    <div class="salvadanaio">
        üê∑ Salvadanaio Totale<br>
        <span id="totale">0 ‚Ç¨</span>
    </div>

    <a href="index.html">‚Üê Torna al Budget</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import {
  getFirestore,
  doc,
  onSnapshot,
  collection,
  onSnapshot as onSnapColl
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
 authDomain: "budget-luca.firebaseapp.com",
 projectId: "budget-luca",
 storageBucket: "budget-luca.firebasestorage.app",
 messagingSenderId: "67496424698",
 appId: "1:67496424698:web:b1822e04ef4efc07408543"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const month = localStorage.getItem("budgetMonth") || "2026-02";
document.getElementById("title").innerText = "üìä Mese " + month;

function totEntrate(data){
    let t=0;
    (data.entrate||[]).forEach(x=> t+=parseFloat(x.amount||0));
    return t;
}

function totSpese(data){
    let t=0;
    (data.spese||[]).forEach(x=> t+=parseFloat(x.amount||0));
    return t;
}

const chart = new Chart(document.getElementById("chart"), {
    type: "bar",
    data: {
        labels: ["Entrate","Spese","Risparmio"],
        datasets: [{
            data: [0,0,0]
        }]
    },
    options: {
        responsive:true,
        scales:{ y:{ beginAtZero:true } }
    }
});


// üîµ GRAFICO MESE CORRENTE
onSnapshot(doc(db,"budgets",month), snap=>{
    if(!snap.exists()){
        chart.data.datasets[0].data=[0,0,0];
        chart.update();
        return;
    }

    const d = snap.data();
    const e = totEntrate(d);
    const s = totSpese(d);
    const r = e - s;

    chart.data.datasets[0].data=[e,s,r];
    chart.update();
});


// üê∑ SALVADANAIO TOTALE (tutti i mesi)
onSnapColl(collection(db,"budgets"), qs=>{
    let totale = 0;

    qs.forEach(docSnap=>{
        const d = docSnap.data();
        totale += (totEntrate(d) - totSpese(d));
    });

    document.getElementById("totale").innerText =
        totale.toFixed(2) + " ‚Ç¨";
});
</script>

</body>
</html>
