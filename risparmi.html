<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Risparmi Mensili</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --text:#111827;
      --muted:#6b7280;
      --danger:#ff6b6b;
      --border:rgba(0,0,0,0.08);
      --card:#ffffff;
      --cardSoft:#f8fafc;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      min-height:100vh;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex;
      justify-content:center;
      padding:30px 14px;
      color:var(--text);
    }

    /* CONTENITORE BIANCO (NON PI√ô TUTTO VIOLA) */
    .wrap{
      width:min(980px, 100%);
      background:#ffffff;
      border-radius:18px;
      padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
      overflow:hidden;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }

    h1{
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing:0.3px;
      font-weight:900;
      color:var(--text);
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      box-shadow:0 10px 22px rgba(0,0,0,0.18);
      transition: transform .08s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform:scale(0.98)}
    .btn.primary{background:#111827;color:#ffffff}
    .btn.danger{background:var(--danger);color:white}
    .btn.ghost{background:#ffffff;color:#111827;border:1px solid var(--border)}

    .pill{
      padding:10px 14px;
      border-radius:999px;
      background:#f3f4f6;
      color:#111827;
      font-weight:900;
      border:1px solid var(--border);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:12px;
    }

    /* CARD BIANCHE */
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius:22px;
      padding:16px;
      box-shadow:0 12px 28px rgba(0,0,0,0.12);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width:760px){
      .row{grid-template-columns:1fr}
      .actions{justify-content:flex-start}
    }

    .kpi{
      background: var(--cardSoft);
      border: 1px solid var(--border);
      border-radius:18px;
      padding:14px;
    }
    .kpi .label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:900;
    }
    .kpi .value{
      font-size:22px;
      font-weight:1000;
      color:var(--text);
    }

    .chartBox{
      height: 420px;
      position:relative;
    }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      font-weight:800;
    }

    .errorBanner{
      display:none;
      margin-top:10px;
      padding:12px 14px;
      border-radius:16px;
      background: #fff5f5;
      border: 1px solid #fecaca;
      color:#991b1b;
      font-weight:900;
    }
    .errorBanner.show{display:block}

    .loginBox{
      display:none;
      margin-top:14px;
      padding:14px;
      border-radius:18px;
      background: #eff6ff;
      border:1px solid #bfdbfe;
      font-weight:900;
      color:#1e40af;
    }
    .loginBox.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Risparmi Mensili</h1>
      </div>

      <div class="actions">
        <span id="status-pill" class="pill">üîÑ Inizializzo‚Ä¶</span>
        <button id="back-btn" class="btn ghost" onclick="location.href='index.html'">‚Üê Torna al Budget</button>
        <button id="login-btn" class="btn primary">Accedi Google</button>
        <button id="logout-btn" class="btn danger" style="display:none;">Logout</button>
      </div>
    </div>

    <div id="loginBox" class="loginBox">
      Devi fare login per vedere i tuoi risparmi.
    </div>

    <div id="errorBanner" class="errorBanner">Errore nel caricamento dei dati.</div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div class="kpi">
            <div class="label">Totale anno</div>
            <div class="value" id="kpi-year">‚Ç¨ 0,00</div>
          </div>
          <div class="kpi">
            <div class="label">Ultimo mese</div>
            <div class="value" id="kpi-month">‚Ç¨ 0,00</div>
          </div>
          <div class="kpi">
            <div class="label">Mesi con dati</div>
            <div class="value" id="kpi-count">0</div>
          </div>
        </div>

        <div class="hint">
          Il grafico si aggiorna in tempo reale quando modifichi entrate/spese su <strong>index.html</strong>.
        </div>
      </div>

      <div class="card">
        <div class="chartBox">
          <canvas id="savingsChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Firestore + Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
      setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
      authDomain: "budget-luca.firebaseapp.com",
      projectId: "budget-luca",
      storageBucket: "budget-luca.firebasestorage.app",
      messagingSenderId: "67496424698",
      appId: "1:67496424698:web:b1822e04ef4efc07408543",
      measurementId: "G-7LEYRZE9QN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ‚úÖ sessione NON persistente (non resta loggato dopo chiusura tab)
    await setPersistence(auth, browserSessionPersistence);

    const provider = new GoogleAuthProvider();

    // UI
    const statusPill = document.getElementById("status-pill");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const errorBanner = document.getElementById("errorBanner");
    const loginBox = document.getElementById("loginBox");

    const kpiYear = document.getElementById("kpi-year");
    const kpiMonth = document.getElementById("kpi-month");
    const kpiCount = document.getElementById("kpi-count");

    let currentUser = null;
    let unsub = null;
    let chart = null;

    function setStatus(text){ statusPill.textContent = text; }
    function showError(msg){
      errorBanner.textContent = msg || "Errore nel caricamento dei dati.";
      errorBanner.classList.add("show");
    }
    function hideError(){ errorBanner.classList.remove("show"); }

    function euro(v){ return "‚Ç¨ " + (Number(v || 0)).toFixed(2).replace(".", ","); }
    function parseAmount(x){ return parseFloat((x ?? "").toString().replace(",", ".")) || 0; }

    function monthName(yyyyMm){
      const [y,m] = (yyyyMm || "").split("-");
      const mesi = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
      const idx = Math.max(1, Math.min(12, parseInt(m,10))) - 1;
      return (mesi[idx] || yyyyMm) + " " + (y || "");
    }

    function calcSavings(docData){
      let inc = 0, exp = 0;
      (docData.entrate || []).forEach(i => inc += parseAmount(i.amount));
      (docData.spese || []).forEach(i => exp += parseAmount(i.amount));
      return inc - exp;
    }

    function ensureChart(){
      const canvas = document.getElementById("savingsChart");
      if (!canvas || typeof Chart === "undefined") return null;
      if (chart) return chart;

      chart = new Chart(canvas, {
        type: "bar",
        data: {
          labels: [],
          datasets: [{
            label: "Risparmio mensile",
            data: [],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => euro(ctx.parsed.y || 0) } }
          },
          scales: {
            x: { ticks: { color: "#111827", font:{ weight:700 } }, grid: { color: "rgba(0,0,0,0.08)" } },
            y: { ticks: { color: "#111827", font:{ weight:700 }, callback: (v)=>euro(v) }, grid: { color: "rgba(0,0,0,0.08)" } }
          }
        }
      });

      return chart;
    }

    function updateUIFromMonths(monthMap){
      const months = Object.keys(monthMap).sort(); // yyyy-mm
      const values = months.map(m => monthMap[m]);

      const totalYear = values.reduce((a,b)=>a+b,0);
      const lastMonth = months.length ? months[months.length - 1] : null;
      const lastVal = lastMonth ? monthMap[lastMonth] : 0;

      kpiYear.textContent = euro(totalYear);
      kpiMonth.textContent = euro(lastVal);
      kpiCount.textContent = String(months.length);

      const c = ensureChart();
      if (!c) return;

      c.data.labels = months.map(monthName);
      c.data.datasets[0].data = values;
      c.update();
    }

    function attachUserListener(){
      if (!currentUser) return;

      // ‚úÖ dati separati per utente:
      // users/{uid}/budgets/{month}
      const colRef = collection(db, "users", currentUser.uid, "budgets");

      if (unsub) { unsub(); unsub = null; }

      setStatus("üì° Carico i tuoi dati‚Ä¶");
      hideError();

      unsub = onSnapshot(colRef, (snap) => {
        const map = {};
        snap.forEach(docSnap => {
          const monthId = docSnap.id; // es. 2026-02
          const data = docSnap.data() || {};
          map[monthId] = calcSavings(data);
        });

        updateUIFromMonths(map);
        setStatus("‚úÖ Sincronizzato");
      }, (err) => {
        console.error(err);
        setStatus("‚ùå Errore");
        showError("Errore nel caricamento dei dati. Controlla le Firestore Rules per users/{uid}/budgets.");
      });
    }

    loginBtn.addEventListener("click", async () => {
      try { await signInWithPopup(auth, provider); }
      catch(e){ console.error(e); showError("Login non riuscito."); }
    });

    logoutBtn.addEventListener("click", async () => {
      try{
        await signOut(auth);
        if (unsub) { unsub(); unsub = null; }
        updateUIFromMonths({});
        setStatus("üëã Disconnesso");
        hideError();
      }catch(e){
        console.error(e);
        showError("Logout non riuscito.");
      }
    });

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;

      if (!currentUser){
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        loginBox.classList.add("show");

        if (unsub) { unsub(); unsub = null; }
        updateUIFromMonths({});
        setStatus("üîí Login richiesto");
        return;
      }

      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-flex";
      loginBox.classList.remove("show");

      attachUserListener();
    });

    setStatus("‚úÖ Pronto");
  </script>

  <!-- FIRESTORE RULES (mettile su Firebase)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId}/budgets/{monthId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  -->
</body>
</html>
