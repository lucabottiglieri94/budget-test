<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Risparmi anno con Google Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { color: #333; }
    #yearTotal { margin-bottom: 20px; }
    #loginButton { margin-bottom: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Risparmio annuale</h1>
  <button id="loginButton">Login con Google</button>
  <h2 id="yearTotal">Accedi per vedere i dati...</h2>
  <canvas id="savingsChart" width="800" height="400"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
      authDomain: "budget-luca.firebaseapp.com",
      projectId: "budget-luca",
      storageBucket: "budget-luca.firebasestorage.app",
      messagingSenderId: "67496424698",
      appId: "1:67496424698:web:b1822e04ef4efc07408543",
      measurementId: "G-7LEYRZE9QN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const mesi = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
    let risparmi = []; // array globale dei risparmi

    const loginButton = document.getElementById("loginButton");
    loginButton.addEventListener("click", loginGoogle);

    async function loginGoogle() {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        console.log("Utente loggato:", user.email);

        loginButton.style.display = "none"; // nascondi bottone login
        document.getElementById("yearTotal").innerText = "Caricamento dati...";

        caricaDatiAnno();
      } catch (error) {
        console.error("Errore login Google:", error);
        alert("Login Google fallito. Controlla la console per dettagli.");
      }
    }

    async function caricaDatiAnno() {
      try {
        const oggi = new Date();
        const anno = oggi.getFullYear();
        const meseCorrente = oggi.getMonth();

        risparmi = Array(12).fill(0);
        const colori = Array(12).fill("#999");

        const budgetsRef = collection(db, "budgets");
        const snap = await getDocs(budgetsRef);

        snap.forEach(docSnap => {
          const id = docSnap.id;
          const [annoDoc, meseDoc] = id.split("-").map(Number);
          if (annoDoc !== anno) return;

          const d = docSnap.data();
          let totEntrate = 0;
          (d.entrate || []).forEach(e => {
            const v = parseFloat((e.amount || "0").toString().replace(",", "."));
            if (!isNaN(v)) totEntrate += v;
          });
          let totSpese = 0;
          (d.spese || []).forEach(s => {
            const v = parseFloat((s.amount || "0").toString().replace(",", "."));
            if (!isNaN(v)) totSpese += v;
          });

          const risparmio = totEntrate - totSpese;
          risparmi[meseDoc - 1] = risparmio;
          colori[meseDoc - 1] = risparmio >= 0 ? "#4CAF50" : "#e74c3c";
        });

        aggiornaTesto(meseCorrente, anno);
        disegnaGraficoAnno(risparmi, colori, anno);

      } catch (err) {
        console.error("Errore caricamento dati:", err);
        document.getElementById("yearTotal").innerText = "Errore nel caricamento dei dati.";
      }
    }

    function aggiornaTesto(meseIndex, anno) {
      const yearTotalEl = document.getElementById("yearTotal");
      if (yearTotalEl) {
        yearTotalEl.innerText = `Risparmio ${mesi[meseIndex]} ${anno}: ${risparmi[meseIndex].toFixed(2)} €`;
      }
    }

    function disegnaGraficoAnno(risparmi, colori, anno) {
      const canvasEl = document.getElementById("savingsChart");
      if (!canvasEl) return;
      const ctx = canvasEl.getContext('2d');

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: mesi,
          datasets: [{
            label: "Risparmio mese €",
            data: risparmi,
            backgroundColor: colori
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => `${context.dataset.label}: ${context.raw.toFixed(2)} €`
              }
            }
          },
          onClick: (evt, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              aggiornaTesto(index, anno);
            }
          }
        }
      });
    }
  </script>
</body>
</html>
