<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Risparmi</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- FIREBASE COMPAT (come index.html) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
 font-family:system-ui;
 background:#f5f5f5;
 margin:0;
 display:flex;
 justify-content:center;
 align-items:center;
 min-height:100vh;
}

.box{
 background:white;
 padding:25px;
 border-radius:16px;
 width:95%;
 max-width:650px;
 box-shadow:0 8px 30px rgba(0,0,0,0.1);
}

.salvadanaio{
 margin-top:20px;
 padding:18px;
 border-radius:14px;
 background:#e8f5e9;
 text-align:center;
 font-size:22px;
 font-weight:700;
}
</style>
</head>

<body>

<div class="box">
<h2 id="titolo">ğŸ“Š Risparmi</h2>
<canvas id="chart"></canvas>

<div class="salvadanaio">
ğŸ· Totale risparmi: <span id="tot">0 â‚¬</span>
</div>

<a href="index.html">â† Torna</a>
</div>

<script>

const firebaseConfig = {
 apiKey:"AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
 authDomain:"budget-luca.firebaseapp.com",
 projectId:"budget-luca",
 storageBucket:"budget-luca.firebasestorage.app",
 messagingSenderId:"67496424698",
 appId:"1:67496424698:web:b1822e04ef4efc07408543"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function sumE(d){
 let t=0;
 (d.entrate||[]).forEach(x=> t+=Number(x.amount)||0);
 return t;
}

function sumS(d){
 let t=0;
 (d.spese||[]).forEach(x=> t+=Number(x.amount)||0);
 return t;
}

const chart = new Chart(document.getElementById("chart"),{
 type:"bar",
 data:{
  labels:["Entrate","Spese","Risparmio"],
  datasets:[{
    data:[0,0,0]
  }]
 },
 options:{
  responsive:true,
  scales:{y:{beginAtZero:true}}
 }
});

db.collection("budgets").onSnapshot(snap=>{

 let totaleSalvadanaio = 0;
 let ultimo = null;

 snap.forEach(doc=>{
   ultimo = doc;
 });

 if(!ultimo){
   console.log("Nessun documento budgets");
   return;
 }

 const d = ultimo.data();
 const e = sumE(d);
 const s = sumS(d);
 const r = e - s;

 chart.data.datasets[0].data=[e,s,r];
 chart.update();

 snap.forEach(doc=>{
   const d2 = doc.data();
   totaleSalvadanaio += sumE(d2)-sumS(d2);
 });

 document.getElementById("tot").innerText =
   totaleSalvadanaio.toFixed(2)+" â‚¬";

 document.getElementById("titolo").innerText =
   "ğŸ“Š Mese " + ultimo.id;

});

</script>

</body>
</html>
