<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <title>Risparmi Mensili</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#070B14;
      --bg1:#0B1220;
      --bg2:#101B32;

      --card:#0F172A;
      --text:#E5E7EB;
      --muted:#9CA3AF;
      --line: rgba(255,255,255,.10);

      --accent:#7C3AED;
      --accent2:#22C55E;
      --danger:#EF4444;
      --warn:#F59E0B;
      --info:#38BDF8;

      --radius:18px;
      --shadow: 0 22px 70px rgba(0,0,0,.45);
      --shadow2: 0 14px 40px rgba(0,0,0,.30);

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}

    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.25), transparent 55%),
                  radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      overflow-x:hidden;
    }

    /* Layout */
    .shell{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      padding: calc(16px + var(--safe-top)) 16px calc(24px + var(--safe-bottom)) 16px;
    }

    /* Sidebar */
    .sidebar{
      position: sticky;
      top: calc(16px + var(--safe-top));
      align-self: start;
      border-radius: var(--radius);
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 16px;
      backdrop-filter: blur(10px);
      height: fit-content;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 14px;
    }
    .brand h1{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .brand .badge{
      font-size: 11px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
    }

    #status-pill{
      margin-top: 6px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
      color: rgba(229,231,235,.92);
      font-size: 12px;
    }

    .menu{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 14px;
    }
    .navbtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:none;
      cursor:pointer;
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 950;
      color: rgba(229,231,235,.92);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      transition: transform .08s ease, background .12s ease;
    }
    .navbtn:hover{ background: rgba(255,255,255,.09) }
    .navbtn:active{ transform: scale(.99) }
    .navbtn .hint{
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,.75);
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .topbar{
      border-radius: var(--radius);
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .topbar-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
    }
    .topbar-title{
      font-weight: 950;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .topbar-sub{
      color: rgba(229,231,235,.78);
      font-weight: 700;
      font-size: 12px;
      line-height: 1.25;
    }

    .topbar-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1;
    }

    .select{
      flex: 1;
      min-width: 180px;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
      font-size: 15px;
      font-weight: 900;
      outline:none;
      appearance: none;
    }

    .btn{
      border:none;
      cursor:pointer;
      padding: 11px 12px;
      border-radius: 14px;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .08s ease;
    }
    .btn:active{ transform: scale(.99) }
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(56,189,248,1));
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(245,158,11,1));
      color:#061019;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(229,231,235,.92);
    }

    /* Cards */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .card{
      border-radius: var(--radius);
      background: rgba(15,23,42,.72);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      font-size: 14px;
      font-weight: 950;
      letter-spacing:.2px;
      margin-bottom: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .muted{ color: rgba(229,231,235,.70); font-weight: 800; font-size: 12px; }

    .kpi{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 6px 0;
    }
    .kpi .label{
      font-size: 12px;
      font-weight: 950;
      color: rgba(229,231,235,.75);
      letter-spacing: .8px;
      text-transform: uppercase;
    }
    .kpi .value{
      font-size: 28px;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .pos{ color: rgba(34,197,94,1); }
    .neg{ color: rgba(239,68,68,1); }

    .banner{
      display:none;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 900;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
    }
    .banner.show{ display:block; }
    .banner.info{ border-color: rgba(56,189,248,.25); }
    .banner.error{ border-color: rgba(239,68,68,.28); }

    /* Chart */
    .chart-holder{
      position: relative;
      width: 100%;
      height: 460px;
    }
    .note{
      margin-top: 10px;
      color: rgba(229,231,235,.75);
      font-size: 12px;
      font-weight: 800;
      line-height: 1.35;
    }

    /* Mobile */
    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .grid{ grid-template-columns: 1fr; }
      .select{ min-width: 0; width: 100%; }
      .topbar-right{ justify-content:flex-start; }
    }
  </style>
</head>

<body>
  <div class="shell">

    <!-- Sidebar desktop -->
    <aside class="sidebar">
      <div class="brand">
        <h1>Risparmi</h1>
        <div class="badge">Dashboard</div>
      </div>

      <div id="status-pill">üîÑ Inizializzo‚Ä¶</div>

      <div class="menu">
        <button class="navbtn" type="button" onclick="location.href='index.html'">
          <span>‚Üê Torna al Budget</span><span class="hint">Home</span>
        </button>
        <button id="login-btn-side" class="navbtn" type="button">
          <span>üîë Accedi Google</span><span class="hint">Login</span>
        </button>
        <button id="logout-btn-side" class="navbtn" type="button" style="display:none;">
          <span>üö™ Esci</span><span class="hint">Logout</span>
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">

      <div class="topbar">
        <div class="topbar-left">
          <div class="topbar-title">üíæ Risparmi Mensili</div>
          <div class="topbar-sub">Barre mensili aggiunte solo quando entri nel mese (Feb = Gen+Feb)</div>
        </div>

        <div class="topbar-right">
          <select id="year-selector" class="select" title="Seleziona anno">
            <option value="">Anno‚Ä¶</option>
          </select>

          <button class="btn ghost" type="button" onclick="location.href='index.html'">‚Üê Budget</button>
          <button id="login-btn" class="btn primary" type="button">Accedi</button>
          <button id="logout-btn" class="btn danger" type="button" style="display:none;">Esci</button>
        </div>
      </div>

      <div id="bannerInfo" class="banner info show">Devi fare login per vedere i tuoi dati.</div>
      <div id="bannerError" class="banner error">Errore nel caricamento dei dati.</div>

      <div class="grid">
        <section class="card">
          <h2>Totale risparmio <span class="muted">anno selezionato</span></h2>
          <div class="kpi">
            <div class="label">Totale</div>
            <div class="value pos" id="kpi-savings">‚Ç¨ 0,00</div>
          </div>
          <div class="note">Somma dei risparmi mensili (Entrate ‚àí Spese) per l‚Äôanno.</div>
        </section>

        <section class="card">
          <h2>Info <span class="muted">logica</span></h2>
          <div class="note">
            ‚Ä¢ Se selezioni <b>l‚Äôanno corrente</b>, vedrai i mesi da Gen fino al mese attuale.<br>
            ‚Ä¢ Se selezioni un anno passato, vedrai solo i mesi realmente presenti su Firestore.
          </div>
        </section>
      </div>

      <section class="card">
        <h2>üìä Risparmi mensili <span class="muted">Entrate ‚àí Spese</span></h2>
        <div class="chart-holder">
          <canvas id="savingsChart"></canvas>
        </div>
        <div class="note">
          Ogni barra rappresenta: <strong>Entrate - Spese</strong> del mese. (Dati: users/&lt;uid&gt;/budgets/&lt;YYYY-MM&gt;)
        </div>
      </section>

    </main>
  </div>

  <!-- Firebase + Firestore + Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
      setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
      authDomain: "budget-luca.firebaseapp.com",
      projectId: "budget-luca",
      storageBucket: "budget-luca.firebasestorage.app",
      messagingSenderId: "67496424698",
      appId: "1:67496424698:web:b1822e04ef4efc07408543",
      measurementId: "G-7LEYRZE9QN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    await setPersistence(auth, browserSessionPersistence);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // UI
    const statusPill = document.getElementById("status-pill");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const loginBtnSide = document.getElementById("login-btn-side");
    const logoutBtnSide = document.getElementById("logout-btn-side");

    const bannerInfo = document.getElementById("bannerInfo");
    const bannerError = document.getElementById("bannerError");
    const yearSelector = document.getElementById("year-selector");
    const kpiSavings = document.getElementById("kpi-savings");

    let currentUser = null;
    let unsub = null;
    let chart = null;

    // cache: year -> month(1..12) -> savings
    let savingsByYear = {};
    const MONTHS = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];

    function setStatus(t){ statusPill.textContent = t; }
    function showInfo(on){ bannerInfo.classList.toggle("show", !!on); }
    function showError(msg){
      bannerError.textContent = msg || "Errore nel caricamento dei dati.";
      bannerError.classList.add("show");
    }
    function hideError(){ bannerError.classList.remove("show"); }

    function euro(v){
      const n = Number(v || 0);
      return "‚Ç¨ " + n.toFixed(2).replace(".", ",");
    }
    function parseAmount(x){
      return parseFloat((x ?? "").toString().replace(",", ".")) || 0;
    }

    function getCurrentMonthKey(){
      const m = localStorage.getItem("budgetMonth"); // es "2026-02"
      if (/^\d{4}-\d{2}$/.test(m || "")) return m;
      const d = new Date();
      const y = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      return `${y}-${mm}`;
    }

    function monthLimitForYear(year){
      const current = getCurrentMonthKey();
      const [cy, cm] = current.split("-");
      if (String(year) !== cy) return null;
      return Math.max(1, Math.min(12, parseInt(cm, 10) || 1));
    }

    function ensureChart(){
      const canvas = document.getElementById("savingsChart");
      if (!canvas || typeof Chart === "undefined") return null;
      if (chart) return chart;

      chart = new Chart(canvas, {
        type: "bar",
        data: {
          labels: [],
          datasets: [{
            label: "Risparmio",
            data: [],
            backgroundColor: "rgba(34,197,94,0.88)",
            borderRadius: 12
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: (ctx) => ` Risparmio: ${euro(ctx.parsed.y || 0)}` }
            }
          },
          scales: {
            x: {
              grid: { color: "rgba(255,255,255,0.08)" },
              ticks: { color: "rgba(229,231,235,.85)", font: { weight: 900 } }
            },
            y: {
              grid: { color: "rgba(255,255,255,0.08)" },
              ticks: {
                color: "rgba(229,231,235,.85)",
                font: { weight: 800 },
                callback: (v)=> euro(v)
              }
            }
          }
        }
      });

      return chart;
    }

    function resetData(){
      savingsByYear = {};
      yearSelector.innerHTML = `<option value="">Anno‚Ä¶</option>`;
      yearSelector.value = "";
      kpiSavings.textContent = euro(0);
      kpiSavings.classList.add("pos");
      kpiSavings.classList.remove("neg");

      const c = ensureChart();
      if (c){
        c.data.labels = [];
        c.data.datasets[0].data = [];
        c.update();
      }
    }

    function calcSavings(docData){
      let inc = 0, exp = 0;
      (docData.entrate || []).forEach(i => inc += parseAmount(i.amount));
      (docData.spese || []).forEach(i => exp += parseAmount(i.amount));
      return inc - exp;
    }

    function buildYearsSelector(){
      const years = Object.keys(savingsByYear).sort();
      yearSelector.innerHTML = `<option value="">Anno‚Ä¶</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");

      if (!yearSelector.value){
        const [cy] = getCurrentMonthKey().split("-");
        if (years.includes(cy)) yearSelector.value = cy;
        else if (years.length) yearSelector.value = years[years.length - 1];
        else yearSelector.value = cy;
      }
    }

    function getSelectedYear(){
      const y = yearSelector.value;
      if (y && /^\d{4}$/.test(y)) return y;
      return getCurrentMonthKey().split("-")[0];
    }

    function updateYearView(year){
      const y = String(year);
      const monthsObj = savingsByYear[y] || {};
      const limit = monthLimitForYear(y);

      const labels = [];
      const values = [];
      let total = 0;

      if (limit != null){
        for (let m = 1; m <= limit; m++){
          const v = monthsObj[m] ?? 0;
          labels.push(MONTHS[m-1]);
          values.push(v);
          total += v;
        }
      } else {
        const presentMonths = Object.keys(monthsObj)
          .map(n=>parseInt(n,10))
          .filter(n=>n>=1 && n<=12)
          .sort((a,b)=>a-b);

        for (const m of presentMonths){
          const v = monthsObj[m] ?? 0;
          labels.push(MONTHS[m-1]);
          values.push(v);
          total += v;
        }
      }

      kpiSavings.textContent = euro(total);
      kpiSavings.classList.toggle("pos", total >= 0);
      kpiSavings.classList.toggle("neg", total < 0);

      const c = ensureChart();
      if (!c) return;

      c.data.labels = labels;
      c.data.datasets[0].data = values;
      c.update();
    }

    function attachUserListener(){
      if (!currentUser) return;

      const colRef = collection(db, "users", currentUser.uid, "budgets");
      if (unsub) { unsub(); unsub = null; }

      setStatus("üì° Carico i tuoi dati‚Ä¶");
      hideError();

      unsub = onSnapshot(colRef, (snap) => {
        savingsByYear = {};

        snap.forEach(docSnap => {
          const id = docSnap.id; // "YYYY-MM"
          const m = /^(\d{4})-(\d{2})$/.exec(id);
          if (!m) return;

          const year = m[1];
          const monthNum = parseInt(m[2], 10);
          if (!monthNum || monthNum < 1 || monthNum > 12) return;

          const s = calcSavings(docSnap.data() || {});
          if (!savingsByYear[year]) savingsByYear[year] = {};
          savingsByYear[year][monthNum] = s;
        });

        buildYearsSelector();
        updateYearView(getSelectedYear());
        setStatus("‚úÖ Sincronizzato");
      }, (err) => {
        console.error(err);
        setStatus("‚ùå Errore");
        showError("Errore nel caricamento. Controlla le Firestore Rules su users/{uid}/budgets.");
      });
    }

    yearSelector.addEventListener("change", () => updateYearView(getSelectedYear()));

    async function doLogin(){
      try { await signInWithPopup(auth, provider); }
      catch(e){ console.error(e); showError("Login non riuscito. Controlla popup bloccati."); }
    }
    async function doLogout(){
      try{
        await signOut(auth);
        if (unsub) { unsub(); unsub = null; }
        resetData();
        setStatus("üëã Disconnesso");
        hideError();
      }catch(e){
        console.error(e);
        showError("Logout non riuscito.");
      }
    }

    loginBtn.addEventListener("click", doLogin);
    loginBtnSide.addEventListener("click", doLogin);
    logoutBtn.addEventListener("click", doLogout);
    logoutBtnSide.addEventListener("click", doLogout);

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;

      if (!currentUser){
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        loginBtnSide.style.display = "block";
        logoutBtnSide.style.display = "none";

        showInfo(true);
        if (unsub) { unsub(); unsub = null; }
        resetData();

        setStatus("üîí Login richiesto");
        ensureChart();
        return;
      }

      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-flex";
      loginBtnSide.style.display = "none";
      logoutBtnSide.style.display = "block";

      showInfo(false);
      attachUserListener();
    });

    setStatus("‚úÖ Pronto");
    ensureChart();
  </script>

  <!-- FIRESTORE RULES (Firebase Console -> Firestore Rules)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId}/budgets/{monthId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  -->
</body>
</html>
