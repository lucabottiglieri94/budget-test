<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Risparmi Mensili</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --primary:#2196F3;
      --success:#4CAF50;
      --light:#f5f5f5;
      --dark:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:0;
      color:var(--dark);
    }

    .container{
      width:100vw;
      max-width:100vw;
      height:100vh;
      background:#fff;
      box-shadow:0 20px 60px rgba(0,0,0,0.28);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    header{
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff;
      padding:22px 18px;
      text-align:center;
      position:fixed;
      top:0;left:0;right:0;
      z-index:1000;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    header.header-hidden{transform:translateY(-100%);opacity:0}

    header h1{
      font-size:1.8em;
      margin-bottom:6px;
      font-weight:900;
      letter-spacing:.2px;
    }
    header p{
      font-size:.85em;
      opacity:.95;
      font-weight:400;
    }

    .top-controls{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      font-size:.8em;
      font-weight:900;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.16);
      border:1px solid rgba(255,255,255,0.25);
    }

    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      box-shadow:0 10px 22px rgba(0,0,0,0.18);
      transition: transform .08s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform:scale(0.98)}
    .btn.light{background:#fff;color:#111827}
    .btn.danger{background:#ff6b6b;color:#fff}
    .btn.ghost{background:rgba(255,255,255,0.16);color:#fff;border:1px solid rgba(255,255,255,0.22)}

    select{
      padding:10px 14px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,0.55);
      background:rgba(255,255,255,0.95);
      color:#111827;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      outline:none;
    }

    .content{
      flex:1;
      overflow-y:auto;
      padding:20px;
      padding-top:220px;
      display:flex;
      flex-direction:column;
      gap:18px;
      background:#fff;
    }

    .section{
      background:var(--light);
      padding:18px;
      border-radius:15px;
      border-left:5px solid var(--primary);
    }

    .section h2{
      color:#111827;
      margin-bottom:14px;
      font-size:1.25em;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .summary{
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff;
      padding:18px;
      border-radius:15px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      text-align:center;
    }
    .summary-card{
      background: rgba(255,255,255,0.15);
      padding:14px;
      border-radius:12px;
      backdrop-filter: blur(10px);
    }
    .summary-label{
      font-size:.78em;
      opacity:.95;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.5px;
      font-weight:900;
    }
    .summary-value{
      font-size:1.55em;
      font-weight:1000;
    }

    .balance-positive{color:#b9ffcc}
    .balance-negative{color:#ffd1d1}

    .chart-wrap{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 22px rgba(0,0,0,0.08);
    }

    .chart-holder{
      position:relative;
      width:100%;
      height:440px;
    }

    .note{
      margin-top:10px;
      color:var(--muted);
      font-size:.9em;
      font-weight:700;
    }

    .banner{
      display:none;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      border:1px solid;
    }
    .banner.show{display:block}
    .banner.info{background:#eff6ff;border-color:#bfdbfe;color:#1e40af}
    .banner.error{background:#fff5f5;border-color:#fecaca;color:#991b1b}

    @media (max-width:860px){
      header h1{font-size:1.55em}
      .content{padding-top:260px}
    }
  </style>
</head>

<body>
  <div class="container">

    <header>
      <h1>üíæ Risparmi</h1>
      <p>Barre mensili aggiunte solo quando entri nel mese (es. Feb = Gen+Feb)</p>

      <div class="top-controls">
        <span id="status-pill" class="pill">üîÑ Inizializzo‚Ä¶</span>

        <select id="year-selector" title="Seleziona anno">
          <option value="">Anno‚Ä¶</option>
        </select>

        <button class="btn ghost" onclick="location.href='index.html'">‚Üê Torna al Budget</button>
        <button id="login-btn" class="btn light">Accedi Google</button>
        <button id="logout-btn" class="btn danger" style="display:none;">Esci</button>
      </div>
    </header>

    <div class="content">
      <div id="bannerInfo" class="banner info show">Devi fare login per vedere i tuoi dati.</div>
      <div id="bannerError" class="banner error">Errore nel caricamento dei dati.</div>

      <!-- SOLO TOTALE RISPARMIO -->
      <div class="summary">
        <div class="summary-card">
          <div class="summary-label">Totale Risparmio (anno selezionato)</div>
          <div class="summary-value balance-positive" id="kpi-savings">‚Ç¨ 0,00</div>
        </div>
      </div>

      <div class="section">
        <h2>üìä Risparmi mensili</h2>
        <div class="chart-wrap">
          <div class="chart-holder">
            <canvas id="savingsChart"></canvas>
          </div>
          <div class="note">
            Ogni barra rappresenta: <strong>Entrate - Spese</strong> del mese.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Firestore + Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
      setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
      authDomain: "budget-luca.firebaseapp.com",
      projectId: "budget-luca",
      storageBucket: "budget-luca.firebasestorage.app",
      messagingSenderId: "67496424698",
      appId: "1:67496424698:web:b1822e04ef4efc07408543",
      measurementId: "G-7LEYRZE9QN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ‚úÖ non resta loggato dopo chiusura TAB
    await setPersistence(auth, browserSessionPersistence);
    const provider = new GoogleAuthProvider();

    // UI
    const statusPill = document.getElementById("status-pill");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const bannerInfo = document.getElementById("bannerInfo");
    const bannerError = document.getElementById("bannerError");
    const yearSelector = document.getElementById("year-selector");
    const kpiSavings = document.getElementById("kpi-savings");

    let currentUser = null;
    let unsub = null;
    let chart = null;

    // cache: year -> month(1..12) -> savings
    let savingsByYear = {};

    const MONTHS = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];

    function setStatus(t){ statusPill.textContent = t; }
    function showInfo(on){ bannerInfo.classList.toggle("show", !!on); }
    function showError(msg){
      bannerError.textContent = msg || "Errore nel caricamento dei dati.";
      bannerError.classList.add("show");
    }
    function hideError(){ bannerError.classList.remove("show"); }

    function euro(v){
      const n = Number(v || 0);
      return "‚Ç¨ " + n.toFixed(2).replace(".", ",");
    }
    function parseAmount(x){
      return parseFloat((x ?? "").toString().replace(",", ".")) || 0;
    }

    function getCurrentMonthKey(){
      const m = localStorage.getItem("budgetMonth"); // es "2026-02"
      if (/^\d{4}-\d{2}$/.test(m || "")) return m;
      const d = new Date();
      const y = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      return `${y}-${mm}`;
    }

    function monthLimitForYear(year){
      const current = getCurrentMonthKey();
      const [cy, cm] = current.split("-");
      if (String(year) !== cy) return null; // anni diversi: mostra solo mesi presenti
      return Math.max(1, Math.min(12, parseInt(cm, 10) || 1));
    }

    function ensureChart(){
      const canvas = document.getElementById("savingsChart");
      if (!canvas || typeof Chart === "undefined") return null;
      if (chart) return chart;

      chart = new Chart(canvas, {
        type: "bar",
        data: {
          labels: [],
          datasets: [
            {
              label: "Risparmio",
              data: [],
              backgroundColor: "rgba(76,175,80,0.88)",
              borderRadius: 10
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: (ctx) => ` Risparmio: ${euro(ctx.parsed.y || 0)}` }
            }
          },
          scales: {
            x: { grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#111827", font: { weight: 900 } } },
            y: { grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#111827", font: { weight: 800 }, callback: (v)=>euro(v) } }
          }
        }
      });

      return chart;
    }

    function resetData(){
      savingsByYear = {};
      yearSelector.innerHTML = `<option value="">Anno‚Ä¶</option>`;
      yearSelector.value = "";
      kpiSavings.textContent = euro(0);
      kpiSavings.classList.add("balance-positive");
      kpiSavings.classList.remove("balance-negative");

      const c = ensureChart();
      if (c){
        c.data.labels = [];
        c.data.datasets[0].data = [];
        c.update();
      }
    }

    function calcSavings(docData){
      let inc = 0, exp = 0;
      (docData.entrate || []).forEach(i => inc += parseAmount(i.amount));
      (docData.spese || []).forEach(i => exp += parseAmount(i.amount));
      return inc - exp;
    }

    function buildYearsSelector(){
      const years = Object.keys(savingsByYear).sort();
      yearSelector.innerHTML = `<option value="">Anno‚Ä¶</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");

      if (!yearSelector.value){
        const [cy] = getCurrentMonthKey().split("-");
        if (years.includes(cy)) yearSelector.value = cy;
        else if (years.length) yearSelector.value = years[years.length - 1];
        else yearSelector.value = cy;
      }
    }

    function getSelectedYear(){
      const y = yearSelector.value;
      if (y && /^\d{4}$/.test(y)) return y;
      return getCurrentMonthKey().split("-")[0];
    }

    function updateYearView(year){
      const y = String(year);
      const monthsObj = savingsByYear[y] || {};

      const limit = monthLimitForYear(y);

      const labels = [];
      const values = [];

      let total = 0;

      if (limit != null) {
        // anno corrente: mostra da Gen fino al mese corrente (limit), anche se alcuni mesi sono 0
        for (let m = 1; m <= limit; m++){
          const v = monthsObj[m] ?? 0;
          labels.push(MONTHS[m-1]);
          values.push(v);
          total += v;
        }
      } else {
        // anni diversi: mostra SOLO i mesi presenti
        const presentMonths = Object.keys(monthsObj).map(n=>parseInt(n,10)).filter(n=>n>=1 && n<=12).sort((a,b)=>a-b);
        for (const m of presentMonths){
          const v = monthsObj[m] ?? 0;
          labels.push(MONTHS[m-1]);
          values.push(v);
          total += v;
        }
      }

      kpiSavings.textContent = euro(total);
      kpiSavings.classList.toggle("balance-positive", total >= 0);
      kpiSavings.classList.toggle("balance-negative", total < 0);

      const c = ensureChart();
      if (!c) return;

      c.data.labels = labels;
      c.data.datasets[0].data = values;
      c.update();
    }

    function attachUserListener(){
      if (!currentUser) return;

      // ‚úÖ percorso per utente
      const colRef = collection(db, "users", currentUser.uid, "budgets");

      if (unsub) { unsub(); unsub = null; }

      setStatus("üì° Carico i tuoi dati‚Ä¶");
      hideError();

      unsub = onSnapshot(colRef, (snap) => {
        savingsByYear = {};

        snap.forEach(docSnap => {
          const id = docSnap.id; // "YYYY-MM"
          const m = /^(\d{4})-(\d{2})$/.exec(id);
          if (!m) return;

          const year = m[1];
          const monthNum = parseInt(m[2], 10);
          if (!monthNum || monthNum < 1 || monthNum > 12) return;

          const s = calcSavings(docSnap.data() || {});
          if (!savingsByYear[year]) savingsByYear[year] = {};
          savingsByYear[year][monthNum] = s;
        });

        buildYearsSelector();
        updateYearView(getSelectedYear());
        setStatus("‚úÖ Sincronizzato");
      }, (err) => {
        console.error(err);
        setStatus("‚ùå Errore");
        showError("Errore nel caricamento dei dati. Controlla le Firestore Rules per users/{uid}/budgets.");
      });
    }

    yearSelector.addEventListener("change", () => {
      updateYearView(getSelectedYear());
    });

    loginBtn.addEventListener("click", async () => {
      try { await signInWithPopup(auth, provider); }
      catch(e){ console.error(e); showError("Login non riuscito."); }
    });

    logoutBtn.addEventListener("click", async () => {
      try{
        await signOut(auth);
        if (unsub) { unsub(); unsub = null; }
        resetData();
        setStatus("üëã Disconnesso");
        hideError();
      }catch(e){
        console.error(e);
        showError("Logout non riuscito.");
      }
    });

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;

      if (!currentUser){
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        showInfo(true);

        if (unsub) { unsub(); unsub = null; }
        resetData();

        setStatus("üîí Login richiesto");
        return;
      }

      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-flex";
      showInfo(false);

      attachUserListener();
    });

    setStatus("‚úÖ Pronto");
    ensureChart();
  </script>

  <script>
    // HEADER AUTO HIDE (come index)
    const headerEl = document.querySelector('header');
    const contentEl = document.querySelector('.content');

    function handleHeaderScroll(scrollValue) {
      if (scrollValue > 10) headerEl.classList.add('header-hidden');
      else headerEl.classList.remove('header-hidden');
    }

    if (contentEl) {
      contentEl.addEventListener('scroll', () => handleHeaderScroll(contentEl.scrollTop));
    }
    window.addEventListener('scroll', () => handleHeaderScroll(window.scrollY || window.pageYOffset));
  </script>


</body>
</html>
