<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Risparmi</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: system-ui;
    background:#f5f5f5;
    margin:0;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}

.box {
    background:white;
    padding:25px;
    border-radius:16px;
    width:95%;
    max-width:650px;
    box-shadow:0 8px 30px rgba(0,0,0,0.1);
}

.salvadanaio {
    margin-top:20px;
    padding:18px;
    border-radius:14px;
    background:#e8f5e9;
    text-align:center;
    font-size:22px;
    font-weight:700;
}
</style>
</head>

<body>

<div class="box">
<h2 id="titolo">ğŸ“Š Risparmi</h2>
<canvas id="chart"></canvas>

<div class="salvadanaio">
ğŸ· Totale risparmi: <span id="tot">0 â‚¬</span>
</div>

<a href="index.html">â† Torna</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
 authDomain:"budget-luca.firebaseapp.com",
 projectId:"budget-luca"
});

const db = getFirestore(app);

function sumE(d){
 let t=0;(d.entrate||[]).forEach(x=>t+=+x.amount||0);return t;
}
function sumS(d){
 let t=0;(d.spese||[]).forEach(x=>t+=+x.amount||0);return t;
}

const chart = new Chart(document.getElementById("chart"),{
 type:"bar",
 data:{
  labels:["Entrate","Spese","Risparmio"],
  datasets:[{data:[0,0,0]}]
 },
 options:{scales:{y:{beginAtZero:true}}}
});

onSnapshot(collection(db,"budgets"), snap=>{

 let totaleSalvadanaio = 0;
 let ultimoDoc = null;

 snap.forEach(doc=>{
   ultimoDoc = doc; // ultimo mese trovato
 });

 if(!ultimoDoc) return;

 const d = ultimoDoc.data();
 const e = sumE(d);
 const s = sumS(d);
 const r = e-s;

 chart.data.datasets[0].data=[e,s,r];
 chart.update();

 snap.forEach(doc=>{
   const d2 = doc.data();
   totaleSalvadanaio += sumE(d2)-sumS(d2);
 });

 document.getElementById("tot").innerText =
   totaleSalvadanaio.toFixed(2)+" â‚¬";

 document.getElementById("titolo").innerText =
   "ğŸ“Š Mese "+ultimoDoc.id;
});
</script>

</body>
</html>
