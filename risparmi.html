<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Risparmi Mensili</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --primary:#2196F3;
      --success:#4CAF50;
      --danger:#F44336;
      --light:#f5f5f5;
      --dark:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:0;
      color:var(--dark);
    }

    .container{
      width:100vw;
      max-width:100vw;
      height:100vh;
      background:#fff;
      box-shadow:0 20px 60px rgba(0,0,0,0.28);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    header{
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff;
      padding:22px 18px;
      text-align:center;
      position:fixed;
      top:0;left:0;right:0;
      z-index:1000;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    header.header-hidden{transform:translateY(-100%);opacity:0}

    header h1{
      font-size:1.8em;
      margin-bottom:6px;
      font-weight:900;
      letter-spacing:.2px;
    }
    header p{
      font-size:.85em;
      opacity:.95;
      font-weight:400;
    }

    .top-controls{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      font-size:.8em;
      font-weight:900;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.16);
      border:1px solid rgba(255,255,255,0.25);
    }

    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      box-shadow:0 10px 22px rgba(0,0,0,0.18);
      transition: transform .08s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform:scale(0.98)}
    .btn.light{background:#fff;color:#111827}
    .btn.danger{background:#ff6b6b;color:#fff}
    .btn.ghost{background:rgba(255,255,255,0.16);color:#fff;border:1px solid rgba(255,255,255,0.22)}

    select{
      padding:10px 14px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,0.55);
      background:rgba(255,255,255,0.95);
      color:#111827;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      outline:none;
    }

    .content{
      flex:1;
      overflow-y:auto;
      padding:20px;
      padding-top:220px;
      display:flex;
      flex-direction:column;
      gap:18px;
      background:#fff;
    }

    .section{
      background:var(--light);
      padding:18px;
      border-radius:15px;
      border-left:5px solid var(--primary);
    }

    .section h2{
      color:#111827;
      margin-bottom:14px;
      font-size:1.25em;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .summary{
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff;
      padding:18px;
      border-radius:15px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      text-align:center;
    }
    .summary-card{
      background: rgba(255,255,255,0.15);
      padding:14px;
      border-radius:12px;
      backdrop-filter: blur(10px);
    }
    .summary-label{
      font-size:.78em;
      opacity:.95;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.5px;
      font-weight:900;
    }
    .summary-value{
      font-size:1.45em;
      font-weight:1000;
    }

    .balance-positive{color:#b9ffcc}
    .balance-negative{color:#ffd1d1}

    .chart-wrap{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 22px rgba(0,0,0,0.08);
    }

    .chart-holder{
      position:relative;
      width:100%;
      height:420px;
    }

    .note{
      margin-top:10px;
      color:var(--muted);
      font-size:.9em;
      font-weight:700;
    }

    .banner{
      display:none;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      border:1px solid;
    }
    .banner.show{display:block}
    .banner.info{background:#eff6ff;border-color:#bfdbfe;color:#1e40af}
    .banner.error{background:#fff5f5;border-color:#fecaca;color:#991b1b}

    @media (max-width:860px){
      .summary{grid-template-columns:1fr}
      header h1{font-size:1.55em}
      .content{padding-top:250px}
    }
  </style>
</head>

<body>
  <div class="container">

    <header>
      <h1>üìà Risparmi Mensili</h1>
      <p>Entrate (verde) vs Spese (rosso) ‚Äî dati separati per ogni account Google</p>

      <div class="top-controls">
        <span id="status-pill" class="pill">üîÑ Inizializzo‚Ä¶</span>

        <select id="year-selector" title="Seleziona anno">
          <option value="">Anno‚Ä¶</option>
        </select>

        <button class="btn ghost" onclick="location.href='index.html'">‚Üê Torna al Budget</button>
        <button id="login-btn" class="btn light">Accedi Google</button>
        <button id="logout-btn" class="btn danger" style="display:none;">Esci</button>
      </div>
    </header>

    <div class="content">
      <div id="bannerInfo" class="banner info show">Devi fare login per vedere i tuoi dati.</div>
      <div id="bannerError" class="banner error">Errore nel caricamento dei dati.</div>

      <div class="summary">
        <div class="summary-card">
          <div class="summary-label">üì• Entrate anno</div>
          <div class="summary-value" id="kpi-income">‚Ç¨ 0,00</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">üì§ Spese anno</div>
          <div class="summary-value" id="kpi-expense">‚Ç¨ 0,00</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">üíæ Risparmio anno</div>
          <div class="summary-value balance-positive" id="kpi-savings">‚Ç¨ 0,00</div>
        </div>
      </div>

      <div class="section">
        <h2>üìä Entrate vs Spese (per mese)</h2>
        <div class="chart-wrap">
          <div class="chart-holder">
            <canvas id="incomeExpenseChart"></canvas>
          </div>
          <div class="note">
            Quando cambia mese su <strong>index.html</strong>, comparir√† automaticamente anche il nuovo mese qui (con valori 0 finch√© non inserisci dati).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + Firestore + Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
      setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdZbBv6JYbYnl6CxuFVfHhSftvIxwf2DY",
      authDomain: "budget-luca.firebaseapp.com",
      projectId: "budget-luca",
      storageBucket: "budget-luca.firebasestorage.app",
      messagingSenderId: "67496424698",
      appId: "1:67496424698:web:b1822e04ef4efc07408543",
      measurementId: "G-7LEYRZE9QN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ‚úÖ non resta loggato dopo chiusura TAB
    await setPersistence(auth, browserSessionPersistence);

    const provider = new GoogleAuthProvider();

    // UI refs
    const statusPill = document.getElementById("status-pill");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const bannerInfo = document.getElementById("bannerInfo");
    const bannerError = document.getElementById("bannerError");
    const yearSelector = document.getElementById("year-selector");

    const kpiIncome = document.getElementById("kpi-income");
    const kpiExpense = document.getElementById("kpi-expense");
    const kpiSavings = document.getElementById("kpi-savings");

    let currentUser = null;
    let unsub = null;
    let chart = null;

    // cache dati: year -> month(1..12) -> {income, expense}
    let dataByYear = {};

    function setStatus(t){ statusPill.textContent = t; }
    function showInfo(on){ bannerInfo.classList.toggle("show", !!on); }
    function showError(msg){
      bannerError.textContent = msg || "Errore nel caricamento dei dati.";
      bannerError.classList.add("show");
    }
    function hideError(){ bannerError.classList.remove("show"); }

    function euro(v){
      const n = Number(v || 0);
      return "‚Ç¨ " + n.toFixed(2).replace(".", ",");
    }
    function parseAmount(x){
      return parseFloat((x ?? "").toString().replace(",", ".")) || 0;
    }

    const MONTHS = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];

    function ensureChart(){
      const canvas = document.getElementById("incomeExpenseChart");
      if (!canvas || typeof Chart === "undefined") return null;
      if (chart) return chart;

      chart = new Chart(canvas, {
        type: "bar",
        data: {
          labels: MONTHS,
          datasets: [
            { label: "Entrate", data: Array(12).fill(0), backgroundColor: "rgba(76,175,80,0.85)", borderRadius: 10 },
            { label: "Spese", data: Array(12).fill(0), backgroundColor: "rgba(244,67,54,0.85)", borderRadius: 10 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { position: "bottom", labels: { boxWidth: 14, boxHeight: 14, padding: 14 } },
            tooltip: {
              callbacks: { label: (ctx) => ` ${ctx.dataset.label}: ${euro(ctx.parsed.y || 0)}` }
            }
          },
          scales: {
            x: { grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#111827", font: { weight: 800 } } },
            y: { grid: { color: "rgba(0,0,0,0.06)" }, ticks: { color: "#111827", font: { weight: 800 }, callback: (v)=>euro(v) } }
          }
        }
      });

      return chart;
    }

    function resetData(){
      dataByYear = {};
      yearSelector.innerHTML = `<option value="">Anno‚Ä¶</option>`;
      yearSelector.value = "";
      kpiIncome.textContent = euro(0);
      kpiExpense.textContent = euro(0);
      kpiSavings.textContent = euro(0);
      kpiSavings.classList.add("balance-positive");
      kpiSavings.classList.remove("balance-negative");

      const c = ensureChart();
      if (c){
        c.data.labels = MONTHS;
        c.data.datasets[0].data = Array(12).fill(0);
        c.data.datasets[1].data = Array(12).fill(0);
        c.update();
      }
    }

    function calcIncomeExpense(docData){
      let inc = 0, exp = 0;
      (docData.entrate || []).forEach(i => inc += parseAmount(i.amount));
      (docData.spese || []).forEach(i => exp += parseAmount(i.amount));
      return { inc, exp };
    }

    function buildYearsSelector(){
      const years = Object.keys(dataByYear).sort();
      yearSelector.innerHTML = `<option value="">Anno‚Ä¶</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");

      // default: ultimo anno disponibile, altrimenti anno corrente
      if (!yearSelector.value){
        if (years.length){
          yearSelector.value = years[years.length - 1];
        } else {
          yearSelector.value = String(new Date().getFullYear());
        }
      }
    }

    function getSelectedYear(){
      return yearSelector.value || String(new Date().getFullYear());
    }

    function updateYearView(year){
      const y = String(year);
      const months = dataByYear[y] || {};

      // vogliamo SEMPRE 12 mesi (cos√¨ ‚Äúquando passa il mese‚Äù lo vedi gi√† nel grafico)
      const incomeArr = [];
      const expenseArr = [];
      let totalInc = 0;
      let totalExp = 0;

      for (let m = 1; m <= 12; m++){
        const rec = months[m] || { income:0, expense:0 };
        incomeArr.push(rec.income || 0);
        expenseArr.push(rec.expense || 0);
        totalInc += rec.income || 0;
        totalExp += rec.expense || 0;
      }

      const savings = totalInc - totalExp;

      kpiIncome.textContent = euro(totalInc);
      kpiExpense.textContent = euro(totalExp);
      kpiSavings.textContent = euro(savings);
      kpiSavings.classList.toggle("balance-positive", savings >= 0);
      kpiSavings.classList.toggle("balance-negative", savings < 0);

      const c = ensureChart();
      if (!c) return;
      c.data.labels = MONTHS;
      c.data.datasets[0].data = incomeArr;
      c.data.datasets[1].data = expenseArr;
      c.update();
    }

    function attachUserListener(){
      if (!currentUser) return;

      // ‚úÖ dati separati per utente:
      // users/{uid}/budgets/{month}
      const colRef = collection(db, "users", currentUser.uid, "budgets");

      if (unsub) { unsub(); unsub = null; }

      setStatus("üì° Carico i tuoi dati‚Ä¶");
      hideError();

      unsub = onSnapshot(colRef, (snap) => {
        dataByYear = {};

        snap.forEach(docSnap => {
          const id = docSnap.id; // "YYYY-MM"
          const m = /^(\d{4})-(\d{2})$/.exec(id);
          if (!m) return;

          const year = m[1];
          const monthNum = parseInt(m[2], 10); // 1..12
          if (!monthNum || monthNum < 1 || monthNum > 12) return;

          const { inc, exp } = calcIncomeExpense(docSnap.data() || {});
          if (!dataByYear[year]) dataByYear[year] = {};
          dataByYear[year][monthNum] = { income: inc, expense: exp };
        });

        buildYearsSelector();
        updateYearView(getSelectedYear());

        setStatus("‚úÖ Sincronizzato");
      }, (err) => {
        console.error(err);
        setStatus("‚ùå Errore");
        showError("Errore nel caricamento dei dati. Probabile: Firestore Rules per users/{uid}/budgets.");
      });
    }

    yearSelector.addEventListener("change", () => {
      updateYearView(getSelectedYear());
    });

    loginBtn.addEventListener("click", async () => {
      try { await signInWithPopup(auth, provider); }
      catch(e){ console.error(e); showError("Login non riuscito."); }
    });

    logoutBtn.addEventListener("click", async () => {
      try{
        await signOut(auth);
        if (unsub) { unsub(); unsub = null; }
        resetData();
        setStatus("üëã Disconnesso");
        hideError();
      }catch(e){
        console.error(e);
        showError("Logout non riuscito.");
      }
    });

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;

      if (!currentUser){
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        showInfo(true);

        if (unsub) { unsub(); unsub = null; }
        resetData();

        setStatus("üîí Login richiesto");
        return;
      }

      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-flex";
      showInfo(false);

      attachUserListener();
    });

    setStatus("‚úÖ Pronto");
    ensureChart();
  </script>

  <script>
    // HEADER AUTO HIDE (come index)
    const headerEl = document.querySelector('header');
    const contentEl = document.querySelector('.content');

    function handleHeaderScroll(scrollValue) {
      if (scrollValue > 10) headerEl.classList.add('header-hidden');
      else headerEl.classList.remove('header-hidden');
    }

    if (contentEl) {
      contentEl.addEventListener('scroll', () => handleHeaderScroll(contentEl.scrollTop));
    }
    window.addEventListener('scroll', () => handleHeaderScroll(window.scrollY || window.pageYOffset));
  </script>

  <!-- FIRESTORE RULES (mettile su Firebase)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId}/budgets/{monthId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  -->
</body>
</html>
